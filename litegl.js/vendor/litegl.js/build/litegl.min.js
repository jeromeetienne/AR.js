'use strict';(function(m){function W(){return Array.prototype.slice.call(this)}function Q(g,e){if(g.constructor===e)return g;if(g.constructor!==Array)return e=e||Float32Array,new e(g);e=e||Float32Array;for(var a=g[0].length,b=new e(g.length*a),c=0;c<g.length;++c)for(var d=0;d<a;++d)b[c*a+d]=g[c][d];return b}function I(g,e,a,b){this.gl=b=b||m.gl;this._context_id=b.context_id;if(g&&g.constructor!==Array)throw"FBO textures must be an Array";this.handler=null;this.height=this.width=-1;this.color_textures=
[];this.depth_texture=null;this.stencil=!!a;this._stencil_enabled=!1;this._num_binded_textures=0;(g&&g.length||e)&&this.setTextures(g,e);this._old_fbo_handler=null;this._old_viewport=new Float32Array(4)}var k=m.GL={};m.requestAnimationFrame=m.requestAnimationFrame||m.mozRequestAnimationFrame||m.webkitRequestAnimationFrame||function(g){setTimeout(g,1E3/60)};k.blockable_keys={Up:!0,Down:!0,Left:!0,Right:!0};k.LEFT_MOUSE_BUTTON=1;k.MIDDLE_MOUSE_BUTTON=2;k.RIGHT_MOUSE_BUTTON=3;k.last_context_id=0;k.COLOR_BUFFER_BIT=
16384;k.DEPTH_BUFFER_BIT=256;k.STENCIL_BUFFER_BIT=1024;k.TEXTURE_2D=3553;k.TEXTURE_CUBE_MAP=34067;k.TEXTURE_MAG_FILTER=10240;k.TEXTURE_MIN_FILTER=10241;k.TEXTURE_WRAP_S=10242;k.TEXTURE_WRAP_T=10243;k.BYTE=5120;k.UNSIGNED_BYTE=5121;k.SHORT=5122;k.UNSIGNED_SHORT=5123;k.INT=5124;k.UNSIGNED_INT=5125;k.FLOAT=5126;k.HALF_FLOAT_OES=36193;k.DEPTH_COMPONENT16=33189;k.FLOAT_VEC2=35664;k.FLOAT_VEC3=35665;k.FLOAT_VEC4=35666;k.INT_VEC2=35667;k.INT_VEC3=35668;k.INT_VEC4=35669;k.BOOL=35670;k.BOOL_VEC2=35671;k.BOOL_VEC3=
35672;k.BOOL_VEC4=35673;k.FLOAT_MAT2=35674;k.FLOAT_MAT3=35675;k.FLOAT_MAT4=35676;k.DEPTH_COMPONENT=6402;k.ALPHA=6406;k.RGB=6407;k.RGBA=6408;k.LUMINANCE=6409;k.LUMINANCE_ALPHA=6410;k.DEPTH_STENCIL=34041;k.UNSIGNED_INT_24_8_WEBGL=34042;k.NEAREST=9728;k.LINEAR=9729;k.NEAREST_MIPMAP_NEAREST=9984;k.LINEAR_MIPMAP_NEAREST=9985;k.NEAREST_MIPMAP_LINEAR=9986;k.LINEAR_MIPMAP_LINEAR=9987;k.REPEAT=10497;k.CLAMP_TO_EDGE=33071;k.MIRRORED_REPEAT=33648;k.ZERO=0;k.ONE=1;k.SRC_COLOR=768;k.ONE_MINUS_SRC_COLOR=769;k.SRC_ALPHA=
770;k.ONE_MINUS_SRC_ALPHA=771;k.DST_ALPHA=772;k.ONE_MINUS_DST_ALPHA=773;k.DST_COLOR=774;k.ONE_MINUS_DST_COLOR=775;k.SRC_ALPHA_SATURATE=776;k.CONSTANT_COLOR=32769;k.ONE_MINUS_CONSTANT_COLOR=32770;k.CONSTANT_ALPHA=32771;k.ONE_MINUS_CONSTANT_ALPHA=32772;k.VERTEX_SHADER=35633;k.FRAGMENT_SHADER=35632;k.FRONT=1028;k.BACK=1029;k.FRONT_AND_BACK=1032;k.NEVER=512;k.LESS=513;k.EQUAL=514;k.LEQUAL=515;k.GREATER=516;k.NOTEQUAL=517;k.GEQUAL=518;k.ALWAYS=519;k.KEEP=7680;k.REPLACE=7681;k.INCR=7682;k.DECR=7683;k.INCR_WRAP=
34055;k.DECR_WRAP=34056;k.INVERT=5386;k.STREAM_DRAW=35040;k.STATIC_DRAW=35044;k.DYNAMIC_DRAW=35048;k.ARRAY_BUFFER=34962;k.ELEMENT_ARRAY_BUFFER=34963;k.POINTS=0;k.LINES=1;k.LINE_LOOP=2;k.LINE_STRIP=3;k.TRIANGLES=4;k.TRIANGLE_STRIP=5;k.TRIANGLE_FAN=6;k.CW=2304;k.CCW=2305;k.CULL_FACE=2884;k.DEPTH_TEST=2929;k.BLEND=3042;k.temp_vec3=vec3.create();k.temp2_vec3=vec3.create();k.temp_vec4=vec4.create();k.temp_quat=quat.create();k.temp_mat3=mat3.create();k.temp_mat4=mat4.create();m.DEG2RAD=0.0174532925;m.RAD2DEG=
57.295779578552306;m.EPSILON=1E-6;m.isPowerOfTwo=k.isPowerOfTwo=function(g){return 0==Math.log(g)/Math.log(2)%1};[Uint8Array,Int8Array,Uint16Array,Int16Array,Uint32Array,Int32Array,Float32Array,Float64Array].forEach(function(g){g.prototype.toJSON||Object.defineProperty(g.prototype,"toJSON",{value:W,enumerable:!1})});m.getTime="undefined"!=typeof performance?performance.now.bind(performance):Date.now.bind(Date);k.getTime=m.getTime;m.isFunction=function(g){return!!(g&&g.constructor&&g.call&&g.apply)};
m.isArray=function(g){return g&&g.constructor===Array};m.isNumber=function(g){return null!=g&&g.constructor===Number};m.getClassName=function(g){if(g){if(g.name)return g.name;if(g.toString&&(g=g.toString().match(/function\s*(\w+)/))&&2==g.length)return g[1]}};m.cloneObject=k.cloneObject=function(g,e){if(g.constructor!==Object)throw"cloneObject only can clone pure javascript objects, not classes";e=e||{};for(var a in g){var b=g[a];if(null===b)e[a]=null;else switch(b.constructor){case Int8Array:case Uint8Array:case Int16Array:case Uint16Array:case Int32Array:case Uint32Array:case Float32Array:case Float64Array:e[a]=
new b.constructor(b);break;case Boolean:case Number:case String:e[a]=b;break;case Array:e[a]=b.concat();break;case Object:e[a]=k.cloneObject(b)}}return e};m.regexMap=function(g,e,a){for(var b;null!=(b=g.exec(e));)a(b)};m.createCanvas=k.createCanvas=function(g,e){var a=document.createElement("canvas");a.width=g;a.height=e;return a};m.cloneCanvas=k.cloneCanvas=function(g){var e=document.createElement("canvas");e.width=g.width;e.height=g.height;e.getContext("2d").drawImage(g,0,0);return e};"undefined"!=
typeof Image&&(Image.prototype.getPixels=function(){var g=document.createElement("canvas");g.width=this.width;g.height=this.height;g=g.getContext("2d");g.drawImage(this,0,0);return g.getImageData(0,0,this.width,this.height).data});String.prototype.hasOwnProperty("replaceAll")||Object.defineProperty(String.prototype,"replaceAll",{value:function(g){var e=this,a;for(a in g)e=e.split(a).join(g[a]);return e},enumerable:!1});String.prototype.hasOwnProperty("hashCode")||Object.defineProperty(String.prototype,
"hashCode",{value:function(){var g=0,e,a,b;if(0==this.length)return g;e=0;for(b=this.length;e<b;++e)a=this.charCodeAt(e),g=(g<<5)-g+a,g|=0;return g},enumerable:!1});Array.prototype.hasOwnProperty("subarray")||Object.defineProperty(Array.prototype,"subarray",{value:Array.prototype.slice,enumerable:!1});m.wipeObject=function(g){for(var e in g)g.hasOwnProperty(e)&&delete g[e]};m.extendClass=k.extendClass=function(g,e){for(var a in e)g.hasOwnProperty(a)||(g[a]=e[a]);if(e.prototype){var b=Object.getOwnPropertyNames(e.prototype);
for(a=0;a<b.length;++a){var c=b[a];g.prototype.hasOwnProperty(c)||(e.prototype.__lookupGetter__(c)?g.prototype.__defineGetter__(c,e.prototype.__lookupGetter__(c)):g.prototype[c]=e.prototype[c],e.prototype.__lookupSetter__(c)&&g.prototype.__defineSetter__(c,e.prototype.__lookupSetter__(c)))}}g.hasOwnProperty("superclass")||Object.defineProperty(g,"superclass",{get:function(){return e},enumerable:!1})};m.HttpRequest=k.request=function(g,e,a,b,c){var d=!0;c&&void 0!==c.async&&(d=c.async);if(e){var f=
null,f=[],h;for(h in e)f.push(h+"="+e[h]);f=f.join("&");g=g+"?"+f}var s=new XMLHttpRequest;s.open("GET",g,d);s.onload=function(c){this.getResponseHeader("Content-Type");200!=this.status?(v.trigger(s,"fail",this.status),b&&b(this.status)):(v.trigger(s,"done",this.response),a&&a(this.response))};s.onerror=function(a){v.trigger(s,"fail",a)};if(c){for(h in c)s[h]=c[h];c.binary&&(s.responseType="arraybuffer")}s.send();return s};m.XMLHttpRequest&&(XMLHttpRequest.prototype.hasOwnProperty("done")||Object.defineProperty(XMLHttpRequest.prototype,
"done",{enumerable:!1,value:function(g){v.bind(this,"done",function(e,a){g(a)});return this}}),XMLHttpRequest.prototype.hasOwnProperty("fail")||Object.defineProperty(XMLHttpRequest.prototype,"fail",{enumerable:!1,value:function(g){v.bind(this,"fail",function(e,a){g(a)});return this}}));m.getFileExtension=function(g){var e=g.indexOf("?");-1!=e&&(g=g.substr(0,e));e=g.lastIndexOf(".");return-1==e?"":g.substr(e+1).toLowerCase()};m.loadFileAtlas=k.loadFileAtlas=function(g,e,a){var b=null;HttpRequest(g,
null,function(a){a=k.processFileAtlas(a);e&&e(a);b&&b(a)},alert,a);return{done:function(a){b=a}}};m.processFileAtlas=k.processFileAtlas=function(g,e){for(var a=g.split("\n"),b={},c=[],d="",f=0,h=a.length;f<h;f++){var s=e?a[f]:a[f].trim();s.length&&("\\"!=s[0]?c.push(s):(c.length&&(b[d]=c.join("\n")),c.length=0,d=s.substr(1)))}c.length&&(b[d]=c.join("\n"));return b};m.typedArrayToArray=function(g){var e=[];e.length=g.length;for(var a=0;a<g.length;a++)e[a]=g[a];return e};m.RGBToHex=function(g,e,a){g=
Math.min(255,255*g);e=Math.min(255,255*e);a=Math.min(255,255*a);return"#"+(16777216+(g<<16)+(e<<8)+a).toString(16).slice(1)};m.hexColorToRGBA=function(){function g(a,c,d){0>d&&(d+=1);1<d&&(d-=1);return d<1/6?a+6*(c-a)*d:0.5>d?c:d<2/3?a+(c-a)*(2/3-d)*6:a}function e(a,c,d,e){e=e||vec3.create();if(0==c)d=c=a=d;else{var h=0.5>d?d*(1+c):d+c-d*c,s=2*d-h;d=g(s,h,a+1/3);c=g(s,h,a);a=g(s,h,a-1/3)}e[0]=d;e[1]=c;e[2]=a;return e}var a={white:[1,1,1],black:[0,0,0],gray:[0.501960813999176,0.501960813999176,0.501960813999176],
red:[1,0,0],orange:[1,0.6470588445663452,0],pink:[1,0.7529411911964417,0.7960784435272217],green:[0,0.501960813999176,0],lime:[0,1,0],blue:[0,0,1],violet:[0.9333333373069763,0.5098039507865906,0.9333333373069763],magenta:[1,0,1],cyan:[0,1,1],yellow:[1,1,0],brown:[0.6470588445663452,0.16470588743686676,0.16470588743686676],silver:[0.7529411911964417,0.7529411911964417,0.7529411911964417],gold:[1,0.843137264251709,0],transparent:[0,0,0,0]};return function(b,c,d){d=void 0===d?1:d;c=c||new Float32Array(4);
c[3]=d;if("string"!=typeof b)return c;var f=a[b];if(void 0!==f)return c.set(f),c[3]=3==c.length?d:c[3]*d,c;f=b.indexOf("rgba(");if(-1!=f)return b=b.substr(5),b=b.split(","),c[0]=parseInt(b[0])/255,c[1]=parseInt(b[1])/255,c[2]=parseInt(b[2])/255,c[3]=parseFloat(b[3])*d,c;f=b.indexOf("hsla(");if(-1!=f)return b=b.substr(5),b=b.split(","),e(parseInt(b[0])/360,parseInt(b[1])/100,parseInt(b[2])/100,c),c[3]=parseFloat(b[3])*d,c;c[3]=d;f=b.indexOf("rgb(");if(-1!=f)return b=b.substr(3),b=b.split(","),c[0]=
parseInt(b[0])/255,c[1]=parseInt(b[1])/255,c[2]=parseInt(b[2])/255,c;f=b.indexOf("hsl(");if(-1!=f)return b=b.substr(5),b=b.split(","),e(parseInt(b[0])/360,parseInt(b[1])/100,parseInt(b[2])/100,c),c;b=b.replace(/^#?([a-f\d])([a-f\d])([a-f\d])$/i,function(a,b,c,d){return b+b+c+c+d+d});d=/^#?([a-f\d]{2})([a-f\d]{2})([a-f\d]{2})$/i.exec(b);if(!d)return c;c[0]=parseInt(d[1],16)/255;c[1]=parseInt(d[2],16)/255;c[2]=parseInt(d[3],16)/255;return c}}();var S=function(){function g(a){return a.charCodeAt(0)+
(a.charCodeAt(1)<<8)+(a.charCodeAt(2)<<16)+(a.charCodeAt(3)<<24)}function e(a,b,c,d){var e=new Uint16Array(4),f=new Uint16Array(c*d),g=0,h=0,l=0,s=h=g=0,k=0,n=0,p=0,q=c/4;d/=4;for(var y=0;y<d;y++)for(var r=0;r<q;r++)l=b+4*(y*q+r),e[0]=a[l],e[1]=a[l+1],g=e[0]&31,h=e[0]&2016,s=e[0]&63488,k=e[1]&31,n=e[1]&2016,p=e[1]&63488,e[2]=5*g+3*k>>3|5*h+3*n>>3&2016|5*s+3*p>>3&63488,e[3]=5*k+3*g>>3|5*n+3*h>>3&2016|5*p+3*s>>3&63488,g=a[l+2],h=4*y*c+4*r,f[h]=e[g&3],f[h+1]=e[g>>2&3],f[h+2]=e[g>>4&3],f[h+3]=e[g>>6&
3],h+=c,f[h]=e[g>>8&3],f[h+1]=e[g>>10&3],f[h+2]=e[g>>12&3],f[h+3]=e[g>>14],g=a[l+3],h+=c,f[h]=e[g&3],f[h+1]=e[g>>2&3],f[h+2]=e[g>>4&3],f[h+3]=e[g>>6&3],h+=c,f[h]=e[g>>8&3],f[h+1]=e[g>>10&3],f[h+2]=e[g>>12&3],f[h+3]=e[g>>14];return f}function a(a){for(var b=0,c=a.length,d=0;b<c;b+=4)d=a[b],a[b]=a[b+2],a[b+2]=d}function b(b,c,d,g){var H=new Int32Array(d,0,q),K,A,C,E,D,v,J,B,L;if(H[x]!=f)return console.error("Invalid magic number in DDS header"),0;if(!H[z]&l)return console.error("Unsupported format, must contain a FourCC code"),
0;K=H[G];switch(K){case k:A=8;C=c?c.COMPRESSED_RGB_S3TC_DXT1_EXT:null;break;case p:A=16;C=c?c.COMPRESSED_RGBA_S3TC_DXT3_EXT:null;break;case r:A=16;C=c?c.COMPRESSED_RGBA_S3TC_DXT5_EXT:null;break;default:A=4,K=null,C=b.RGBA}J=1;H[t]&h&&!1!==g&&(J=Math.max(1,H[y]));E=H[w];D=H[m];v=H[u]+4;if(H[M+1]&s)for(L=0;6>L;++L)for(E=H[w],D=H[m],B=0;B<J;++B)K?(g=Math.max(4,E)/4*Math.max(4,D)/4*A,c=new Uint8Array(d,v,g),b.compressedTexImage2D(b.TEXTURE_CUBE_MAP_POSITIVE_X+L,B,C,E,D,0,c)):(b.pixelStorei(b.UNPACK_FLIP_Y_WEBGL,
!1),g=E*D*A,c=new Uint8Array(d,v,g),a(c),b.texImage2D(b.TEXTURE_CUBE_MAP_POSITIVE_X+L,B,C,E,D,0,b.RGBA,b.UNSIGNED_BYTE,c)),v+=g,E*=0.5,D*=0.5;else if(c)for(b.pixelStorei(b.UNPACK_FLIP_Y_WEBGL,!0),B=0;B<J;++B)K?(g=Math.max(4,E)/4*Math.max(4,D)/4*A,c=new Uint8Array(d,v,g),b.compressedTexImage2D(b.TEXTURE_2D,B,C,E,D,0,c)):(g=E*D*A,c=new Uint8Array(d,v,g),a(c),b.texImage2D(b.TEXTURE_2D,B,C,E,D,0,C,b.UNSIGNED_BYTE,c)),v+=g,E*=0.5,D*=0.5;else if(K==k)Math.max(4,E),Math.max(4,D),c=new Uint16Array(d),d=e(c,
v/2,E,D),b.texImage2D(b.TEXTURE_2D,0,b.RGB,E,D,0,b.RGB,b.UNSIGNED_SHORT_5_6_5,d),g&&b.generateMipmap(b.TEXTURE_2D);else return console.error("No manual decoder for",String.fromCharCode(K&255,K>>8&255,K>>16&255,K>>24&255),"and no native support"),0;return J}function c(b,c){var d=new Int32Array(b,0,q),g,H,v,A,C,E,D,F,J,B,L;if(d[x]!=f)return console.error("Invalid magic number in DDS header"),0;if(!d[z]&l)return console.error("Unsupported format, must contain a FourCC code"),0;g=d[G];switch(g){case k:H=
8;v="COMPRESSED_RGB_S3TC_DXT1_EXT";break;case p:H=16;v="COMPRESSED_RGBA_S3TC_DXT3_EXT";break;case r:H=16;v="COMPRESSED_RGBA_S3TC_DXT5_EXT";break;default:H=4,v="RGBA"}J=1;d[t]&h&&!1!==loadMipmaps&&(J=Math.max(1,d[y]));A=d[w];C=d[m];D=d[u]+4;var I=[];if(d[M+1]&s)for(L=0;6>L;++L)for(A=d[w],C=d[m],B=0;B<J;++B)g?(E=Math.max(4,A)/4*Math.max(4,C)/4*H,new Uint8Array(b,D,E),I.push({tex:"TEXTURE_CUBE_MAP",face:L,mipmap:B,internalFormat:v,width:A,height:C,offset:0,dataOffset:D,dataLength:E})):(E=A*C*H,F=new Uint8Array(b,
D,E),a(F),I.push({tex:"TEXTURE_CUBE_MAP",face:L,mipmap:B,internalFormat:v,width:A,height:C,offset:0,type:"UNSIGNED_BYTE",dataOffset:D,dataLength:E})),D+=E,A*=0.5,C*=0.5;else if(c)if(g==k)Math.max(4,A),Math.max(4,C),F=new Uint16Array(b),d=e(F,D/2,A,C),I.push({tex:"TEXTURE_2D",mipmap:0,internalFormat:"RGB",width:A,height:C,offset:0,format:"RGB",type:"UNSIGNED_SHORT_5_6_5",data:d});else return console.error("No manual decoder for",String.fromCharCode(g&255,g>>8&255,g>>16&255,g>>24&255),"and no native support"),
0;else for(B=0;B<J;++B)E=Math.max(4,A)/4*Math.max(4,C)/4*H,new Uint8Array(b,D,E),I.push({tex:"TEXTURE_2D",mipmap:B,internalFormat:v,width:A,height:C,offset:0,type:"UNSIGNED_BYTE",dataOffset:D,dataLength:E}),D+=E,A*=0.5,C*=0.5;return I}function d(a,c,d,e,f,g){var h=new XMLHttpRequest;h.open("GET",d,!0);h.responseType="arraybuffer";h.onload=function(){if(200==this.status){var d=new Int32Array(this.response,0,q),h=d[M+1]&s?a.TEXTURE_CUBE_MAP:a.TEXTURE_2D;a.bindTexture(h,e);var l=b(a,c,this.response,
f);a.texParameteri(h,a.TEXTURE_MAG_FILTER,a.LINEAR);a.texParameteri(h,a.TEXTURE_MIN_FILTER,1<l?a.LINEAR_MIPMAP_LINEAR:a.LINEAR);a.bindTexture(h,null);e.texture_type=h;e.width=d[w];e.height=d[m]}g&&g(e)};h.send(null);return e}var f=542327876,h=131072,s=512,l=4,k=g("DXT1"),p=g("DXT3"),r=g("DXT5"),q=31,x=0,u=1,t=2,m=3,w=4,y=7,z=20,G=21,M=27;return{dxtToRgb565:e,uploadDDSLevels:b,loadDDSTextureEx:d,loadDDSTexture:function(a,b,c,e){var f=a.createTexture();b=a.getExtension("WEBGL_compressed_texture_s3tc");
d(a,b,c,f,!0,e);return f},loadDDSTextureFromMemoryEx:function(a,c,d,e,f){var g=new Int32Array(d,0,q),h=!!(g[M+1]&s),l=h?a.TEXTURE_CUBE_MAP:a.TEXTURE_2D;a.bindTexture(l,e.handler);c=b(a,c,d,f);a.texParameteri(l,a.TEXTURE_MAG_FILTER,a.LINEAR);a.texParameteri(l,a.TEXTURE_MIN_FILTER,1<c?a.LINEAR_MIPMAP_LINEAR:a.LINEAR);h&&(a.texParameteri(l,a.TEXTURE_WRAP_S,a.CLAMP_TO_EDGE),a.texParameteri(l,a.TEXTURE_WRAP_T,a.CLAMP_TO_EDGE));a.bindTexture(l,null);e.handler&&(e.texture_type=l,e.width=g[w],e.height=g[m]);
return e},getDDSTextureFromMemoryEx:function(a){var b=new Int32Array(a,0,q),d=b[M+1]&s?"TEXTURE_CUBE_MAP":"TEXTURE_2D",e=c(a);return{type:d,buffers:e,data:a,width:b[w],height:b[m]}}}}();"undefined"!=typeof m&&(m.DDS=S);if("undefined"==typeof glMatrix)throw"You must include glMatrix on your project";Math.clamp=function(g,e,a){return e>g?e:a<g?a:g};vec3.ZERO=vec3.fromValues(0,0,0);vec3.FRONT=vec3.fromValues(0,0,-1);vec3.UP=vec3.fromValues(0,1,0);vec3.RIGHT=vec3.fromValues(1,0,0);vec2.rotate=function(g,
e,a){var b=e[0];e=e[1];var c=Math.cos(a);a=Math.sin(a);g[0]=b*c-e*a;g[1]=b*a+e*c;return g};vec3.zero=function(g){g[0]=g[1]=0;return g};vec2.perpdot=function(g,e){return g[1]*e[0]+-g[0]*e[1]};vec2.computeSignedAngle=function(g,e){return Math.atan2(vec2.perpdot(g,e),vec2.dot(g,e))};vec2.random=function(g){g[0]=Math.random();g[1]=Math.random();return g};vec3.zero=function(g){g[0]=g[1]=g[2]=0;return g};vec3.minValue=function(g){return g[0]<g[1]&&g[0]<g[2]?g[0]:g[1]<g[2]?g[1]:g[2]};vec3.maxValue=function(g){return g[0]>
g[1]&&g[0]>g[2]?g[0]:g[1]>g[2]?g[1]:g[2]};vec3.minValue=function(g){return g[0]<g[1]&&g[0]<g[2]?g[0]:g[1]<g[2]?g[1]:g[2]};vec3.addValue=function(g,e,a){g[0]=e[0]+a;g[1]=e[1]+a;g[2]=e[2]+a};vec3.subValue=function(g,e,a){g[0]=e[0]-a;g[1]=e[1]-a;g[2]=e[2]-a};vec3.toArray=function(g){return[g[0],g[1],g[2]]};vec3.rotateX=function(g,e,a){var b=e[1],c=e[2],d=Math.cos(a);a=Math.sin(a);g[0]=e[0];g[1]=b*d-c*a;g[2]=b*a+c*d;return g};vec3.rotateY=function(g,e,a){var b=e[0],c=e[2],d=Math.cos(a);a=Math.sin(a);
g[0]=b*d-c*a;g[1]=e[1];g[2]=b*a+c*d;return g};vec3.rotateZ=function(g,e,a){var b=e[0],c=e[1],d=Math.cos(a);a=Math.sin(a);g[0]=b*d-c*a;g[1]=b*a+c*d;g[2]=e[2];return g};vec3.angle=function(g,e){return Math.acos(vec3.dot(g,e))};vec3.random=function(g){g[0]=Math.random();g[1]=Math.random();g[2]=Math.random();return g};vec3.polarToCartesian=function(g,e){var a=e[0],b=e[1],c=e[2];g[0]=a*Math.cos(b)*Math.sin(c);g[1]=a*Math.sin(b);g[2]=a*Math.cos(b)*Math.cos(c);return g};vec3.reflect=function(g,e,a){var b=
e[0],c=e[1],d=e[2];vec3.scale(g,a,-2*vec3.dot(e,a));g[0]+=b;g[1]+=c;g[2]+=d;return g};vec4.random=function(g){g[0]=Math.random();g[1]=Math.random();g[2]=Math.random();g[3]=Math.random();return g};vec4.toArray=function(g){return[g[0],g[1],g[2],g[3]]};mat3.IDENTITY=mat3.create();mat4.IDENTITY=mat4.create();mat4.toArray=function(g){return[g[0],g[1],g[2],g[3],g[4],g[5],g[6],g[7],g[8],g[9],g[10],g[11],g[12],g[13],g[14],g[15]]};mat4.setUpAndOrthonormalize=function(g,e,a){e!=g&&mat4.copy(g,e);e=g.subarray(0,
3);vec3.normalize(g.subarray(4,7),a);g=g.subarray(8,11);vec3.cross(e,a,g);vec3.normalize(e,e);vec3.cross(g,e,a);vec3.normalize(g,g)};mat4.multiplyVec3=function(g,e,a){var b=a[0],c=a[1];a=a[2];g[0]=e[0]*b+e[4]*c+e[8]*a+e[12];g[1]=e[1]*b+e[5]*c+e[9]*a+e[13];g[2]=e[2]*b+e[6]*c+e[10]*a+e[14];return g};mat4.projectVec3=function(g,e,a){var b=a[0],c=a[1];a=a[2];var d=e[1]*b+e[5]*c+e[9]*a+e[13],f=e[2]*b+e[6]*c+e[10]*a+e[14],h=e[3]*b+e[7]*c+e[11]*a+e[15];g[0]=((e[0]*b+e[4]*c+e[8]*a+e[12])/h+1)/2;g[1]=(d/h+
1)/2;g[2]=(f/h+1)/2;return g};vec3.project=function(g,e,a,b){b=b||gl.viewport_data;var c=e[0],d=e[1];e=e[2];var f=a[3]*c+a[7]*d+a[11]*e+a[15],h=1-((a[1]*c+a[5]*d+a[9]*e+a[13])/f+1)/2;g[0]=((a[0]*c+a[4]*d+a[8]*e+a[12])/f+1)/2*b[2]+b[0];g[1]=h*b[3]+b[1];g[2]=f;return g};var V=mat4.create(),F=vec4.create();vec3.unproject=function(g,e,a,b){F[0]=2*(e[0]-b[0])/b[2]-1;F[1]=2*(e[1]-b[1])/b[3]-1;F[2]=2*e[2]-1;F[3]=1;if(!mat4.invert(V,a))return null;vec4.transformMat4(F,F,V);if(0===F[3])return null;g[0]=F[0]/
F[3];g[1]=F[1]/F[3];g[2]=F[2]/F[3];return g};mat4.rotateVec3=function(g,e,a){var b=a[0],c=a[1];a=a[2];g[0]=e[0]*b+e[4]*c+e[8]*a;g[1]=e[1]*b+e[5]*c+e[9]*a;g[2]=e[2]*b+e[6]*c+e[10]*a;return g};mat4.fromTranslationFrontTop=function(g,e,a,b){vec3.cross(g.subarray(0,3),a,b);g.set(b,4);g.set(a,8);g.set(e,12);return g};mat4.translationMatrix=function(g){var e=mat4.create();e[12]=g[0];e[13]=g[1];e[14]=g[2];return e};mat4.setTranslation=function(g,e){g[12]=e[0];g[13]=e[1];g[14]=e[2];return g};mat4.getTranslation=
function(g,e){g[0]=e[12];g[1]=e[13];g[2]=e[14];return g};mat4.toRotationMat4=function(g,e){mat4.copy(g,e);g[12]=g[13]=g[14]=0;return g};mat4.swapRows=function(g,e,a,b){if(g!=e)return mat4.copy(g,e),g[4*a]=e[4*b],g[4*a+1]=e[4*b+1],g[4*a+2]=e[4*b+2],g[4*a+3]=e[4*b+3],g[4*b]=e[4*a],g[4*b+1]=e[4*a+1],g[4*b+2]=e[4*a+2],g[4*b+3]=e[4*a+3],g;e=new Float32Array(matrix.subarray(4*a,5*a));matrix.set(matrix.subarray(4*b,5*b),4*a);matrix.set(e,4*b);return g};mat4.scaleAndAdd=function(g,e,a,b){g[0]=e[0]+a[0]*b;
g[1]=e[1]+a[1]*b;g[2]=e[2]+a[2]*b;g[3]=e[3]+a[3]*b;g[4]=e[4]+a[4]*b;g[5]=e[5]+a[5]*b;g[6]=e[6]+a[6]*b;g[7]=e[7]+a[7]*b;g[8]=e[8]+a[8]*b;g[9]=e[9]+a[9]*b;g[10]=e[10]+a[10]*b;g[11]=e[11]+a[11]*b;g[12]=e[12]+a[12]*b;g[13]=e[13]+a[13]*b;g[14]=e[14]+a[14]*b;g[15]=e[15]+a[15]*b;return g};quat.fromAxisAngle=function(g,e){var a=quat.create();e*=0.5;var b=Math.sin(e);a[0]=b*g[0];a[1]=b*g[1];a[2]=b*g[2];a[3]=Math.cos(e);return a};quat.toEuler=function(g,e){var a=Math.atan2(2*e[1]*e[3]-2*e[0]*e[2],1-2*e[1]*
e[1]-2*e[2]*e[2]),b=Math.asin(2*e[0]*e[1]+2*e[2]*e[3]),c=Math.atan2(2*e[0]*e[3]-2*e[1]*e[2],1-2*e[0]*e[0]-2*e[2]*e[2]);g||(g=vec3.create());vec3.set(g,a,b,c);return g};quat.fromEuler=function(g,e){var a=e[0],b=e[1],c=e[2],d=Math.cos(a),f=Math.cos(b),h=Math.cos(c),a=Math.sin(a),b=Math.sin(b),c=Math.sin(c),s=0.5*Math.sqrt(1+d*f+d*h-a*b*c+f*h);0==s&&(s=1E-6);quat.set(g,(f*c+d*c+a*b*h)/(4*s),(a*f+a*h+d*b*c)/(4*s),(-a*c+d*b*h+b)/(4*s),s);quat.normalize(g,g);return g};quat.fromMat4=function(g,e){var a=
e[0]+e[5]+e[10];if(0<a){var b=Math.sqrt(a+1);g[3]=0.5*b;b=0.5/b;g[0]=(e[9]-e[6])*b;g[1]=(e[2]-e[8])*b;g[2]=(e[4]-e[1])*b}else{a=0;e[5]>e[0]&&(a=1);e[10]>e[4*a+a]&&(a=2);var c=(a+1)%3,d=(c+1)%3,b=Math.sqrt(e[4*a+a]-e[4*c+c]-e[4*d+d]+1);g[a]=0.5*b;b=0.5/b;g[3]=(e[4*d+c]-e[4*c+d])*b;g[c]=(e[4*c+a]+e[4*a+c])*b;g[d]=(e[4*d+a]+e[4*a+d])*b}quat.normalize(g,g)};quat.fromMat4.lookAt=function(){var g=vec3.create();return function(e,a,b){b=vec3.dot(vec3.FRONT,a);if(1E-6>Math.abs(b- -1))return e.set(vec3.UP),
e[3]=Math.PI,e;if(1E-6>Math.abs(b-1))return quat.identity(e);b=Math.acos(b);vec3.cross(g,vec3.FRONT,a);vec3.normalize(g,g);quat.setAxisAngle(e,g,b);return e}}();k.Indexer=function(){this.unique=[];this.indices=[];this.map={}};k.Indexer.prototype={add:function(g){var e=JSON.stringify(g);e in this.map||(this.map[e]=this.unique.length,this.unique.push(g));return this.map[e]}};k.Buffer=function(g,e,a,b,c){k.debug&&console.log("GL.Buffer created");null!==c&&(c=c||m.gl);this.buffer=null;this.target=g;this.gl=
c;this.attribute=null;this.data=e;this.spacing=a||3;this.data&&this.gl&&this.upload(b)};k.Buffer.prototype.forEach=function(g){for(var e=this.data,a=0,b=this.spacing,c=e.length;a<c;a+=b)g(e.subarray(a,a+b),a);return this};k.Buffer.prototype.applyTransform=function(g){for(var e=this.data,a=0,b=this.spacing,c=e.length;a<c;a+=b){var d=e.subarray(a,a+b);vec3.transformMat4(d,d,g)}return this};k.Buffer.prototype.upload=function(g){var e=this.spacing||3,a=this.gl;if(a){if(!this.data)throw"No data supplied";
var b=this.data;if(!b.buffer)throw"Buffers must be typed arrays";if(this.buffer=this.buffer||a.createBuffer()){this.buffer.length=b.length;this.buffer.spacing=e;switch(b.constructor){case Int8Array:this.buffer.gl_type=a.BYTE;break;case Uint8ClampedArray:case Uint8Array:this.buffer.gl_type=a.UNSIGNED_BYTE;break;case Int16Array:this.buffer.gl_type=a.SHORT;break;case Uint16Array:this.buffer.gl_type=a.UNSIGNED_SHORT;break;case Int32Array:this.buffer.gl_type=a.INT;break;case Uint32Array:this.buffer.gl_type=
a.UNSIGNED_INT;break;case Float32Array:this.buffer.gl_type=a.FLOAT;break;default:throw"unsupported buffer type";}a.bindBuffer(this.target,this.buffer);a.bufferData(this.target,b,g||this.stream_type||a.STATIC_DRAW)}}};k.Buffer.prototype.compile=k.Buffer.prototype.upload;k.Buffer.prototype.setData=function(g,e){if(!g.buffer)throw"Data must be typed array";e=e||0;if(this.data){if(this.data.length<g.length)throw"buffer is not big enough, you cannot set data to a smaller buffer";if(this.data!=g)if(this.data.length==
g.length)this.data.set(g),this.upload();else{var a=new Uint8Array(g.buffer,g.buffer.byteOffset,g.buffer.byteLength);(new Uint8Array(this.data.buffer)).set(a,e);this.uploadRange(e,a.length)}}else this.data=g,this.upload()};k.Buffer.prototype.uploadRange=function(g,e){if(!this.data)throw"No data stored in this buffer";if(!this.data.buffer)throw"Buffers must be typed arrays";var a=new Uint8Array(this.data.buffer,g,e),b=this.gl;b.bindBuffer(this.target,this.buffer);b.bufferSubData(this.target,g,a)};k.Buffer.prototype.clone=
function(g){var e=new k.Buffer;if(g)for(var a in this)e[a]=this[a];else this.target&&(e.target=this.target),this.gl&&(e.gl=this.gl),this.spacing&&(e.spacing=this.spacing),this.data&&(e.data=new m[this.data.constructor](this.data),e.upload());return e};k.Buffer.prototype.toJSON=function(){return this.data?{data_type:getClassName(this.data),data:this.data.toJSON(),target:this.target,attribute:this.attribute,spacing:this.spacing}:(console.error("cannot serialize a mesh without data"),null)};k.Buffer.prototype.fromJSON=
function(g){this.data=new (m[g.data_type]||Float32Array)(g.data);this.target=g.target;this.spacing=g.spacing||3;this.attribute=g.attribute;this.upload(k.STATIC_DRAW)};k.Buffer.prototype.delete=function(){this.gl.deleteBuffer(this.buffer);this.buffer=null};m.Mesh=k.Mesh=function(g,e,a,b){k.debug&&console.log("GL.Mesh created");null!==b&&(this.gl=b=b||m.gl);this._context_id=b.context_id;this.vertexBuffers={};this.indexBuffers={};this.bounding=this.info=null;(g||e)&&this.addBuffers(g,e,a?a.stream_type:
null);if(a)for(var c in a)this[c]=a[c]};Mesh.common_buffers={vertices:{spacing:3,attribute:"a_vertex"},vertices2D:{spacing:2,attribute:"a_vertex2D"},normals:{spacing:3,attribute:"a_normal"},coords:{spacing:2,attribute:"a_coord"},coords1:{spacing:2,attribute:"a_coord1"},coords2:{spacing:2,attribute:"a_coord2"},colors:{spacing:4,attribute:"a_color"},tangents:{spacing:3,attribute:"a_tangent"},bone_indices:{spacing:4,attribute:"a_bone_indices",type:Uint8Array},weights:{spacing:4,attribute:"a_weights"},
extra:{spacing:1,attribute:"a_extra"},extra2:{spacing:2,attribute:"a_extra2"},extra3:{spacing:3,attribute:"a_extra3"},extra4:{spacing:4,attribute:"a_extra4"}};Mesh.default_datatype=Float32Array;Mesh.prototype.addBuffer=function(g,e){e.target==gl.ARRAY_BUFFER?this.vertexBuffers[g]=e:this.indexBuffers[g]=e;e.attribute||(e.attribute=k.Mesh.common_buffers[g].attribute)};Mesh.prototype.addBuffers=function(g,e,a){var b=0;this.vertexBuffers.vertices&&(b=this.vertexBuffers.vertices.data.length/3);for(var c in g){var d=
g[c];if(d){if(d.constructor==k.Buffer)d=d.data;else if("number"!=typeof d[0]){for(var f=[],h=0,s=1E4;h<d.length;h+=s)f=Array.prototype.concat.apply(f,d.slice(h,h+s));d=f}f=k.Mesh.common_buffers[c];d.constructor===Array&&(h=k.Mesh.default_datatype,f&&f.type&&(h=f.type),d=new h(d));"vertices"==c&&(b=d.length/3);h=d.length/b;f&&f.spacing&&(h=f.spacing);s="a_"+c;f&&f.attribute&&(s=f.attribute);this.createVertexBuffer(c,s,h,d,a)}}if(e)for(c in e)if(d=e[c]){d.constructor==k.Buffer&&(d=d.data);if("number"!=
typeof d[0]){f=[];c=0;for(s=1E4;c<d.length;c+=s)f=Array.prototype.concat.apply(f,d.slice(c,c+s));d=f}d.constructor===Array&&(h=Uint16Array,65536<b&&(h=Uint32Array),d=new h(d));this.createIndexBuffer(c,d)}};Mesh.prototype.createVertexBuffer=function(g,e,a,b,c){var d=k.Mesh.common_buffers[g];!e&&d&&(e=d.attribute);if(!e)throw"Buffer added to mesh without attribute name";!a&&d&&(a=d&&d.spacing?d.spacing:3);if(!b){b=this.getNumVertices();if(!b)throw"Cannot create an empty buffer in a mesh without vertices (vertices are needed to know the size)";
b=new k.Mesh.default_datatype(b*a)}if(!b.buffer)throw"Buffer data MUST be typed array";a=this.vertexBuffers[g]=new k.Buffer(gl.ARRAY_BUFFER,b,a,c,this.gl);a.name=g;a.attribute=e;return a};Mesh.prototype.removeVertexBuffer=function(g,e){var a=this.vertexBuffers[g];a&&(e&&a.delete(),delete this.vertexBuffers[g])};Mesh.prototype.getVertexBuffer=function(g){return this.vertexBuffers[g]};Mesh.prototype.createIndexBuffer=function(g,e,a){if(e.constructor===Array){var b=Uint16Array,c=this.vertexBuffers.vertices;
c&&(65536<c.data.length/3&&(b=Uint32Array),e=new b(e))}return this.indexBuffers[g]=new k.Buffer(gl.ELEMENT_ARRAY_BUFFER,e,0,a,this.gl)};Mesh.prototype.getBuffer=function(g){return this.vertexBuffers[g]};Mesh.prototype.getIndexBuffer=function(g){return this.indexBuffers[g]};Mesh.prototype.removeIndexBuffer=function(g,e){var a=this.indexBuffers[g];a&&(e&&a.delete(),delete this.indexBuffers[g])};Mesh.prototype.upload=function(g){for(var e in this.vertexBuffers){var a=this.vertexBuffers[e];a.upload(g)}for(var b in this.indexBuffers)a=
this.indexBuffers[b],a.upload()};Mesh.prototype.compile=Mesh.prototype.upload;Mesh.prototype.deleteBuffers=function(){for(var g in this.vertexBuffers){var e=this.vertexBuffers[g];e.delete()}this.vertexBuffers={};for(g in this.indexBuffers)e=this.indexBuffers[g],e.delete();this.indexBuffers={}};Mesh.prototype.delete=Mesh.prototype.deleteBuffers;Mesh.prototype.bindBuffers=function(g){for(var e in this.vertexBuffers){var a=this.vertexBuffers[e],b=g.attributes[a.attribute||e];null!=b&&a.buffer&&(gl.bindBuffer(gl.ARRAY_BUFFER,
a.buffer),gl.enableVertexAttribArray(b),gl.vertexAttribPointer(b,a.buffer.spacing,a.buffer.gl_type,!1,0,0))}};Mesh.prototype.unbindBuffers=function(g){for(var e in this.vertexBuffers){var a=this.vertexBuffers[e],b=a.attribute||e;null!=g.attributes[b]&&a.buffer&&gl.disableVertexAttribArray(g.attributes[b])}};Mesh.prototype.clone=function(g){g=g||m.gl;var e={},a={},b;for(b in this.vertexBuffers){var c=this.vertexBuffers[b];e[b]=new c.data.constructor(c.data)}for(b in this.indexBuffers)c=this.indexBuffers[b],
a[b]=new c.data.constructor(c.data);return new k.Mesh(e,a,void 0,g)};Mesh.prototype.cloneShared=function(g){g=g||m.gl;return new k.Mesh(this.vertexBuffers,this.indexBuffers,void 0,g)};Mesh.prototype.toObject=function(){var g={},e={},a;for(a in this.vertexBuffers){var b=this.vertexBuffers[a];g[a]={spacing:b.spacing,data:new b.data.constructor(b.data)}}for(a in this.indexBuffers)b=this.indexBuffers[a],e[a]={data:new b.data.constructor(b.data)};return{vertexBuffers:g,indexBuffers:e,info:this.info?cloneObject(this.info):
null,bounding:this.bounding?this.bounding.toJSON():null}};Mesh.prototype.toJSON=function(){var g={vertexBuffers:{},indexBuffers:{},info:this.info?cloneObject(this.info):null,bounding:this.bounding?this.bounding.toJSON():null},e;for(e in this.vertexBuffers)g.vertexBuffers[e]=this.vertexBuffers[e].toJSON();for(e in this.indexBuffers)g.indexBuffers[e]=this.indexBuffers[e].toJSON();return g};Mesh.prototype.fromJSON=function(g){this.vertexBuffers={};this.indexBuffers={};for(var e in g.vertexBuffers)if(g.vertexBuffers[e]){var a=
new k.Buffer;a.fromJSON(g.vertexBuffers[e]);!a.attribute&&k.Mesh.common_buffers[e]&&(a.attribute=k.Mesh.common_buffers[e].attribute);this.vertexBuffers[e]=a}for(e in g.indexBuffers)g.indexBuffers[e]&&(a=new k.Buffer,a.fromJSON(g.indexBuffers[e]),this.indexBuffers[e]=a);g.info&&(this.info=cloneObject(g.info));g.bounding&&(this.bounding=new Float32Array(g.bounding))};Mesh.prototype.generateMetadata=function(){var g={},e=this.vertexBuffers.vertices.data,a=this.indexBuffers.triangles.data;g.vertices=
e.length/3;g.faces=a?a.length/3:e.length/9;g.indexed=!!this.metadata.faces;this.metadata=g};Mesh.prototype.computeWireframe=function(){var g=this.indexBuffers.triangles,e=this.vertexBuffers.vertices.data.length/3;if(g){for(var a=g.data,b=new k.Indexer,g=0;g<a.length;g+=3)for(var c=a.subarray(g,g+3),d=0;d<c.length;d++){var f=c[d],h=c[(d+1)%c.length];b.add([Math.min(f,h),Math.max(f,h)])}a=b.unique;b=65536<e?new Uint32Array(2*a.length):new Uint16Array(2*a.length);g=0;for(e=a.length;g<e;++g)b.set(a[g],
2*g)}else for(g=e/3,b=65536<e?new Uint32Array(6*g):new Uint16Array(6*g),g=0;g<e;g+=3)b[2*g]=g,b[2*g+1]=g+1,b[2*g+2]=g+1,b[2*g+3]=g+2,b[2*g+4]=g+2,b[2*g+5]=g;this.createIndexBuffer("wireframe",b);return this};Mesh.prototype.flipNormals=function(g){var e=this.vertexBuffers.normals;if(e){for(var a=e.data,b=a.length,c=0;c<b;++c)a[c]*=-1;e.upload(g);this.indexBuffers.triangles||this.computeIndices();e=this.indexBuffers.triangles;a=e.data;b=a.length;for(c=0;c<b;c+=3){var d=a[c];a[c]=a[c+1];a[c+1]=d}e.upload(g)}};
Mesh.prototype.computeIndices=function(){var g=[],e=[],a=[],b=[],c=this.vertexBuffers.normals,d=this.vertexBuffers.coords,f=this.vertexBuffers.vertices.data,h=null;c&&(h=c.data);c=null;d&&(c=d.data);for(var d={},s=f.length/3,l=0;l<s;++l){var n=f.subarray(3*l,3*(l+1)),p=1E3*n[0]|0,r=0,q=d[p];if(q)for(var x=q.length;r<x;r++)if(0.01>vec3.sqrDist(n,g[q[r]])){b.push(r);break}q&&r!=x||(g.push(n),d[p]?d[p].push(r):d[p]=[r],h&&e.push(h.subarray(3*l,3*(l+1))),c&&a.push(c.subarray(2*l,2*(l+1))),b.push(r))}this.vertexBuffers=
{};this.createVertexBuffer("vertices",k.Mesh.common_buffers.vertices.attribute,3,Q(g));h&&this.createVertexBuffer("normals",k.Mesh.common_buffers.normals.attribute,3,Q(e));c&&this.createVertexBuffer("coords",k.Mesh.common_buffers.coords.attribute,2,Q(a));this.createIndexBuffer("triangles",b)};Mesh.prototype.explodeIndices=function(g){g=g||"triangles";var e=this.getIndexBuffer(g);if(e){var e=e.data,a=new Float32Array(3*e.length),b=null,c=null,d=this.vertexBuffers.vertices.data,f=this.vertexBuffers.normals,
h=null;f&&(h=f.data,b=new Float32Array(3*e.length));var s=this.vertexBuffers.coords,f=null;s&&(f=s.data,c=new Float32Array(2*e.length));for(var s=0,l=e.length;s<l;++s){var n=e[s];a.set(d.subarray(3*n,3*n+3),3*s);h&&b.set(h.subarray(3*n,3*n+3),3*s);f&&c.set(f.subarray(2*n,2*n+2),2*s)}this.vertexBuffers={};this.createVertexBuffer("vertices",k.Mesh.common_buffers.vertices.attribute,3,a);b&&this.createVertexBuffer("normals",k.Mesh.common_buffers.normals.attribute,3,b);c&&this.createVertexBuffer("coords",
k.Mesh.common_buffers.coords.attribute,2,c);delete this.indexBuffers[g]}};Mesh.prototype.computeNormals=function(g){if(!this.vertexBuffers.vertices)return console.error("Cannot compute normals of a mesh without vertices");var e=this.vertexBuffers.vertices.data,a=new Float32Array(e.length),b=null;this.indexBuffers.triangles&&(b=this.indexBuffers.triangles.data);for(var c=k.temp_vec3,d=k.temp2_vec3,f,h,s,l,n,p,r=b?b.length:e.length,q=0;q<r;q+=3)b?(f=b[q],h=b[q+1],s=b[q+2],l=e.subarray(3*f,3*f+3),n=
e.subarray(3*h,3*h+3),p=e.subarray(3*s,3*s+3),f=a.subarray(3*f,3*f+3),h=a.subarray(3*h,3*h+3),s=a.subarray(3*s,3*s+3)):(l=e.subarray(3*q,3*q+3),n=e.subarray(3*q+3,3*q+6),p=e.subarray(3*q+6,3*q+9),f=a.subarray(3*q,3*q+3),h=a.subarray(3*q+3,3*q+6),s=a.subarray(3*q+6,3*q+9)),vec3.sub(c,n,l),vec3.sub(d,p,l),vec3.cross(c,c,d),vec3.normalize(c,c),vec3.add(f,f,c),vec3.add(h,h,c),vec3.add(s,s,c);if(b)for(q=0,r=a.length;q<r;q+=3)e=a.subarray(q,q+3),vec3.normalize(e,e);if(r=this.vertexBuffers.normals)r.data=
a,r.upload(g);else return this.createVertexBuffer("normals",k.Mesh.common_buffers.normals.attribute,3,a);return r};Mesh.prototype.computeTangents=function(){var g=this.vertexBuffers.vertices;if(!g)return console.error("Cannot compute tangents of a mesh without vertices");var e=this.vertexBuffers.normals;if(!e)return console.error("Cannot compute tangents of a mesh without normals");var a=this.vertexBuffers.coords;if(!a)return console.error("Cannot compute tangents of a mesh without uvs");var b=this.indexBuffers.triangles;
if(!b)return console.error("Cannot compute tangents of a mesh without indices");var g=g.data,e=e.data,c=a.data,d=b.data;if(g&&e&&c){var f=g.length/3,b=new Float32Array(4*f),a=new Float32Array(6*f),f=a.subarray(3*f),h,s,l=vec3.create(),k=vec3.create(),p=vec3.create(),r=vec3.create();h=0;for(s=d.length;h<s;h+=3){var q=d[h],x=d[h+1],u=d[h+2],t=g.subarray(3*q,3*q+3),m=g.subarray(3*x,3*x+3),w=g.subarray(3*u,3*u+3),y=c.subarray(2*q,2*q+2),z=c.subarray(2*x,2*x+2),G=c.subarray(2*u,2*u+2),M=m[0]-t[0],U=w[0]-
t[0],N=m[1]-t[1],O=w[1]-t[1],m=m[2]-t[2],t=w[2]-t[2],w=z[0]-y[0],v=G[0]-y[0],z=z[1]-y[1],y=G[1]-y[1],G=w*y-v*z,G=1E-9>Math.abs(G)?0:1/G;vec3.copy(l,[(y*M-z*U)*G,(y*N-z*O)*G,(y*m-z*t)*G]);vec3.copy(k,[(w*U-v*M)*G,(w*O-v*N)*G,(w*t-v*m)*G]);vec3.add(a.subarray(3*q,3*q+3),a.subarray(3*q,3*q+3),l);vec3.add(a.subarray(3*x,3*x+3),a.subarray(3*x,3*x+3),l);vec3.add(a.subarray(3*u,3*u+3),a.subarray(3*u,3*u+3),l);vec3.add(f.subarray(3*q,3*q+3),f.subarray(3*q,3*q+3),k);vec3.add(f.subarray(3*x,3*x+3),f.subarray(3*
x,3*x+3),k);vec3.add(f.subarray(3*u,3*u+3),f.subarray(3*u,3*u+3),k)}h=0;for(s=g.length;h<s;h+=3)g=e.subarray(h,h+3),c=a.subarray(h,h+3),vec3.subtract(p,c,vec3.scale(p,g,vec3.dot(g,c))),vec3.normalize(p,p),g=0>vec3.dot(vec3.cross(r,g,c),f.subarray(h,h+3))?-1:1,b.set([p[0],p[1],p[2],g],h/3*4);this.createVertexBuffer("tangents",Mesh.common_buffers.tangents.attribute,4,b)}};Mesh.prototype.computeTextureCoordinates=function(g){var e=this.vertexBuffers.vertices;if(!e)return console.error("Cannot compute uvs of a mesh without vertices");
this.explodeIndices("triangles");var e=e.data,a=this.vertexBuffers.coords,b=new Float32Array(e.length/3*2),c=this.indexBuffers.triangles,d=null;c&&(d=c.data);var c=vec3.create(),f=vec3.create(),h=vec3.create(),s=this.getBoundingBox(),l=BBox.getCenter(s),k=vec3.create();k.set(BBox.getHalfsize(s));vec3.scale(k,k,2);for(var s=d?d.length:e.length/3,p=0;p<s;p+=3){if(d)var r=d[p],q=d[p+1],x=d[p+2],u=e.subarray(3*r,3*r+3),t=e.subarray(3*q,3*q+3),m=e.subarray(3*x,3*x+3),r=b.subarray(2*r,2*r+2),q=b.subarray(2*
q,2*q+2),x=b.subarray(2*x,2*x+2);else u=e.subarray(3*p,3*p+3),t=e.subarray(3*(p+1),3*(p+1)+3),m=e.subarray(3*(p+2),3*(p+2)+3),r=b.subarray(2*p,2*p+2),q=b.subarray(2*(p+1),2*(p+1)+2),x=b.subarray(2*(p+2),2*(p+2)+2);vec3.sub(f,u,t);vec3.sub(h,u,m);vec3.cross(c,f,h);c[0]=Math.abs(c[0]);c[1]=Math.abs(c[1]);c[2]=Math.abs(c[2]);c[0]>c[1]&&c[0]>c[2]?(r[0]=(u[2]-l[2])/k[2],r[1]=(u[1]-l[1])/k[1],q[0]=(t[2]-l[2])/k[2],q[1]=(t[1]-l[1])/k[1],x[0]=(m[2]-l[2])/k[2],x[1]=(m[1]-l[1])/k[1]):c[1]>c[2]?(r[0]=(u[0]-
l[0])/k[0],r[1]=(u[2]-l[2])/k[2],q[0]=(t[0]-l[0])/k[0],q[1]=(t[2]-l[2])/k[2],x[0]=(m[0]-l[0])/k[0],x[1]=(m[2]-l[2])/k[2]):(r[0]=(u[0]-l[0])/k[0],r[1]=(u[1]-l[1])/k[1],q[0]=(t[0]-l[0])/k[0],q[1]=(t[1]-l[1])/k[1],x[0]=(m[0]-l[0])/k[0],x[1]=(m[1]-l[1])/k[1])}a?(a.data=b,a.upload(g)):this.createVertexBuffer("coords",Mesh.common_buffers.coords.attribute,2,b)};Mesh.prototype.getNumVertices=function(){var g=this.vertexBuffers.vertices;return g?g.data.length/g.spacing:0};Mesh.computeBounding=function(g,e){if(g){for(var a=
vec3.clone(g.subarray(0,3)),b=vec3.clone(g.subarray(0,3)),c,d=3;d<g.length;d+=3)c=g.subarray(d,d+3),vec3.min(a,c,a),vec3.max(b,c,b);if(isNaN(a[0])||isNaN(a[1])||isNaN(a[2])||isNaN(b[0])||isNaN(b[1])||isNaN(b[2]))a[0]=a[1]=a[2]=0,b[0]=b[1]=b[2]=0,console.warn("Warning: GL.Mesh has NaN values in vertices");a=vec3.add(vec3.create(),a,b);vec3.scale(a,a,0.5);b=vec3.subtract(vec3.create(),b,a);return BBox.setCenterHalfsize(e||BBox.create(),a,b)}};Mesh.prototype.getBoundingBox=function(){this.bounding||
this.updateBounding();return this.bounding};Mesh.prototype.updateBounding=function(){var g=this.vertexBuffers.vertices;g&&(this.bounding=k.Mesh.computeBounding(g.data,this.bounding))};Mesh.prototype.setBounding=function(g,e){this.bounding=BBox.setCenterHalfsize(this.bounding||BBox.create(),g,e)};Mesh.prototype.freeData=function(){for(var g in this.vertexBuffers)this.vertexBuffers[g].data=null,delete this[this.vertexBuffers[g].name];for(var e in this.indexBuffers)this.indexBuffers[e].data=null,delete this[this.indexBuffers[e].name]};
Mesh.prototype.configure=function(g,e){var a={},b={};e=e||{};for(var c in g)if(g[c])if("vertexBuffers"==c)for(b in g[c])a[b]=g[c][b];else if("indexBuffers"==c)for(b in g[c])b[b]=g[c][b];else"indices"==c||"lines"==c||"wireframe"==c||"triangles"==c?b[c]=g[c]:k.Mesh.common_buffers[c]?a[c]=g[c]:e[c]=g[c];this.addBuffers(a,b,e.stream_type);for(b in e)this[b]=e[b];this.bounding||this.updateBounding()};Mesh.prototype.totalMemory=function(){var g=0,e;for(e in this.vertexBuffers)g+=this.vertexBuffers[e].data.buffer.byteLength;
for(e in this.indexBuffers)g+=this.indexBuffers[e].data.buffer.byteLength;return g};Mesh.prototype.simplify=function(){var g=this.getBoundingBox(),e=BBox.getMin(g),g=BBox.getHalfsize(g),g=vec3.scale(vec3.create(),g,2),a=new k.Mesh,b=vec3.create(),c;for(c in this.vertexBuffers){var d=this.vertexBuffers[c].data,f=new Float32Array(d.length);if("vertices"==c)for(var h=0,s=d.length;h<s;h+=3){var l=d.subarray(h,h+3);vec3.sub(b,l,e);vec3.div(b,b,g);b[0]=Math.round(256*b[0])/256;b[1]=Math.round(256*b[1])/
256;b[2]=Math.round(256*b[2])/256;vec3.mul(b,b,g);vec3.add(b,b,e);f.set(b,h)}a.addBuffer()}};Mesh.load=function(g,e,a,b){e=e||{};e.no_gl&&(b=null);a=a||new k.Mesh(null,null,null,b);a.configure(g,e);return a};Mesh.mergeMeshes=function(g,e){function a(a,b,c,d){for(c=b+c;b<c;b+=3){var e=a.subarray(b,b+3);vec3.transformMat4(e,e,d)}}function b(a,b,c,d){for(c=b+c;b<c;b+=2){var e=a.subarray(b,b+2);vec2.transformMat3(e,e,d)}}function c(a,b,c,d){for(c=b+c;b<c;++b)a[b]+=d}e=e||{};for(var d={},f={},h={},s=[],
l=0,n=[],p=0;p<g.length;++p){var r=g[p],q=r.mesh,x=l;s.push(x);var m=q.vertexBuffers.vertices.data.length/3,l=l+m,t;for(t in q.vertexBuffers)d[t]=d[t]?d[t]+q.vertexBuffers[t].data.length:q.vertexBuffers[t].data.length;for(t in q.indexBuffers)f[t]=f[t]?f[t]+q.indexBuffers[t].data.length:q.indexBuffers[t].data.length;n.push({name:"mesh_"+p,start:x,length:m,material:""})}for(t in d)p=e[t],null===p?delete d[t]:(p||(p=Float32Array),d[t]=new p(d[t]),h[t]=0);for(t in f)f[t]=new Uint32Array(f[t]),h[t]=0;
for(p=0;p<g.length;++p){r=g[p];q=r.mesh;m=x=0;for(t in q.vertexBuffers)d[t]&&("vertices"==t&&(m=q.vertexBuffers[t].data.length/3),d[t].set(q.vertexBuffers[t].data,h[t]),r[t+"_matrix"]&&(l=r[t+"_matrix"],16==l.length?a(d[t],h[t],q.vertexBuffers[t].data.length,l):9==l.length&&b(d[t],h[t],q.vertexBuffers[t].data.length,l)),h[t]+=q.vertexBuffers[t].data.length);for(t in q.indexBuffers)f[t].set(q.indexBuffers[t].data,h[t]),c(f[t],h[t],q.indexBuffers[t].data.length,s[p]),h[t]+=q.indexBuffers[t].data.length}h=
{info:{groups:n}};return"undefined"!=typeof gl||e.only_data?new k.Mesh(d,f,h):{vertexBuffers:d,indexBuffers:f,info:{groups:n}}};Mesh.parsers={};Mesh.encoders={};Mesh.fromURL=function(g,e,a,b){b=b||{};a=a||m.gl;var c=new k.Mesh(void 0,void 0,void 0,a);c.ready=!1;HttpRequest(g,null,function(a){var b=g.lastIndexOf("."),b=g.substr(b+1);c.parse(a,b);delete c.ready;e&&e.call(c,c,g)},function(a){e&&e(null)},b);return c};Mesh.prototype.parse=function(g,e){e=e.toLowerCase();var a=k.Mesh.parsers[e];if(a)return a.call(null,
g,{mesh:this});throw"GL.Mesh.parse: no parser found for format "+e;};Mesh.prototype.encode=function(g,e){g=g.toLowerCase();var a=k.Mesh.encoders[g];if(a)return a.call(null,this,e);throw"GL.Mesh.encode: no encoder found for format "+g;};Mesh.getScreenQuad=function(g){g=g||m.gl;var e=g.meshes[":screen_quad"];if(e)return e;var e=new Float32Array([0,0,0,1,1,0,0,1,0,0,0,0,1,0,0,1,1,0]),a=new Float32Array([0,0,1,1,0,1,0,0,1,0,1,1]),e=new k.Mesh({vertices:e,coords:a},void 0,void 0,g);return g.meshes[":screen_quad"]=
e};Mesh.plane=function(g,e){g=g||{};g.triangles=[];var a=g.detailX||g.detail||1,b=g.detailY||g.detail||1,c=g.width||g.size||1,d=g.height||g.size||1,f=g.xz,c=0.5*c,d=0.5*d,h=[],s=[],l=[],n=[],p=vec3.fromValues(0,0,1);f&&p.set([0,1,0]);for(var r=0;r<=b;r++)for(var q=r/b,x=0;x<=a;x++){var m=x/a;f?s.push((2*m-1)*c,0,-(2*q-1)*d):s.push((2*m-1)*c,(2*q-1)*d,0);l.push(m,q);n.push(p[0],p[1],p[2]);x<a&&r<b&&(m=x+r*(a+1),f?(h.push(m+1,m+a+1,m),h.push(m+1,m+a+2,m+a+1)):(h.push(m,m+1,m+a+1),h.push(m+a+1,m+1,m+
a+2)))}a=BBox.fromCenterHalfsize([0,0,0],f?[c,0,d]:[c,d,0]);return k.Mesh.load({vertices:s,normals:n,coords:l,triangles:h},{bounding:a},e)};Mesh.plane2D=function(g,e){var a=new Float32Array([-1,1,1,-1,1,1,-1,1,-1,-1,1,-1]),b=new Float32Array([0,1,1,0,1,1,0,1,0,0,1,0]);if(g&&g.size)for(var c=0.5*g.size,d=0;d<a.length;++d)a[d]*=c;return new k.Mesh({vertices2D:a,coords:b},null,e)};Mesh.point=function(g){return new k.Mesh({vertices:[0,0,0]})};Mesh.cube=function(g,e){g=g||{};var a=0.5*(g.size||1),b={};
b.vertices=new Float32Array([-1,1,-1,-1,-1,1,-1,1,1,-1,1,-1,-1,-1,-1,-1,-1,1,1,1,-1,1,1,1,1,-1,1,1,1,-1,1,-1,1,1,-1,-1,-1,1,1,1,-1,1,1,1,1,-1,1,1,-1,-1,1,1,-1,1,-1,1,-1,1,1,-1,1,-1,-1,-1,1,-1,1,-1,-1,-1,-1,-1,-1,1,-1,1,1,1,1,1,-1,-1,1,-1,-1,1,1,1,1,1,-1,-1,-1,1,-1,-1,1,-1,1,-1,-1,-1,1,-1,1,-1,-1,1]);for(var c=0,d=b.vertices.length;c<d;++c)b.vertices[c]*=a;b.normals=new Float32Array([-1,0,0,-1,0,0,-1,0,0,-1,0,0,-1,0,0,-1,0,0,1,0,0,1,0,0,1,0,0,1,0,0,1,0,0,1,0,0,0,0,1,0,0,1,0,0,1,0,0,1,0,0,1,0,0,1,0,
0,-1,0,0,-1,0,0,-1,0,0,-1,0,0,-1,0,0,-1,0,1,0,0,1,0,0,1,0,0,1,0,0,1,0,0,1,0,0,-1,0,0,-1,0,0,-1,0,0,-1,0,0,-1,0,0,-1,0]);b.coords=new Float32Array([0,1,1,0,1,1,0,1,0,0,1,0,1,1,0,1,0,0,1,1,0,0,1,0,0,1,1,0,1,1,0,1,0,0,1,0,1,1,0,1,0,0,1,1,0,0,1,0,0,1,1,0,1,1,0,1,0,0,1,0,1,1,0,1,0,0,1,1,0,0,1,0]);g.wireframe&&(b.wireframe=new Uint16Array([0,2,2,5,5,4,4,0,6,7,7,10,10,11,11,6,0,6,2,7,5,10,4,11]));g.bounding=BBox.fromCenterHalfsize([0,0,0],[a,a,a]);return k.Mesh.load(b,g,e)};Mesh.box=function(g,e){g=g||{};
var a=g.sizex||1,b=g.sizey||1,c=g.sizez||1,a=0.5*a,b=0.5*b,c=0.5*c,d={};d.vertices=new Float32Array([-1,1,-1,-1,-1,1,-1,1,1,-1,1,-1,-1,-1,-1,-1,-1,1,1,1,-1,1,1,1,1,-1,1,1,1,-1,1,-1,1,1,-1,-1,-1,1,1,1,-1,1,1,1,1,-1,1,1,-1,-1,1,1,-1,1,-1,1,-1,1,1,-1,1,-1,-1,-1,1,-1,1,-1,-1,-1,-1,-1,-1,1,-1,1,1,1,1,1,-1,-1,1,-1,-1,1,1,1,1,1,-1,-1,-1,1,-1,-1,1,-1,1,-1,-1,-1,1,-1,1,-1,-1,1]);for(var f=0,h=d.vertices.length;f<h;f+=3)d.vertices[f]*=a,d.vertices[f+1]*=b,d.vertices[f+2]*=c;d.normals=new Float32Array([-1,0,
0,-1,0,0,-1,0,0,-1,0,0,-1,0,0,-1,0,0,1,0,0,1,0,0,1,0,0,1,0,0,1,0,0,1,0,0,0,0,1,0,0,1,0,0,1,0,0,1,0,0,1,0,0,1,0,0,-1,0,0,-1,0,0,-1,0,0,-1,0,0,-1,0,0,-1,0,1,0,0,1,0,0,1,0,0,1,0,0,1,0,0,1,0,0,-1,0,0,-1,0,0,-1,0,0,-1,0,0,-1,0,0,-1,0]);d.coords=new Float32Array([0,1,1,0,1,1,0,1,0,0,1,0,1,1,0,1,0,0,1,1,0,0,1,0,0,1,1,0,1,1,0,1,0,0,1,0,1,1,0,1,0,0,1,1,0,0,1,0,0,1,1,0,1,1,0,1,0,0,1,0,1,1,0,1,0,0,1,1,0,0,1,0]);g.wireframe&&(d.wireframe=new Uint16Array([0,2,2,5,5,4,4,0,6,7,7,10,10,11,11,6,0,6,2,7,5,10,4,11]));
g.bounding=BBox.fromCenterHalfsize([0,0,0],[a,b,c]);return k.Mesh.load(d,g,e)};Mesh.circle=function(g,e){g=g||{};var a=g.size||g.radius||1,b=Math.ceil(g.slices||24),c=g.xz||!1,d=g.empty||!1;3>b&&(b=3);var f=2*Math.PI/b,h=vec3.create(),s=vec3.create(),l=vec3.fromValues(0,0,1),n=vec2.fromValues(0.5,0.5),p=vec2.create();c&&l.set([0,1,0]);var r=c?2:1,q=new Float32Array(3*(b+1)),m=new Float32Array(3*(b+1)),u=new Float32Array(2*(b+1)),t=null;q.set(h,0);m.set(l,0);u.set(n,0);for(h=n=t=0;h<b;++h)t=Math.sin(f*
h),n=Math.cos(f*h),s[0]=t*a,s[r]=n*a,p[0]=0.5*t+0.5,p[1]=0.5*n+0.5,q.set(s,3*h+3),m.set(l,3*h+3),u.set(p,2*h+2);if(d)q=q.subarray(3),m=q.subarray(3),u=q.subarray(2),t=null;else{t=new Uint16Array(3*b);d=2;f=1;c&&(d=1,f=2);for(h=0;h<b-1;++h)t[3*h]=0,t[3*h+1]=h+d,t[3*h+2]=h+f;t[3*h]=0;c?(t[3*h+1]=h+1,t[3*h+2]=1):(t[3*h+1]=1,t[3*h+2]=h+1)}g.bounding=BBox.fromCenterHalfsize([0,0,0],c?[a,0,a]:[a,a,0]);a={vertices:q,normals:m,coords:u,triangles:t};if(g.wireframe){c=new Uint16Array(2*b);for(h=0;h<b;h++)c[2*
h]=h,c[2*h+1]=h+1;c[0]=b;a.wireframe=c}return k.Mesh.load(a,g,e)};Mesh.cylinder=function(g,e){g=g||{};for(var a=g.radius||g.size||1,b=g.height||g.size||2,c=g.subdivisions||64,d=new Float32Array(36*c),f=new Float32Array(36*c),h=new Float32Array(24*c),s=2*Math.PI/c,l=null,k=0;k<c;++k){var p=k*s,l=[Math.sin(p),0,Math.cos(p)];d.set([l[0]*a,0.5*b,l[2]*a],18*k);f.set(l,18*k);h.set([k/c,1],12*k);l=[Math.sin(p),0,Math.cos(p)];d.set([l[0]*a,-0.5*b,l[2]*a],18*k+3);f.set(l,18*k+3);h.set([k/c,0],12*k+2);l=[Math.sin(p+
s),0,Math.cos(p+s)];d.set([l[0]*a,-0.5*b,l[2]*a],18*k+6);f.set(l,18*k+6);h.set([(k+1)/c,0],12*k+4);l=[Math.sin(p+s),0,Math.cos(p+s)];d.set([l[0]*a,0.5*b,l[2]*a],18*k+9);f.set(l,18*k+9);h.set([(k+1)/c,1],12*k+6);l=[Math.sin(p),0,Math.cos(p)];d.set([l[0]*a,0.5*b,l[2]*a],18*k+12);f.set(l,18*k+12);h.set([k/c,1],12*k+8);l=[Math.sin(p+s),0,Math.cos(p+s)];d.set([l[0]*a,-0.5*b,l[2]*a],18*k+15);f.set(l,18*k+15);h.set([(k+1)/c,0],12*k+10)}var l=18*k,r=12*k;if(!1===g.caps)d=d.subarray(0,l),f=f.subarray(0,l),
h=h.subarray(0,r);else for(var q=vec3.fromValues(0,0.5*b,0),m=vec3.fromValues(0,-0.5*b,0),u=vec3.fromValues(0,1,0),t=vec3.fromValues(0,-1,0),k=0;k<c;++k){var p=k*s,v=vec3.fromValues(Math.sin(p),0,Math.cos(p)),p=vec3.fromValues(Math.sin(p+s),0,Math.cos(p+s));d.set([v[0]*a,0.5*b,v[2]*a],l+18*k);f.set(u,l+18*k);h.set([0.5*-v[0]+0.5,0.5*v[2]+0.5],r+12*k);d.set([p[0]*a,0.5*b,p[2]*a],l+18*k+3);f.set(u,l+18*k+3);h.set([0.5*-p[0]+0.5,0.5*p[2]+0.5],r+12*k+2);d.set(q,l+18*k+6);f.set(u,l+18*k+6);h.set([0.5,
0.5],r+12*k+4);d.set([p[0]*a,-0.5*b,p[2]*a],l+18*k+9);f.set(t,l+18*k+9);h.set([0.5*p[0]+0.5,0.5*p[2]+0.5],r+12*k+6);d.set([v[0]*a,-0.5*b,v[2]*a],l+18*k+12);f.set(t,l+18*k+12);h.set([0.5*v[0]+0.5,0.5*v[2]+0.5],r+12*k+8);d.set(m,l+18*k+15);f.set(t,l+18*k+15);h.set([0.5,0.5],r+12*k+10)}c={vertices:d,normals:f,coords:h};g.bounding=BBox.fromCenterHalfsize([0,0,0],[a,0.5*b,a]);return Mesh.load(c,g,e)};Mesh.cone=function(g,e){g=g||{};for(var a=g.radius||g.size||1,b=g.height||g.size||2,c=g.subdivisions||
64,d=new Float32Array(18*c),f=new Float32Array(18*c),h=new Float32Array(12*c),k=2*Math.PI/c,l=null,n=a/b,p=0;p<c;++p){var r=p*k,l=[Math.sin(r+0.5*k),n,Math.cos(r+0.5*k)];vec3.normalize(l,l);d.set([0,b,0],18*p);f.set(l,18*p);h.set([p/c,1],12*p);l=[Math.sin(r),n,Math.cos(r)];d.set([l[0]*a,0,l[2]*a],18*p+3);vec3.normalize(l,l);f.set(l,18*p+3);h.set([p/c,0],12*p+2);l=[Math.sin(r+k),n,Math.cos(r+k)];d.set([l[0]*a,0,l[2]*a],18*p+6);vec3.normalize(l,l);f.set(l,18*p+6);h.set([(p+1)/c,0],12*p+4)}l=vec3.fromValues(0,
0,0);n=vec3.fromValues(0,-1,0);for(p=0;p<c;++p){var r=p*k,q=vec3.fromValues(Math.sin(r),0,Math.cos(r)),r=vec3.fromValues(Math.sin(r+k),0,Math.cos(r+k));d.set([r[0]*a,0,r[2]*a],18*p+9);f.set(n,18*p+9);h.set([0.5*r[0]+0.5,0.5*r[2]+0.5],12*p+6);d.set([q[0]*a,0,q[2]*a],18*p+12);f.set(n,18*p+12);h.set([0.5*q[0]+0.5,0.5*q[2]+0.5],12*p+8);d.set(l,18*p+15);f.set(n,18*p+15);h.set([0.5,0.5],12*p+10)}c={vertices:d,normals:f,coords:h};g.bounding=BBox.fromCenterHalfsize([0,0.5*b,0],[a,0.5*b,a]);return Mesh.load(c,
g,e)};Mesh.sphere=function(g,e){g=g||{};for(var a=g.radius||g.size||1,b=g.lat||g.subdivisions||16,c=g["long"]||g.subdivisions||16,d=new Float32Array((b+1)*(c+1)*3),f=new Float32Array((b+1)*(c+1)*3),h=new Float32Array((b+1)*(c+1)*2),s=new Uint16Array(b*c*6),l=g.hemi?0.5*Math.PI:Math.PI,n=0,p=0,r=0;r<=b;r++)for(var q=r*l/b,m=Math.sin(q),u=Math.cos(q),q=0;q<=c;q++){var t=2*q*Math.PI/c,v=Math.sin(t),t=Math.cos(t)*m,w=u,v=v*m,y=1-q/c,z=1-r/b;d.set([a*t,a*w,a*v],n);f.set([t,w,v],n);h.set([y,z],p);n+=3;
p+=2}for(r=n=0;r<b;r++)for(q=0;q<c;q++)l=r*(c+1)+q,p=l+c+1,s.set([p,l,l+1],n),s.set([p+1,p,l+1],n+3),n+=6;d={vertices:d,normals:f,coords:h,triangles:s};if(g.wireframe){f=new Uint16Array(c*b*4);for(n=h=0;n<b;n++){for(s=0;s<c;s++)f[h]=n*(c+1)+s,f[h+1]=n*(c+1)+s+1,h+=2;f[h-2*c]=n*(c+1)+s}for(n=0;n<c;n++)for(s=0;s<b;s++)f[h]=s*(c+1)+n,f[h+1]=(s+1)*(c+1)+n,h+=2;d.wireframe=f}g.bounding=g.hemi?BBox.fromCenterHalfsize([0,0.5*a,0],[a,0.5*a,a],a):BBox.fromCenterHalfsize([0,0,0],[a,a,a],a);return k.Mesh.load(d,
g,e)};Mesh.grid=function(g,e){g=g||{};var a=g.lines||11;0>a&&(a=1);for(var b=g.size||10,c=new Float32Array(12*a),d=0.5*b,f=0,h=-d,b=b/(a-1),s=0;s<a;s++)c[f]=h,c[f+2]=-d,c[f+3]=h,c[f+5]=d,c[f+6]=d,c[f+8]=h,c[f+9]=-d,c[f+11]=h,h+=b,f+=12;return new k.Mesh({vertices:c},g,e)};Mesh.icosahedron=function(g,e){function a(a,c){var d=l[a]<l[c]?l[a]+":"+l[c]:l[c]+":"+l[a],e=u[d];if(e)return e;e=f.length/3;f.push(0.5*(f[3*l[a]]+f[3*l[c]]),0.5*(f[3*l[a]+1]+f[3*l[c]+1]),0.5*(f[3*l[a]+2]+f[3*l[c]+2]));var g=Math.sqrt(f[3*
e]*f[3*e]+f[3*e+1]*f[3*e+1]+f[3*e+2]*f[3*e+2]),k=f[3*e]/g,n=f[3*e+1]/g,p=f[3*e+2]/g;h.push(k,n,p);s.push(Math.atan2(k,p)/Math.PI*0.5,Math.acos(n)/Math.PI);f[3*e]*=b/g;f[3*e+1]*=b/g;f[3*e+2]*=b/g;return u[d]=e}g=g||{};var b=g.radius||g.size||1,c=void 0===g.subdivisions?0:g.subdivisions;6<c&&(c=6);for(var d=(1+Math.sqrt(5))/2,f=[-1,d,0,1,d,0,-1,-d,0,1,-d,0,0,-1,d,0,1,d,0,-1,-d,0,1,-d,d,0,-1,d,0,1,-d,0,-1,-d,0,1],h=[],s=[],l=[0,11,5,0,5,1,0,1,7,0,7,10,0,10,11,1,5,9,5,11,4,11,10,2,10,7,6,7,1,8,3,9,4,
3,4,2,3,2,6,3,6,8,3,8,9,4,9,5,2,4,11,6,2,10,8,6,7,9,8,1],d=f.length,n=0;n<d;n+=3){var p=Math.sqrt(f[n]*f[n]+f[n+1]*f[n+1]+f[n+2]*f[n+2]),r=f[n]/p,q=f[n+1]/p,m=f[n+2]/p;h.push(r,q,m);s.push(Math.atan2(r,m),Math.acos(q));f[n]*=b/p;f[n+1]*=b/p;f[n+2]*=b/p}for(var u={},p=0;p<c;++p){r=[];d=l.length;for(n=0;n<d;n+=3){var q=a(n,n+1),m=a(n+1,n+2),t=a(n+2,n);r.push(l[n],q,t);r.push(l[n+1],m,q);r.push(l[n+2],t,m);r.push(q,m,t)}l=r}g.bounding=BBox.fromCenterHalfsize([0,0,0],[b,b,b],b);return new k.Mesh.load({vertices:f,
coords:s,normals:h,triangles:l},g,e)};m.Texture=k.Texture=function e(a,b,c,d){c=c||{};this.gl=d=d||m.gl;this._context_id=d.context_id;a=parseInt(a);b=parseInt(b);k.debug&&console.log("GL.Texture created: ",a,b);this.handler=d.createTexture();this.width=a;this.height=b;this.texture_type=c.texture_type||d.TEXTURE_2D;this.format=c.format||e.DEFAULT_FORMAT;this.type=c.type||e.DEFAULT_TYPE;this.magFilter=c.magFilter||c.filter||e.DEFAULT_MAG_FILTER;this.minFilter=c.minFilter||c.filter||e.DEFAULT_MIN_FILTER;
this.wrapS=c.wrap||c.wrapS||e.DEFAULT_WRAP_S;this.wrapT=c.wrap||c.wrapT||e.DEFAULT_WRAP_T;this.data=null;e.MAX_TEXTURE_IMAGE_UNITS||(e.MAX_TEXTURE_IMAGE_UNITS=d.getParameter(d.MAX_TEXTURE_IMAGE_UNITS));this.has_mipmaps=!1;if(this.format==d.DEPTH_COMPONENT&&!d.extensions.WEBGL_depth_texture)throw"Depth Texture not supported";if(this.type==d.FLOAT&&!d.extensions.OES_texture_float)throw"Float Texture not supported";if(this.type==d.HALF_FLOAT_OES&&!d.extensions.OES_texture_half_float)throw"Half Float Texture not supported";
if(!(isPowerOfTwo(this.width)&&isPowerOfTwo(this.height)||(this.minFilter==d.NEAREST||this.minFilter==d.LINEAR)&&this.wrapS==d.CLAMP_TO_EDGE&&this.wrapT==d.CLAMP_TO_EDGE))if(c.ignore_pot)this.minFilter=this.magFilter=d.LINEAR,this.wrapS=this.wrapT=d.CLAMP_TO_EDGE;else throw"Cannot use texture-wrap or mipmaps in Non-Power-of-Two textures";if(a&&b){d.activeTexture(d.TEXTURE0+e.MAX_TEXTURE_IMAGE_UNITS-1);d.bindTexture(this.texture_type,this.handler);d.texParameteri(this.texture_type,d.TEXTURE_MAG_FILTER,
this.magFilter);d.texParameteri(this.texture_type,d.TEXTURE_MIN_FILTER,this.minFilter);d.texParameteri(this.texture_type,d.TEXTURE_WRAP_S,this.wrapS);d.texParameteri(this.texture_type,d.TEXTURE_WRAP_T,this.wrapT);c.anisotropic&&d.extensions.EXT_texture_filter_anisotropic&&d.texParameterf(d.TEXTURE_2D,d.extensions.EXT_texture_filter_anisotropic.TEXTURE_MAX_ANISOTROPY_EXT,c.anisotropic);var f=c.pixel_data;f&&!f.buffer&&(this.data=f=new (this.type==d.FLOAT?Float32Array:Uint8Array)(f));this.texture_type==
d.TEXTURE_2D?(d.texImage2D(d.TEXTURE_2D,0,this.format,a,b,0,this.format,this.type,f||null),k.isPowerOfTwo(a)&&k.isPowerOfTwo(b)&&c.minFilter&&c.minFilter!=d.NEAREST&&c.minFilter!=d.LINEAR&&(d.generateMipmap(this.texture_type),this.has_mipmaps=!0)):this.texture_type==d.TEXTURE_CUBE_MAP&&(d.texImage2D(d.TEXTURE_CUBE_MAP_POSITIVE_X,0,this.format,this.width,this.height,0,this.format,this.type,f||null),d.texImage2D(d.TEXTURE_CUBE_MAP_POSITIVE_Y,0,this.format,this.width,this.height,0,this.format,this.type,
f||null),d.texImage2D(d.TEXTURE_CUBE_MAP_POSITIVE_Z,0,this.format,this.width,this.height,0,this.format,this.type,f||null),d.texImage2D(d.TEXTURE_CUBE_MAP_NEGATIVE_X,0,this.format,this.width,this.height,0,this.format,this.type,f||null),d.texImage2D(d.TEXTURE_CUBE_MAP_NEGATIVE_Y,0,this.format,this.width,this.height,0,this.format,this.type,f||null),d.texImage2D(d.TEXTURE_CUBE_MAP_NEGATIVE_Z,0,this.format,this.width,this.height,0,this.format,this.type,f||null));d.bindTexture(this.texture_type,null);d.activeTexture(d.TEXTURE0)}};
Texture.DEFAULT_TYPE=k.UNSIGNED_BYTE;Texture.DEFAULT_FORMAT=k.RGBA;Texture.DEFAULT_MAG_FILTER=k.LINEAR;Texture.DEFAULT_MIN_FILTER=k.LINEAR;Texture.DEFAULT_WRAP_S=k.CLAMP_TO_EDGE;Texture.DEFAULT_WRAP_T=k.CLAMP_TO_EDGE;Texture.framebuffer=null;Texture.renderbuffer=null;Texture.loading_color=new Uint8Array([0,0,0,0]);Texture.use_renderbuffer_pool=!0;Texture.prototype.delete=function(){gl.deleteTexture(this.handler);this.handler=null};Texture.prototype.getProperties=function(){return{width:this.width,
height:this.height,type:this.type,format:this.format,texture_type:this.texture_type,magFilter:this.magFilter,minFilter:this.minFilter,wrapS:this.wrapS,wrapT:this.wrapT}};Texture.prototype.hasSameProperties=function(e){return e?e.width==this.width&&e.height==this.height&&e.type==this.type&&e.format==this.format&&e.texture_type==this.texture_type:!1};Texture.prototype.hasSameSize=function(e){return e?e.width==this.width&&e.height==this.height:!1};Texture.prototype.toJSON=function(){return""};Texture.isDepthSupported=
function(){return null!=gl.extensions.WEBGL_depth_texture};Texture.prototype.bind=function(e){void 0==e&&(e=0);var a=this.gl;a.activeTexture(a.TEXTURE0+e);a.bindTexture(this.texture_type,this.handler);return e};Texture.prototype.unbind=function(e){void 0===e&&(e=0);var a=this.gl;a.activeTexture(a.TEXTURE0+e);a.bindTexture(this.texture_type,null)};Texture.prototype.setParameter=function(e,a){this.bind(0);this.gl.texParameteri(this.texture_type,e,a);switch(e){case this.gl.TEXTURE_MAG_FILTER:this.magFilter=
a;break;case this.gl.TEXTURE_MIN_FILTER:this.minFilter=a;break;case this.gl.TEXTURE_WRAP_S:this.wrapS=a;break;case this.gl.TEXTURE_WRAP_T:this.wrapT=a}};Texture.setUploadOptions=function(e,a){a=a||m.gl;e?(a.pixelStorei(a.UNPACK_PREMULTIPLY_ALPHA_WEBGL,!!e.premultiply_alpha),a.pixelStorei(a.UNPACK_FLIP_Y_WEBGL,!e.no_flip)):(a.pixelStorei(a.UNPACK_PREMULTIPLY_ALPHA_WEBGL,!1),a.pixelStorei(a.UNPACK_FLIP_Y_WEBGL,!0));a.pixelStorei(a.UNPACK_ALIGNMENT,1)};Texture.prototype.uploadImage=function(e,a){this.bind();
var b=this.gl;if(!e)throw"uploadImage parameter must be Image";Texture.setUploadOptions(a,b);try{b.texImage2D(b.TEXTURE_2D,0,this.format,this.format,this.type,e),this.width=e.videoWidth||e.width,this.height=e.videoHeight||e.height,this.data=e}catch(c){if("file:"==location.protocol)throw'image not loaded for security reasons (serve this page over "http://" instead)';throw"image not loaded for security reasons (image must originate from the same domain as this page or use Cross-Origin Resource Sharing)";
}this.minFilter&&this.minFilter!=b.NEAREST&&this.minFilter!=b.LINEAR&&(b.generateMipmap(this.texture_type),this.has_mipmaps=!0);b.bindTexture(this.texture_type,null)};Texture.prototype.uploadData=function(e,a){var b=this.gl;this.bind();Texture.setUploadOptions(a,b);b.texImage2D(this.texture_type,0,this.format,this.width,this.height,0,this.format,this.type,e);this.data=e;this.minFilter&&this.minFilter!=b.NEAREST&&this.minFilter!=b.LINEAR&&(b.generateMipmap(texture.texture_type),this.has_mipmaps=!0);
b.bindTexture(this.texture_type,null)};Texture.cubemap_camera_parameters=[{type:"posX",dir:vec3.fromValues(1,0,0),up:vec3.fromValues(0,1,0),right:vec3.fromValues(0,0,-1)},{type:"negX",dir:vec3.fromValues(-1,0,0),up:vec3.fromValues(0,1,0),right:vec3.fromValues(0,0,1)},{type:"posY",dir:vec3.fromValues(0,1,0),up:vec3.fromValues(0,0,-1),right:vec3.fromValues(1,0,0)},{type:"negY",dir:vec3.fromValues(0,-1,0),up:vec3.fromValues(0,0,1),right:vec3.fromValues(1,0,0)},{type:"posZ",dir:vec3.fromValues(0,0,1),
up:vec3.fromValues(0,1,0),right:vec3.fromValues(1,0,0)},{type:"negZ",dir:vec3.fromValues(0,0,-1),up:vec3.fromValues(0,1,0),right:vec3.fromValues(-1,0,0)}];Texture.prototype.drawTo=function(e,a){function b(){6E4<=k.getTime()-this.time?(console.log("Buffer cleared"),c.deleteRenderbuffer(c._renderbuffers_pool[n]),delete c._renderbuffers_pool[n]):setTimeout(b.bind(this),6E4)}var c=this.gl,d=c.getViewport(),f=k.getTime(),h=c.getParameter(c.FRAMEBUFFER_BINDING),s=c._framebuffer=c._framebuffer||c.createFramebuffer();
c.bindFramebuffer(c.FRAMEBUFFER,s);var l=null;if(Texture.use_renderbuffer_pool){c._renderbuffers_pool||(c._renderbuffers_pool={});var n=this.width+":"+this.height;c._renderbuffers_pool[n]?(l=c._renderbuffers_pool[n],l.time=f,c.bindRenderbuffer(c.RENDERBUFFER,l)):(c._renderbuffers_pool[n]=l=c.createRenderbuffer(),l.time=f,l.width=this.width,l.height=this.height,c.bindRenderbuffer(c.RENDERBUFFER,l),setTimeout(b.bind(l),6E4))}else l=c._renderbuffer=c._renderbuffer||c.createRenderbuffer(),l.width=this.width,
l.height=this.height,c.bindRenderbuffer(c.RENDERBUFFER,l);this.format===c.DEPTH_COMPONENT?c.renderbufferStorage(c.RENDERBUFFER,c.RGBA4,this.width,this.height):c.renderbufferStorage(c.RENDERBUFFER,c.DEPTH_COMPONENT16,this.width,this.height);c.viewport(0,0,this.width,this.height);c._current_texture_drawto=this;c._current_fbo_color=s;c._current_fbo_depth=l;if(this.texture_type==c.TEXTURE_2D)this.format!==c.DEPTH_COMPONENT?(c.framebufferTexture2D(c.FRAMEBUFFER,c.COLOR_ATTACHMENT0,c.TEXTURE_2D,this.handler,
0),c.framebufferRenderbuffer(c.FRAMEBUFFER,c.DEPTH_ATTACHMENT,c.RENDERBUFFER,l)):(c.framebufferRenderbuffer(c.FRAMEBUFFER,c.COLOR_ATTACHMENT0,c.RENDERBUFFER,l),c.framebufferTexture2D(c.FRAMEBUFFER,c.DEPTH_ATTACHMENT,c.TEXTURE_2D,this.handler,0)),e(this,a);else if(this.texture_type==c.TEXTURE_CUBE_MAP)for(this.format!==c.DEPTH_COMPONENT?c.framebufferRenderbuffer(c.FRAMEBUFFER,c.DEPTH_ATTACHMENT,c.RENDERBUFFER,l):c.framebufferRenderbuffer(c.FRAMEBUFFER,c.COLOR_ATTACHMENT0,c.RENDERBUFFER,l),f=0;6>f;f++)this.format!==
c.DEPTH_COMPONENT?c.framebufferTexture2D(c.FRAMEBUFFER,c.COLOR_ATTACHMENT0,c.TEXTURE_CUBE_MAP_POSITIVE_X+f,this.handler,0):c.framebufferTexture2D(c.FRAMEBUFFER,c.DEPTH_ATTACHMENT,c.TEXTURE_CUBE_MAP_POSITIVE_X+f,this.handler,0),e(this,f,a);this.data=null;c._current_texture_drawto=null;c._current_fbo_color=null;c._current_fbo_depth=null;c.bindFramebuffer(c.FRAMEBUFFER,h);c.bindRenderbuffer(c.RENDERBUFFER,null);c.viewport(d[0],d[1],d[2],d[3]);return this};Texture.drawTo=function(e,a,b){var c=-1,d=-1,
f=null;if(!e&&!b)throw"Textures missing in drawTo";if(e&&e.length)for(var h=0;h<e.length;h++){var k=e[h];if(-1==c)c=k.width;else if(c!=k.width)throw"Cannot use Texture.drawTo if textures have different dimensions";if(-1==d)d=k.height;else if(d!=k.height)throw"Cannot use Texture.drawTo if textures have different dimensions";if(null==f)f=k.type;else if(f!=k.type)throw"Cannot use Texture.drawTo if textures have different data type, all must have the same type";}else c=b.width,d=b.height;var l=gl.extensions.WEBGL_draw_buffers;
if(!l&&e&&1<e.length)throw"Rendering to several textures not supported";f=gl.getViewport();gl._framebuffer=gl._framebuffer||gl.createFramebuffer();gl.bindFramebuffer(gl.FRAMEBUFFER,gl._framebuffer);gl.viewport(0,0,c,d);h=null;if(b&&b.format!==gl.DEPTH_COMPONENT||b.type!=gl.UNSIGNED_INT)throw"Depth texture must be of format: gl.DEPTH_COMPONENT and type: gl.UNSIGNED_INT";b?gl.framebufferTexture2D(gl.FRAMEBUFFER,gl.DEPTH_ATTACHMENT,gl.TEXTURE_2D,b.handler,0):(h=gl._renderbuffer=gl._renderbuffer||gl.createRenderbuffer(),
h.width=c,h.height=d,gl.bindRenderbuffer(gl.RENDERBUFFER,h),gl.renderbufferStorage(gl.RENDERBUFFER,gl.DEPTH_COMPONENT16,c,d),gl.framebufferRenderbuffer(gl.FRAMEBUFFER,gl.DEPTH_ATTACHMENT,gl.RENDERBUFFER,h));if(e){c=[];for(h=0;h<e.length;h++)k=e[h],gl.framebufferTexture2D(gl.FRAMEBUFFER,gl.COLOR_ATTACHMENT0+h,gl.TEXTURE_2D,k.handler,0),c.push(gl.COLOR_ATTACHMENT0+h);1<e.length&&l.drawBuffersWEBGL(c)}else b=this._color_renderbuffer=this._color_renderbuffer||gl.createRenderbuffer(),b.width=c,b.height=
d,gl.bindRenderbuffer(gl.RENDERBUFFER,b),gl.renderbufferStorage(gl.RENDERBUFFER,gl.RGBA4,c,d),gl.framebufferRenderbuffer(gl.FRAMEBUFFER,gl.COLOR_ATTACHMENT0,gl.RENDERBUFFER,b);c=gl.checkFramebufferStatus(gl.FRAMEBUFFER);if(c!==gl.FRAMEBUFFER_COMPLETE)throw"FBO not complete: "+c;a();if(e.length)for(h=0;h<e.length;++h)e[h].data=null;gl.bindFramebuffer(gl.FRAMEBUFFER,null);gl.viewport(f[0],f[1],f[2],f[3])};Texture.drawToColorAndDepth=function(e,a,b){var c=e.gl;if(a.width!=e.width||a.height!=e.height)throw"Different size between color texture and depth texture";
var d=c.getViewport();c._framebuffer=c._framebuffer||c.createFramebuffer();c.bindFramebuffer(c.FRAMEBUFFER,c._framebuffer);c.viewport(0,0,e.width,e.height);c.framebufferTexture2D(c.FRAMEBUFFER,c.COLOR_ATTACHMENT0,c.TEXTURE_2D,e.handler,0);c.framebufferTexture2D(c.FRAMEBUFFER,c.DEPTH_ATTACHMENT,c.TEXTURE_2D,a.handler,0);b();e.data=null;a.data=null;c.bindFramebuffer(c.FRAMEBUFFER,null);c.viewport(d[0],d[1],d[2],d[3])};Texture.prototype.copyTo=function(e,a,b){var c=this.gl,d=c.getParameter(c.FRAMEBUFFER_BINDING),
f=c.getViewport();a||(a=this.texture_type==c.TEXTURE_2D?k.Shader.getScreenShader():k.Shader.getCubemapCopyShader());c.disable(c.BLEND);c.disable(c.DEPTH_TEST);a&&b&&a.uniforms(b);b=c.__copy_fbo;b||(b=c.__copy_fbo=c.createFramebuffer());c.bindFramebuffer(c.FRAMEBUFFER,b);c.viewport(0,0,e.width,e.height);if(this.texture_type==c.TEXTURE_2D)if(this.format!==c.DEPTH_COMPONENT&&this.format!==c.DEPTH_STENCIL)c.framebufferTexture2D(c.FRAMEBUFFER,c.COLOR_ATTACHMENT0,c.TEXTURE_2D,e.handler,0),this.toViewport(a);
else{a=c._color_renderbuffer=c._color_renderbuffer||c.createRenderbuffer();b=a.width=e.width;var h=a.height=e.height;c.bindRenderbuffer(c.RENDERBUFFER,a);c.renderbufferStorage(c.RENDERBUFFER,c.RGBA4,b,h);c.framebufferRenderbuffer(c.FRAMEBUFFER,c.COLOR_ATTACHMENT0,c.RENDERBUFFER,a);b=e.format==c.DEPTH_STENCIL?c.DEPTH_STENCIL_ATTACHMENT:c.DEPTH_ATTACHMENT;c.framebufferTexture2D(c.FRAMEBUFFER,b,c.TEXTURE_2D,e.handler,0);a=c.checkFramebufferStatus(c.FRAMEBUFFER);if(a!==c.FRAMEBUFFER_COMPLETE)throw"FBO not complete: "+
a;c.enable(c.DEPTH_TEST);c.depthFunc(c.ALWAYS);c.colorMask(!1,!1,!1,!1);a=k.Shader.getCopyDepthShader();this.toViewport(a);c.colorMask(!0,!0,!0,!0);c.disable(c.DEPTH_TEST);c.depthFunc(c.LEQUAL);c.framebufferRenderbuffer(c.FRAMEBUFFER,c.COLOR_ATTACHMENT0,c.RENDERBUFFER,null);c.framebufferTexture2D(c.FRAMEBUFFER,b,c.TEXTURE_2D,null,0)}else if(this.texture_type==c.TEXTURE_CUBE_MAP)for(a.uniforms({u_texture:0}),b=k.temp_mat3,h=0;6>h;h++){c.framebufferTexture2D(c.FRAMEBUFFER,c.COLOR_ATTACHMENT0,c.TEXTURE_CUBE_MAP_POSITIVE_X+
h,e.handler,0);var s=k.Texture.cubemap_camera_parameters[h];mat3.identity(b);b.set(s.right,0);b.set(s.up,3);b.set(s.dir,6);this.toViewport(a,{u_rotation:b})}c.setViewport(f);c.bindFramebuffer(c.FRAMEBUFFER,d);e.minFilter&&e.minFilter!=c.NEAREST&&e.minFilter!=c.LINEAR&&(e.bind(),c.generateMipmap(e.texture_type),e.has_mipmaps=!0);e.data=null;c.bindTexture(e.texture_type,null);return this};Texture.prototype.toViewport=function(e,a){e=e||Shader.getScreenShader();var b=Mesh.getScreenQuad();this.bind(0);
a&&e.uniforms(a);e.draw(b,gl.TRIANGLES)};Texture.prototype.fill=function(e,a){var b=gl.getParameter(gl.COLOR_CLEAR_VALUE);gl.clearColor(e[0],e[1],e[2],e[3]);this.drawTo(function(){gl.clear(gl.COLOR_BUFFER_BIT)});gl.clearColor(b[0],b[1],b[2],b[3]);!a&&this.minFilter&&this.minFilter!=gl.NEAREST&&this.minFilter!=gl.LINEAR&&(this.bind(),gl.generateMipmap(this.texture_type),this.has_mipmaps=!0)};Texture.prototype.renderQuad=function(){var e=mat3.create(),a=vec2.create(),b=vec2.create(),c=vec4.fromValues(1,
1,1,1);return function(d,f,h,k,l,n){a[0]=d;a[1]=f;b[0]=h;b[1]=k;l=l||Shader.getQuadShader(this.gl);d=Mesh.getScreenQuad(this.gl);this.bind(0);l.uniforms({u_texture:0,u_position:a,u_color:c,u_size:b,u_viewport:gl.viewport_data.subarray(2,4),u_transform:e});n&&l.uniforms(n);l.draw(d,gl.TRIANGLES)}}();Texture.prototype.applyBlur=function(e,a,b,c,d){var f=this.gl;void 0===e&&(e=1);void 0===a&&(a=1);e/=this.width;a/=this.height;f.disable(f.DEPTH_TEST);f.disable(f.BLEND);if(this===d&&this.texture_type===
f.TEXTURE_CUBE_MAP)throw"cannot use applyBlur in a texture with itself when blurring a CUBE_MAP";if(d&&this.texture_type!==d.texture_type)throw"cannot use applyBlur with textures of different texture_type";var h=null,s=f.getParameter(f.FRAMEBUFFER_BINDING),l=f.getViewport(),n=f.__copy_fbo;n||(n=f.__copy_fbo=f.createFramebuffer());f.bindFramebuffer(f.FRAMEBUFFER,n);f.viewport(0,0,this.width,this.height);if(this.texture_type===f.TEXTURE_2D)h=k.Shader.getBlurShader(),c||(c=new k.Texture(this.width,this.height,
this.getProperties())),f.framebufferTexture2D(f.FRAMEBUFFER,f.COLOR_ATTACHMENT0,f.TEXTURE_2D,c.handler,0),this.toViewport(h,{u_texture:0,u_intensity:b,u_offset:[0,a]}),d=d||this,f.framebufferTexture2D(f.FRAMEBUFFER,f.COLOR_ATTACHMENT0,f.TEXTURE_2D,d.handler,0),c.toViewport(h,{u_intensity:b,u_offset:[e,0]}),h=c;else if(this.texture_type===f.TEXTURE_CUBE_MAP){h=k.Shader.getCubemapBlurShader();h.uniforms({u_texture:0,u_intensity:b,u_offset:[e,a]});this.bind(0);e=Mesh.getScreenQuad();e.bindBuffers(h);
h.bind();d||(d=new k.Texture(this.width,this.height,this.getProperties()));a=k.temp_mat3;for(b=0;6>b;++b)f.framebufferTexture2D(f.FRAMEBUFFER,f.COLOR_ATTACHMENT0,f.TEXTURE_CUBE_MAP_POSITIVE_X+b,d.handler,0),c=k.Texture.cubemap_camera_parameters[b],mat3.identity(a),a.set(c.right,0),a.set(c.up,3),a.set(c.dir,6),h._setUniform("u_rotation",a),f.drawArrays(f.TRIANGLES,0,6);e.unbindBuffers(h);h=d}f.setViewport(l);f.bindFramebuffer(f.FRAMEBUFFER,s);d.data=null;d.minFilter&&d.minFilter!=f.NEAREST&&d.minFilter!=
f.LINEAR&&(d.bind(),f.generateMipmap(d.texture_type),d.has_mipmaps=!0);f.bindTexture(d.texture_type,null);return h};Texture.fromURL=function(e,a,b,c){c=c||m.gl;a=a||{};a=Object.create(a);var d=a.texture||new k.Texture(1,1,a,c);64>e.length&&(d.url=e);d.bind();var f=a.temp_color||Texture.loading_color;c.pixelStorei(c.UNPACK_ALIGNMENT,4);f=a.type==c.FLOAT?new Float32Array(f):new Uint8Array(f);c.texImage2D(c.TEXTURE_2D,0,d.format,d.width,d.height,0,d.format,d.type,f);c.bindTexture(d.texture_type,null);
d.ready=!1;f=null;a.extension&&(f=a.extension);if(!f&&512>e.length){var h=e,s=e.indexOf("?");-1!=s&&(h=e.substr(0,s));s=h.lastIndexOf(".");-1!=s&&(f=h.substr(s+1).toLowerCase())}"dds"==f?(f=c.getExtension("WEBKIT_WEBGL_compressed_texture_s3tc")||c.getExtension("WEBGL_compressed_texture_s3tc"),h=new k.Texture(0,0,a,c),S.loadDDSTextureEx(c,f,e,h.handler,!0,function(a){d.texture_type=a.texture_type;d.handler=a;delete d.ready;b&&b(d,e)})):"tga"==f?HttpRequest(e,null,function(c){if(c=k.Texture.parseTGA(c))a.texture=
d,d=k.Texture.fromMemory(c.width,c.height,c.pixels,a),delete d.ready,b&&b(d,e)},null,{binary:!0}):(c=new Image,c.src=e,c.onload=function(){a.texture=d;k.Texture.fromImage(this,a);delete d.ready;b&&b(d,e)},c.onerror=function(){b&&b(null)});return d};Texture.parseTGA=function(e){if(!e||e.constructor!==ArrayBuffer)throw"TGA: data must be ArrayBuffer";e=new Uint8Array(e);for(var a=new Uint8Array([0,0,2,0,0,0,0,0,0,0,0,0]),b=e.subarray(0,12),c=0;c<b.length;c++)if(a[c]!=b[c])return console.error("TGA header is not valid"),
null;a=e.subarray(12,18);b={};b.width=256*a[1]+a[0];b.height=256*a[3]+a[2];b.bpp=a[4];b.bytesPerPixel=b.bpp/8;b.imageSize=b.width*b.height*b.bytesPerPixel;b.pixels=e.subarray(18,18+b.imageSize);b.pixels=new Uint8Array(b.pixels);if(0==(a[5]&16)){for(c=0;c<b.imageSize;c+=b.bytesPerPixel)e=b.pixels[c],b.pixels[c]=b.pixels[c+2],b.pixels[c+2]=e;a[5]|=16}b.format=32==b.bpp?"RGBA":"RGB";b.flipY=!0;return b};Texture.fromImage=function(e,a){a=a||{};var b=a.texture||new k.Texture(e.width,e.height,a);b.uploadImage(e,
a);b.bind();gl.texParameteri(b.texture_type,gl.TEXTURE_MAG_FILTER,b.magFilter);gl.texParameteri(b.texture_type,gl.TEXTURE_MIN_FILTER,b.minFilter);gl.texParameteri(b.texture_type,gl.TEXTURE_WRAP_S,b.wrapS);gl.texParameteri(b.texture_type,gl.TEXTURE_WRAP_T,b.wrapT);k.isPowerOfTwo(b.width)&&k.isPowerOfTwo(b.height)?a.minFilter&&a.minFilter!=gl.NEAREST&&a.minFilter!=gl.LINEAR&&(b.bind(),gl.generateMipmap(b.texture_type),b.has_mipmaps=!0):(gl.texParameteri(b.texture_type,gl.TEXTURE_MIN_FILTER,k.LINEAR),
gl.texParameteri(b.texture_type,gl.TEXTURE_WRAP_S,k.CLAMP_TO_EDGE),gl.texParameteri(b.texture_type,gl.TEXTURE_WRAP_T,k.CLAMP_TO_EDGE),b.has_mipmaps=!1);gl.bindTexture(b.texture_type,null);b.data=e;a.keep_image&&(b.img=e);return b};Texture.fromVideo=function(e,a){a=a||{};var b=a.texture||new k.Texture(e.videoWidth,e.videoHeight,a);b.bind();b.uploadImage(e,a);a.minFilter&&a.minFilter!=gl.NEAREST&&a.minFilter!=gl.LINEAR&&(b.bind(),gl.generateMipmap(b.texture_type),b.has_mipmaps=!0,b.data=e);gl.bindTexture(b.texture_type,
null);return b};Texture.fromTexture=function(e,a){a=a||{};var b=new k.Texture(e.width,e.height,a);e.copyTo(b);return b};Texture.prototype.clone=function(e){var a=this.getProperties();if(e)for(var b in e)a[b]=e[b];return Texture.fromTexture(this,a)};Texture.fromMemory=function(e,a,b,c){c=c||{};var d=c.texture||new k.Texture(e,a,c);Texture.setUploadOptions(c);d.bind();try{gl.texImage2D(gl.TEXTURE_2D,0,d.format,e,a,0,d.format,d.type,b),d.width=e,d.height=a,d.data=b}catch(f){if("file:"==location.protocol)throw'image not loaded for security reasons (serve this page over "http://" instead)';
throw"image not loaded for security reasons (image must originate from the same domain as this page or use Cross-Origin Resource Sharing)";}c.minFilter&&c.minFilter!=gl.NEAREST&&c.minFilter!=gl.LINEAR&&(gl.generateMipmap(gl.TEXTURE_2D),d.has_mipmaps=!0);gl.bindTexture(d.texture_type,null);return d};Texture.fromDDSInMemory=function(e,a){a=a||{};var b=a.texture||new k.Texture(0,0,a);k.Texture.setUploadOptions(a);b.bind();var c=gl.getExtension("WEBKIT_WEBGL_compressed_texture_s3tc")||gl.getExtension("WEBGL_compressed_texture_s3tc");
S.loadDDSTextureFromMemoryEx(gl,c,e,b,!0);gl.bindTexture(b.texture_type,null);return b};Texture.fromShader=function(e,a,b,c){c=c||{};e=new k.Texture(e,a,c);e.drawTo(function(){gl.disable(gl.BLEND);gl.disable(gl.DEPTH_TEST);gl.disable(gl.CULL_FACE);var a=Mesh.getScreenQuad();b.draw(a)});return e};Texture.cubemapFromImages=function(e,a){a=a||{};if(6!=e.length)throw"missing images to create cubemap";var b=e[0].width,c=e[0].height;a.texture_type=gl.TEXTURE_CUBE_MAP;var d=null;a.texture?(d=a.texture,d.width=
b,d.height=c):d=new k.Texture(b,c,a);Texture.setUploadOptions(a);d.bind();try{for(b=0;6>b;b++)gl.texImage2D(gl.TEXTURE_CUBE_MAP_POSITIVE_X+b,0,d.format,d.format,d.type,e[b]);d.data=e}catch(f){if("file:"==location.protocol)throw'image not loaded for security reasons (serve this page over "http://" instead)';throw"image not loaded for security reasons (image must originate from the same domain as this page or use Cross-Origin Resource Sharing)";}a.minFilter&&a.minFilter!=gl.NEAREST&&a.minFilter!=gl.LINEAR&&
(gl.generateMipmap(gl.TEXTURE_CUBE_MAP),d.has_mipmaps=!0);d.unbind();return d};Texture.cubemapFromImage=function(e,a){a=a||{};if(e.width!=e.height/6&&0!=e.height%6&&!a.faces)return console.error("Cubemap image not valid, only 1x6 (vertical) or 6x3 (cross) formats. Check size:",e.width,e.height),null;var b=e.width,c=e.height;void 0!==a.is_cross?(a.faces=Texture.generateCubemapCrossFacesInfo(e.width,a.is_cross),b=c=e.width/4):a.faces?(b=a.width||a.faces[0].width,c=a.height||a.faces[0].height):c/=6;
if(b!=c)return console.log("Texture not valid, width and height for every face must be square"),null;var d=b;a.no_flip=!0;for(var f=[],h=0;6>h;h++){var k=createCanvas(d,d),l=k.getContext("2d");a.faces?l.drawImage(e,a.faces[h].x,a.faces[h].y,a.faces[h].width||d,a.faces[h].height||d,0,0,d,d):l.drawImage(e,0,c*h,b,c,0,0,d,d);f.push(k)}b=Texture.cubemapFromImages(f,a);a.keep_image&&(b.img=e);return b};Texture.generateCubemapCrossFacesInfo=function(e,a){void 0===a&&(a=1);var b=e/4;return[{x:2*b,y:b,width:b,
height:b},{x:0,y:b,width:b,height:b},{x:a*b,y:0,width:b,height:b},{x:a*b,y:2*b,width:b,height:b},{x:b,y:b,width:b,height:b},{x:3*b,y:b,width:b,height:b}]};Texture.cubemapFromURL=function(e,a,b){a=a||{};a.texture_type=gl.TEXTURE_CUBE_MAP;var c=a.texture||new k.Texture(1,1,a);a=Object.create(a);c.bind();Texture.setUploadOptions(a);for(var d=a.temp_color||[0,0,0,255],d=a.type==gl.FLOAT?new Float32Array(d):new Uint8Array(d),f=0;6>f;f++)gl.texImage2D(gl.TEXTURE_CUBE_MAP_POSITIVE_X+f,0,c.format,1,1,0,c.format,
c.type,d);gl.bindTexture(c.texture_type,null);c.ready=!1;d=new Image;d.src=e;d.onload=function(){a.texture=c;(c=k.Texture.cubemapFromImage(this,a))&&delete c.ready;b&&b(c)};return c};Texture.prototype.getPixels=function(e,a,b){a=this.gl;var c=a.getViewport(),d=a.getParameter(a.FRAMEBUFFER_BINDING);e=e||this.type;if(this.format==a.DEPTH_COMPONENT)throw"cannot use getPixels in depth textures";a.disable(a.DEPTH_TEST);var f=a.__copy_fbo;f||(f=a.__copy_fbo=a.createFramebuffer());a.bindFramebuffer(a.FRAMEBUFFER,
f);f=null;a.viewport(0,0,this.width,this.height);this.texture_type==a.TEXTURE_2D?a.framebufferTexture2D(a.FRAMEBUFFER,a.COLOR_ATTACHMENT0,a.TEXTURE_2D,this.handler,0):this.texture_type==a.TEXTURE_CUBE_MAP&&a.framebufferTexture2D(a.FRAMEBUFFER,a.COLOR_ATTACHMENT0,a.TEXTURE_CUBE_MAP_POSITIVE_X+(b||0),this.handler,0);b=this.format==a.RGB?3:4;b=4;f=e==a.UNSIGNED_BYTE?new Uint8Array(this.width*this.height*b):new Float32Array(this.width*this.height*b);a.readPixels(0,0,this.width,this.height,3==b?a.RGB:
a.RGBA,e,f);a.bindFramebuffer(a.FRAMEBUFFER,d);a.viewport(c[0],c[1],c[2],c[3]);return f};Texture.prototype.toCanvas=function(e,a,b){b=b||8192;var c=this.gl,d=Math.min(this.width,b),f=Math.min(this.height,b);this.texture_type==c.TEXTURE_CUBE_MAP&&(d*=4,f*=3);e=e||createCanvas(d,f);e.width!=d&&(e.width=d);e.height!=f&&(e.height=f);var h=null;if(this.texture_type==c.TEXTURE_2D){this.width!=d||this.height!=f?(h=new k.Texture(d,f,{format:c.RGBA,filter:c.NEAREST}),this.copyTo(h),h=h.getPixels(c.UNSIGNED_BYTE,
!0)):h=this.getPixels(c.UNSIGNED_BYTE,!0);b=e.getContext("2d");var s=b.getImageData(0,0,d,f);s.data.set(h);b.putImageData(s,0,0);a&&(h=createCanvas(d,f),a=h.getContext("2d"),a.translate(0,h.height),a.scale(1,-1),a.drawImage(e,0,0,h.width,h.height),b.drawImage(h,0,0))}else if(this.texture_type==c.TEXTURE_CUBE_MAP){d=createCanvas(this.width,this.height);a=d.getContext("2d");f=k.Texture.generateCubemapCrossFacesInfo(e.width,1);b=e.getContext("2d");b.fillStyle="black";b.fillRect(0,0,e.width,e.height);
for(var l=0;6>l;l++)h=this.getPixels(c.UNSIGNED_BYTE,!0,l),s=a.getImageData(0,0,d.width,d.height),s.data.set(h),a.putImageData(s,0,0),b.drawImage(d,f[l].x,f[l].y,d.width,d.height)}return e};Texture.binary_extension="png";Texture.prototype.toBinary=function(e,a){for(var b=this.toCanvas(null,e).toDataURL(a),c=b.indexOf(","),b=b.substr(c+1),b=atob(b),c=b.length,d=new Uint8Array(c),f=0;f<c;++f)d[f]=b.charCodeAt(f);return d};Texture.prototype.toBlob=function(e,a){var b=this.toBinary(e);return new Blob([b],
{type:a||"image/png"})};Texture.prototype.toBlobAsync=function(e,a,b){var c=this.toCanvas(null,e);c.toBlob?c.toBlob(b,a):(e=this.toBlob(e,a),b&&b(e))};Texture.prototype.toBase64=function(e){var a=this.width,b=this.height,c=this.getPixels(),d=createCanvas(a,b),f=d.getContext("2d"),h=f.getImageData(0,0,a,b);h.data.set(c);f.putImageData(h,0,0);e&&(e=createCanvas(a,b),a=e.getContext("2d"),a.translate(0,b),a.scale(1,-1),a.drawImage(d,0,0),d=e);return d.toDataURL("image/png")};Texture.prototype.generateMetadata=
function(){var e={};e.width=this.width;e.height=this.height;this.metadata=e};Texture.compareFormats=function(e,a){return e&&a?e==a?!0:e.width!=a.width||e.height!=a.height||e.type!=a.type||e.format!=a.format||e.texture_type!=a.texture_type?!1:!0:!1};Texture.blend=function(e,a,b,c){if(!e||!a)return!1;if(e==a)return c?e.copyTo(c):e.toViewport(),!0;gl.disable(gl.BLEND);gl.disable(gl.DEPTH_TEST);gl.disable(gl.CULL_FACE);var d=k.Shader.getBlendShader(),f=k.Mesh.getScreenQuad();a.bind(1);d.uniforms({u_texture:0,
u_texture2:1,u_factor:b});if(c)return c.drawTo(function(){if(e==c||a==c)throw"Blend output cannot be the same as the input";e.bind(0);d.draw(f,gl.TRIANGLES)}),!0;e.bind(0);d.draw(f,gl.TRIANGLES);return!0};Texture.getWhiteTexture=function(e){e=e||m.gl;var a=e.textures[":white"];if(a)return a;a=new Uint8Array([255,255,255,255]);return e.textures[":white"]=new k.Texture(1,1,{pixel_data:a})};Texture.getBlackTexture=function(e){e=e||m.gl;var a=e.textures[":black"];if(a)return a;a=new Uint8Array([0,0,0,
255]);return e.textures[":black"]=new k.Texture(1,1,{pixel_data:a})};Texture.getTemporary=function(e,a,b,c){c=c||m.gl;c._texture_pool||(c._texture_pool=[]);var d=k.TEXTURE_2D,f=Texture.DEFAULT_TYPE,h=Texture.DEFAULT_FORMAT;b&&(b.texture_type&&(d=b.texture_type),b.type&&(f=b.type),b.format&&(h=b.format));b=(f&65535)+((e&65535)<<16)+((a&65535)<<32);c=c._texture_pool;for(var s=0;s<c.length;++s){var l=c[s];if(l._key==b&&l.texture_type==d&&l.format==h)return c.splice(s,1),l._pool=0,l}l=new k.Texture(e,
a,{type:f,texture_type:d,format:h});l._key=b;l._pool=0;return l};Texture.releaseTemporary=function(e,a){a=a||m.gl;a._texture_pool||(a._texture_pool=[]);0<e._pool&&console.warn("this texture is already in the textures pool");var b=a._texture_pool;b||(b=a._texture_pool=[]);e._pool=getTime();b.push(e);15<b.length&&(b.sort(function(a,b){return b._pool-a._pool}),e=b.pop(),e._pool=0,e.delete())};Texture.nextPOT=function(e){return Math.pow(2,Math.ceil(Math.log(e)/Math.log(2)))};k.FBO=I;I.prototype.setTextures=
function(e,a,b){if(a&&a.constructor===k.Texture&&(a.format!==gl.DEPTH_COMPONENT&&a.format!==gl.DEPTH_STENCIL||a.type!=gl.UNSIGNED_INT&&a.type!=k.UNSIGNED_INT_24_8_WEBGL))throw"FBO Depth texture must be of format: gl.DEPTH_COMPONENT and type: gl.UNSIGNED_INT";var c=this.depth_texture==a;if(c&&e){if(e.constructor!==Array)throw"FBO: color_textures parameter must be an array containing all the textures to be binded in the color";if(e.length==this.color_textures.length)for(var d=0;d<e.length;++d){if(e[d]!=
this.color_textures[d]){c=!1;break}}else c=!1}this._stencil_enabled!==this.stencil&&(c=!1);if(!c){this.color_textures.length=e?e.length:0;if(e)for(d=0;d<e.length;++d)this.color_textures[d]=e[d];this.depth_texture=a;this.update(b)}};I.prototype.update=function(e){this._old_fbo_handler=gl.getParameter(gl.FRAMEBUFFER_BINDING);this.handler||(this.handler=gl.createFramebuffer());var a=-1,b=-1,c=null,d=this.color_textures,f=this.depth_texture;if(d&&d.length)for(var h=0;h<d.length;h++){var s=d[h];if(s.constructor!==
k.Texture)throw"FBO can only bind instances of GL.Texture";if(-1==a)a=s.width;else if(a!=s.width)throw"Cannot bind textures with different dimensions";if(-1==b)b=s.height;else if(b!=s.height)throw"Cannot bind textures with different dimensions";if(null==c)c=s.type;else if(c!=s.type)throw"Cannot bind textures to a FBO with different pixel formats";if(s.texture_type!=gl.TEXTURE_2D)throw"Cannot bind a Cubemap to a FBO";}else a=f.width,b=f.height;this.width=a;this.height=b;gl.bindFramebuffer(gl.FRAMEBUFFER,
this.handler);if(f&&!gl.extensions.WEBGL_depth_texture)throw"Rendering to depth texture not supported by your browser";c=gl.extensions.WEBGL_draw_buffers;if(!c&&d&&1<d.length)throw"Rendering to several textures not supported by your browser";gl.framebufferRenderbuffer(gl.FRAMEBUFFER,gl.DEPTH_ATTACHMENT,gl.RENDERBUFFER,null);gl.framebufferRenderbuffer(gl.FRAMEBUFFER,gl.DEPTH_STENCIL_ATTACHMENT,gl.RENDERBUFFER,null);f&&f.constructor===k.Texture?(this.stencil&&f.format!==gl.DEPTH_STENCIL&&console.warn("Stencil cannot be enabled if there is a depth texture with a DEPTH_STENCIL format"),
f.format==gl.DEPTH_STENCIL?gl.framebufferTexture2D(gl.FRAMEBUFFER,gl.DEPTH_STENCIL_ATTACHMENT,gl.TEXTURE_2D,f.handler,0):gl.framebufferTexture2D(gl.FRAMEBUFFER,gl.DEPTH_ATTACHMENT,gl.TEXTURE_2D,f.handler,0)):(h=null,f&&f.constructor===WebGLRenderbuffer&&f.width==a&&f.height==b?h=this._depth_renderbuffer=f:(h=this._depth_renderbuffer=this._depth_renderbuffer||gl.createRenderbuffer(),h.width=a,h.height=b),gl.bindRenderbuffer(gl.RENDERBUFFER,h),this.stencil?(gl.renderbufferStorage(gl.RENDERBUFFER,gl.DEPTH_STENCIL,
a,b),gl.framebufferRenderbuffer(gl.FRAMEBUFFER,gl.DEPTH_STENCIL_ATTACHMENT,gl.RENDERBUFFER,h)):(gl.renderbufferStorage(gl.RENDERBUFFER,gl.DEPTH_COMPONENT16,a,b),gl.framebufferRenderbuffer(gl.FRAMEBUFFER,gl.DEPTH_ATTACHMENT,gl.RENDERBUFFER,h)));if(d&&d.length)for(this.order=[],h=0;h<d.length;h++)s=d[h],gl.framebufferTexture2D(gl.FRAMEBUFFER,gl.COLOR_ATTACHMENT0+h,gl.TEXTURE_2D,s.handler,0),this.order.push(gl.COLOR_ATTACHMENT0+h);else f=this._color_renderbuffer=this._color_renderbuffer||gl.createRenderbuffer(),
f.width=a,f.height=b,gl.bindRenderbuffer(gl.RENDERBUFFER,f),gl.renderbufferStorage(gl.RENDERBUFFER,gl.RGBA4,a,b),gl.framebufferRenderbuffer(gl.FRAMEBUFFER,gl.COLOR_ATTACHMENT0,gl.RENDERBUFFER,f);for(h=a=d?d.length:0;h<this._num_binded_textures;++h)gl.framebufferTexture2D(gl.FRAMEBUFFER,gl.COLOR_ATTACHMENT0+h,gl.TEXTURE_2D,null,0);this._num_binded_textures=a;this._stencil_enabled=this.stencil;d&&1<d.length&&c.drawBuffersWEBGL(this.order);d=gl.checkFramebufferStatus(gl.FRAMEBUFFER);if(d!==gl.FRAMEBUFFER_COMPLETE)throw"FBO not complete: "+
d;gl.bindTexture(gl.TEXTURE_2D,null);gl.bindRenderbuffer(gl.RENDERBUFFER,null);e||gl.bindFramebuffer(gl.FRAMEBUFFER,this._old_fbo_handler)};I.prototype.bind=function(e){if(!this.color_textures.length&&!this.depth_texture)throw"FBO: no textures attached to FBO";this._old_viewport.set(gl.viewport_data);this._old_fbo_handler=e?gl.getParameter(gl.FRAMEBUFFER_BINDING):null;this._old_fbo_handler!=this.handler&&gl.bindFramebuffer(gl.FRAMEBUFFER,this.handler);for(e=0;e<this.color_textures.length;++e)this.color_textures[e]._in_current_fbo=
!0;this.depth_texture&&(this.depth_texture._in_current_fbo=!0);gl.viewport(0,0,this.width,this.height)};I.prototype.unbind=function(){gl.bindFramebuffer(gl.FRAMEBUFFER,this._old_fbo_handler);this._old_fbo_handler=null;gl.setViewport(this._old_viewport);for(var e=0;e<this.color_textures.length;++e)this.color_textures[e]._in_current_fbo=!1;this.depth_texture&&(this.depth_texture._in_current_fbo=!1)};I.prototype.switchTo=function(e){e._old_fbo_handler=this._old_fbo_handler;e._old_viewport.set(this._old_viewport);
gl.bindFramebuffer(gl.FRAMEBUFFER,e.handler);this._old_fbo_handler=null;gl.viewport(0,0,this.width,this.height);for(var a=0;a<this.color_textures.length;++a)this.color_textures[a]._in_current_fbo=!1;this.depth_texture&&(this.depth_texture._in_current_fbo=!1);for(a=0;a<e.color_textures.length;++a)e.color_textures[a]._in_current_fbo=!0;e.depth_texture&&(e.depth_texture._in_current_fbo=!0)};I.prototype.delete=function(){gl.deleteFramebuffer(this.handler);this.handler=null};m.Shader=k.Shader=function a(b,
c,d){k.debug&&console.log("GL.Shader created");this._context_id=m.gl.context_id;var f=this.gl=m.gl;d=a.expandMacros(d);this.program=f.createProgram();b=b.constructor===String?k.Shader.compileSource(f.VERTEX_SHADER,d+b):b;c=c.constructor===String?k.Shader.compileSource(f.FRAGMENT_SHADER,d+c):c;f.attachShader(this.program,b,f);f.attachShader(this.program,c,f);f.linkProgram(this.program);if(!f.getProgramParameter(this.program,f.LINK_STATUS))throw"link error: "+f.getProgramInfoLog(this.program);this.vs_shader=
b;this.fs_shader=c;this.attributes={};this.uniformInfo={};this.samplers={};this.extractShaderInfo()};Shader.expandMacros=function(a){var b="";if(a)for(var c in a)b+="#define "+c+" "+(a[c]?a[c]:"")+"\n";return b};Shader.compileSource=function(a,b,c,d){c=c||m.gl;d=d||c.createShader(a);c.shaderSource(d,b);c.compileShader(d);if(!c.getShaderParameter(d,c.COMPILE_STATUS))throw(a==c.VERTEX_SHADER?"Vertex":"Fragment")+" shader compile error: "+c.getShaderInfoLog(d);return d};Shader.parseError=function(a,
b,c){if(!a)return null;var d=a.split(" "),f=d[5].split(":");return{type:d[0],line_number:parseInt(f[1]),line_pos:parseInt(f[0]),line_code:("Fragment"==d[0]?c:b).split("\n")[parseInt(f[1])],err:a}};Shader.prototype.updateShader=function(a,b,c){var d=this.gl||m.gl;c=Shader.expandMacros(c);this.program&&(this.program=d.createProgram());a=a.constructor===String?k.Shader.compileSource(d.VERTEX_SHADER,c+a,d,this.vs_shader):a;b=b.constructor===String?k.Shader.compileSource(d.FRAGMENT_SHADER,c+b,d,this.fs_shader):
b;d.attachShader(this.program,a,d);d.attachShader(this.program,b,d);d.linkProgram(this.program);if(!d.getProgramParameter(this.program,d.LINK_STATUS))throw"link error: "+d.getProgramInfoLog(this.program);this.vs_shader=a;this.fs_shader=b;this.attributes={};this.uniformInfo={};this.samplers={};this.extractShaderInfo()};Shader.prototype.extractShaderInfo=function(){for(var a=this.gl,b=a.getProgramParameter(this.program,a.ACTIVE_UNIFORMS),c=0;c<b;++c){var d=a.getActiveUniform(this.program,c);if(!d)break;
var f=d.name,h=f.indexOf("[");-1!=h&&-1==f.indexOf("].")&&(f=f.substr(0,h));if(d.type==a.SAMPLER_2D||d.type==a.SAMPLER_CUBE)this.samplers[f]=d.type;var h=Shader.getUniformFunc(d),k=!1;if(d.type==a.FLOAT_MAT2||d.type==a.FLOAT_MAT3||d.type==a.FLOAT_MAT4)k=!0;this.uniformInfo[f]={type:d.type,func:h,size:d.size,is_matrix:k,loc:a.getUniformLocation(this.program,f)}}c=0;for(b=a.getProgramParameter(this.program,a.ACTIVE_ATTRIBUTES);c<b;++c){d=a.getActiveAttrib(this.program,c);if(!d)break;h=Shader.getUniformFunc(d);
this.uniformInfo[d.name]={type:d.type,func:h,size:d.size,loc:null};this.attributes[d.name]=a.getAttribLocation(this.program,d.name)}};Shader.prototype.hasUniform=function(a){return this.uniformInfo[a]};Shader.prototype.hasAttribute=function(a){return this.attributes[a]};Shader.getUniformFunc=function(a){var b=null;switch(a.type){case gl.FLOAT:b=1==a.size?gl.uniform1f:gl.uniform1fv;break;case gl.FLOAT_MAT2:b=gl.uniformMatrix2fv;break;case gl.FLOAT_MAT3:b=gl.uniformMatrix3fv;break;case gl.FLOAT_MAT4:b=
gl.uniformMatrix4fv;break;case gl.FLOAT_VEC2:b=gl.uniform2fv;break;case gl.FLOAT_VEC3:b=gl.uniform3fv;break;case gl.FLOAT_VEC4:b=gl.uniform4fv;break;case gl.UNSIGNED_INT:case gl.INT:b=1==a.size?gl.uniform1i:gl.uniform1iv;break;case gl.INT_VEC2:b=gl.uniform2iv;break;case gl.INT_VEC3:b=gl.uniform3iv;break;case gl.INT_VEC4:b=gl.uniform4iv;break;case gl.SAMPLER_2D:case gl.SAMPLER_CUBE:b=gl.uniform1i;break;default:b=gl.uniform1f}return b};Shader.fromURL=function(a,b,c){function d(){var a=new k.Shader(h,
s),b;for(b in a)f[b]=a[b];f.ready=!0}var f=new k.Shader("\n\t\t\tprecision highp float;\n\t\t\tattribute vec3 a_vertex;\n\t\t\tattribute mat4 u_mvp;\n\t\t\tvoid main() { \n\t\t\t\tgl_Position = u_mvp * vec4(a_vertex,1.0); \n\t\t\t}\n\t\t","\n\t\t\tprecision highp float;\n\t\t\tvoid main() {\n\t\t\t\tgl_FragColor = vec4(0.0, 0.0, 0.0, 1.0);\n\t\t\t}\n\t\t\t");f.ready=!1;var h=null,s=null;HttpRequest(a,null,function(a){h=a;s&&d()});HttpRequest(b,null,function(a){s=a;h&&d()});return f};Shader.prototype.bind=
function(){var a=this.gl;a.useProgram(this.program);a._current_shader=this};Shader.prototype.getLocation=function(a){return this.uniformInfo[a]?this.uniformInfo[a].loc:null};Shader._temp_uniform=new Float32Array(16);Shader.prototype.uniforms=function(a){var b=this.gl;b.useProgram(this.program);b._current_shader=this;for(var c in a)this.uniformInfo[c]&&this._setUniform(c,a[c]);return this};Shader.prototype.uniformsArray=function(a){var b=this.gl;b.useProgram(this.program);b._current_shader=this;for(var b=
0,c=a.length;b<c;++b){var d=a[b],f;for(f in d)this._setUniform(f,d[f])}return this};Shader.prototype.setUniform=function(){for(var a=[],b=2;16>=b;++b)a[b]=new Float32Array(b);return function(b,d){this.gl._current_shader!=this&&this.bind();var f=this.uniformInfo[b];if(f&&null!==f.loc&&null!=d){if(d.constructor===Array){var h=a[d.length];h?(h.set(d),d=h):d=new Float32Array(d)}f.is_matrix?f.func.call(this.gl,f.loc,!1,d):f.func.call(this.gl,f.loc,d)}}}();Shader.prototype._setUniform=function(){for(var a=
[],b=2;16>=b;++b)a[b]=new Float32Array(b);return function(b,d){var f=this.uniformInfo[b];if(f&&null!==f.loc&&null!=d){if(d.constructor===Array){var h=a[d.length];h?(h.set(d),d=h):d=new Float32Array(d)}f.is_matrix?f.func.call(this.gl,f.loc,!1,d):f.func.call(this.gl,f.loc,d)}}}();Shader.prototype.draw=function(a,b,c){c=void 0===c?b==gl.LINES?"lines":"triangles":c;this.drawBuffers(a.vertexBuffers,c?a.indexBuffers[c]:null,2>arguments.length?gl.TRIANGLES:b)};Shader.prototype.drawRange=function(a,b,c,d,
f){f=void 0===f?b==gl.LINES?"lines":"triangles":f;this.drawBuffers(a.vertexBuffers,f?a.indexBuffers[f]:null,b,c,d)};var T=new Uint8Array(16),X=new Uint8Array(16);Shader.prototype.drawBuffers=function(a,b,c,d,f){if(0!=f){var h=this.gl;h.useProgram(this.program);var k=0;T.set(X);for(var l in a){var n=a[l],p=n.attribute||l,r=this.attributes[p];null!=r&&n.buffer&&(T[r]=1,h.bindBuffer(h.ARRAY_BUFFER,n.buffer),h.enableVertexAttribArray(r),h.vertexAttribPointer(r,n.buffer.spacing,n.buffer.gl_type,!1,0,0),
k=n.buffer.length/n.buffer.spacing)}a=0;0<d&&(a=d);b&&(k=b.buffer.length-a);0<f&&f<k&&(k=f);a*=b&&b.data?b.data.constructor.BYTES_PER_ELEMENT:1;for(p in this.attributes)r=this.attributes[p],T[r]||h.disableVertexAttribArray(this.attributes[p]);!k||b&&!b.buffer||(b?(h.bindBuffer(h.ELEMENT_ARRAY_BUFFER,b.buffer),h.drawElements(c,k,b.buffer.gl_type,a),h.bindBuffer(h.ELEMENT_ARRAY_BUFFER,null)):h.drawArrays(c,a,k));return this}};Shader.expandImports=function(a,b){b=b||Shader.files;var c={};if(!b)throw"Shader.files not initialized, assign files there";
return a.replace(/#import\s+\"([a-zA-Z0-9_\.]+)\"\s*\n/g,function(a){a=a.split('"')[1];if(c[a])return"//already imported: "+a+"\n";var f=b[a];c[a]=!0;return f?f+"\n":"//import code not found: "+a+"\n"})};Shader.dumpErrorToConsole=function(a,b,c){console.error(a);var d=null,d=-1!=a.indexOf("Fragment")?c:b;a=d.split("\n");for(var f in a)a[f]=f+"| "+a[f];console.groupCollapsed("Shader code");console.log(a.join("\n"));console.groupEnd()};Shader.validateValue=function(a,b){if(null===a||void 0===a)return!1;
switch(b.type){case k.INT:case k.FLOAT:case k.SAMPLER_2D:case k.SAMPLER_CUBE:return isNumber(a);case k.INT_VEC2:case k.FLOAT_VEC2:return 2===a.length;case k.INT_VEC3:case k.FLOAT_VEC3:return 3===a.length;case k.INT_VEC4:case k.FLOAT_VEC4:case k.FLOAT_MAT2:return 4===a.length;case k.FLOAT_MAT3:return 8===a.length;case k.FLOAT_MAT4:return 16===a.length}return!0};Shader.SCREEN_VERTEX_SHADER="\n\t\t\tprecision highp float;\n\t\t\tattribute vec3 a_vertex;\n\t\t\tattribute vec2 a_coord;\n\t\t\tvarying vec2 v_coord;\n\t\t\tvoid main() { \n\t\t\t\tv_coord = a_coord; \n\t\t\t\tgl_Position = vec4(a_coord * 2.0 - 1.0, 0.0, 1.0); \n\t\t\t}\n\t\t\t";
Shader.SCREEN_FRAGMENT_SHADER="\n\t\t\tprecision highp float;\n\t\t\tuniform sampler2D u_texture;\n\t\t\tvarying vec2 v_coord;\n\t\t\tvoid main() {\n\t\t\t\tgl_FragColor = texture2D(u_texture, v_coord);\n\t\t\t}\n\t\t\t";Shader.SCREEN_FRAGMENT_FX="\n\t\t\tprecision highp float;\n\t\t\tuniform sampler2D u_texture;\n\t\t\tvarying vec2 v_coord;\n\t\t\t#ifdef FX_UNIFORMS\n\t\t\t\tFX_UNIFORMS\n\t\t\t#endif\n\t\t\tvoid main() {\n\t\t\t\tvec2 uv = v_coord;\n\t\t\t\tvec4 color = texture2D(u_texture, uv);\n\t\t\t\t#ifdef FX_CODE\n\t\t\t\t\tFX_CODE ;\n\t\t\t\t#endif\n\t\t\t\tgl_FragColor = color;\n\t\t\t}\n\t\t\t";
Shader.SCREEN_COLORED_FRAGMENT_SHADER="\n\t\t\tprecision highp float;\n\t\t\tuniform sampler2D u_texture;\n\t\t\tuniform vec4 u_color;\n\t\t\tvarying vec2 v_coord;\n\t\t\tvoid main() {\n\t\t\t\tgl_FragColor = u_color * texture2D(u_texture, v_coord);\n\t\t\t}\n\t\t\t";Shader.BLEND_FRAGMENT_SHADER="\n\t\t\tprecision highp float;\n\t\t\tuniform sampler2D u_texture;\n\t\t\tuniform sampler2D u_texture2;\n\t\t\tuniform float u_factor;\n\t\t\tvarying vec2 v_coord;\n\t\t\tvoid main() {\n\t\t\t\tgl_FragColor = mix( texture2D(u_texture, v_coord), texture2D(u_texture2, v_coord), u_factor);\n\t\t\t}\n\t\t\t";
Shader.SCREEN_FLAT_FRAGMENT_SHADER="\n\t\t\tprecision highp float;\n\t\t\tuniform vec4 u_color;\n\t\t\tvoid main() {\n\t\t\t\tgl_FragColor = u_color;\n\t\t\t}\n\t\t\t";Shader.QUAD_VERTEX_SHADER="\n\t\t\tprecision highp float;\n\t\t\tattribute vec3 a_vertex;\n\t\t\tattribute vec2 a_coord;\n\t\t\tvarying vec2 v_coord;\n\t\t\tuniform vec2 u_position;\n\t\t\tuniform vec2 u_size;\n\t\t\tuniform vec2 u_viewport;\n\t\t\tuniform mat3 u_transform;\n\t\t\tvoid main() { \n\t\t\t\tvec3 pos = vec3(u_position + vec2(a_coord.x,1.0 - a_coord.y)  * u_size, 1.0);\n\t\t\t\tv_coord = a_coord; \n\t\t\t\tpos = u_transform * pos;\n\t\t\t\tpos.z = 0.0;\n\t\t\t\t//normalize\n\t\t\t\tpos.x = (2.0 * pos.x / u_viewport.x) - 1.0;\n\t\t\t\tpos.y = -((2.0 * pos.y / u_viewport.y) - 1.0);\n\t\t\t\tgl_Position = vec4(pos, 1.0); \n\t\t\t}\n\t\t\t";
Shader.QUAD_FRAGMENT_SHADER="\n\t\t\tprecision highp float;\n\t\t\tuniform sampler2D u_texture;\n\t\t\tuniform vec4 u_color;\n\t\t\tvarying vec2 v_coord;\n\t\t\tvoid main() {\n\t\t\t\tgl_FragColor = u_color * texture2D(u_texture, v_coord);\n\t\t\t}\n\t\t\t";Shader.QUAD2_FRAGMENT_SHADER="\n\t\t\tprecision highp float;\n\t\t\tuniform sampler2D u_texture;\n\t\t\tuniform vec4 u_color;\n\t\t\tuniform vec4 u_texture_area;\n\t\t\tvarying vec2 v_coord;\n\t\t\tvoid main() {\n\t\t\t    vec2 uv = vec2( mix(u_texture_area.x, u_texture_area.z, v_coord.x), 1.0 - mix(u_texture_area.w, u_texture_area.y, v_coord.y) );\n\t\t\t\tgl_FragColor = u_color * texture2D(u_texture, uv);\n\t\t\t}\n\t\t\t";
Shader.PRIMITIVE2D_VERTEX_SHADER="\n\t\t\tprecision highp float;\n\t\t\tattribute vec3 a_vertex;\n\t\t\tuniform vec2 u_viewport;\n\t\t\tuniform mat3 u_transform;\n\t\t\tvoid main() { \n\t\t\t\tvec3 pos = a_vertex;\n\t\t\t\tpos = u_transform * pos;\n\t\t\t\tpos.z = 0.0;\n\t\t\t\t//normalize\n\t\t\t\tpos.x = (2.0 * pos.x / u_viewport.x) - 1.0;\n\t\t\t\tpos.y = -((2.0 * pos.y / u_viewport.y) - 1.0);\n\t\t\t\tgl_Position = vec4(pos, 1.0); \n\t\t\t}\n\t\t\t";Shader.FLAT_VERTEX_SHADER="\n\t\t\tprecision highp float;\n\t\t\tattribute vec3 a_vertex;\n\t\t\tuniform mat4 u_mvp;\n\t\t\tvoid main() { \n\t\t\t\tgl_Position = u_mvp * vec4(a_vertex,1.0); \n\t\t\t}\n\t\t\t";
Shader.FLAT_FRAGMENT_SHADER="\n\t\t\tprecision highp float;\n\t\t\tuniform vec4 u_color;\n\t\t\tvoid main() {\n\t\t\t\tgl_FragColor = u_color;\n\t\t\t}\n\t\t\t";Shader.createFX=function(a,b,c){a={FX_CODE:a,FX_UNIFORMS:b||""};if(!c)return new k.Shader(k.Shader.SCREEN_VERTEX_SHADER,k.Shader.SCREEN_FRAGMENT_FX,a);c.updateShader(k.Shader.SCREEN_VERTEX_SHADER,k.Shader.SCREEN_FRAGMENT_FX,a);return c};Shader.prototype.toViewport=function(a){var b=k.Mesh.getScreenQuad();a&&this.uniforms(a);this.draw(b)};
Shader.getScreenShader=function(a){a=a||m.gl;var b=a.shaders[":screen"];if(b)return b;b=a.shaders[":screen"]=new k.Shader(Shader.SCREEN_VERTEX_SHADER,Shader.SCREEN_FRAGMENT_SHADER);return b.uniforms({u_texture:0})};Shader.getColoredScreenShader=function(a){a=a||m.gl;var b=a.shaders[":colored_screen"];if(b)return b;b=a.shaders[":colored_screen"]=new k.Shader(Shader.SCREEN_VERTEX_SHADER,Shader.SCREEN_COLORED_FRAGMENT_SHADER);return b.uniforms({u_texture:0,u_color:vec4.fromValues(1,1,1,1)})};Shader.getQuadShader=
function(a){a=a||m.gl;var b=a.shaders[":quad"];return b?b:a.shaders[":quad"]=new k.Shader(Shader.QUAD_VERTEX_SHADER,Shader.QUAD_FRAGMENT_SHADER)};Shader.getPartialQuadShader=function(a){a=a||m.gl;var b=a.shaders[":quad2"];return b?b:a.shaders[":quad2"]=new k.Shader(Shader.QUAD_VERTEX_SHADER,Shader.QUAD2_FRAGMENT_SHADER)};Shader.getBlendShader=function(a){a=a||m.gl;var b=a.shaders[":blend"];return b?b:a.shaders[":blend"]=new k.Shader(Shader.SCREEN_VERTEX_SHADER,Shader.BLEND_FRAGMENT_SHADER)};Shader.getBlurShader=
function(a){a=a||m.gl;var b=a.shaders[":blur"];if(b)return b;b=new k.Shader(Shader.SCREEN_VERTEX_SHADER,"\n\t\t\tprecision highp float;\n\t\t\tvarying vec2 v_coord;\n\t\t\tuniform sampler2D u_texture;\n\t\t\tuniform vec2 u_offset;\n\t\t\tuniform float u_intensity;\n\t\t\tvoid main() {\n\t\t\t   vec4 sum = vec4(0.0);\n\t\t\t   sum += texture2D(u_texture, v_coord + u_offset * -4.0) * 0.05/0.98;\n\t\t\t   sum += texture2D(u_texture, v_coord + u_offset * -3.0) * 0.09/0.98;\n\t\t\t   sum += texture2D(u_texture, v_coord + u_offset * -2.0) * 0.12/0.98;\n\t\t\t   sum += texture2D(u_texture, v_coord + u_offset * -1.0) * 0.15/0.98;\n\t\t\t   sum += texture2D(u_texture, v_coord) * 0.16/0.98;\n\t\t\t   sum += texture2D(u_texture, v_coord + u_offset * 4.0) * 0.05/0.98;\n\t\t\t   sum += texture2D(u_texture, v_coord + u_offset * 3.0) * 0.09/0.98;\n\t\t\t   sum += texture2D(u_texture, v_coord + u_offset * 2.0) * 0.12/0.98;\n\t\t\t   sum += texture2D(u_texture, v_coord + u_offset * 1.0) * 0.15/0.98;\n\t\t\t   gl_FragColor = u_intensity * sum;\n\t\t\t}\n\t\t\t");
return a.shaders[":blur"]=b};Shader.getCopyDepthShader=function(a){a=a||m.gl;var b=a.shaders[":copy_depth"];if(b)return b;b=new k.Shader(Shader.SCREEN_VERTEX_SHADER,"\n\t\t\t#extension GL_EXT_frag_depth : enable\n\t\t\tprecision highp float;\n\t\t\tvarying vec2 v_coord;\n\t\t\tuniform sampler2D u_texture;\n\t\t\tvoid main() {\n\t\t\t   gl_FragDepthEXT = texture2D( u_texture, v_coord ).x;\n\t\t\t   gl_FragColor = vec4(1.0);\n\t\t\t}\n\t\t\t");return a.shaders[":copy_depth"]=b};Shader.getCubemapCopyShader=
function(a){a=a||m.gl;var b=a.shaders[":copy_cubemap"];if(b)return b;b=new k.Shader(Shader.SCREEN_VERTEX_SHADER,"\n\t\t\tprecision highp float;\n\t\t\tvarying vec2 v_coord;\n\t\t\tuniform samplerCube u_texture;\n\t\t\tuniform mat3 u_rotation;\n\t\t\tvoid main() {\n\t\t\t\tvec2 uv = vec2( v_coord.x, 1.0 - v_coord.y );\n\t\t\t\tvec3 dir = vec3( uv - vec2(0.5), 0.5 );\n\t\t\t\tdir = u_rotation * dir;\n\t\t\t   gl_FragColor = textureCube( u_texture, dir );\n\t\t\t}\n\t\t\t");return a.shaders[":copy_cubemap"]=
b};Shader.getCubemapBlurShader=function(a){a=a||m.gl;var b=a.shaders[":blur_cubemap"];if(b)return b;b=new k.Shader(Shader.SCREEN_VERTEX_SHADER,"\n\t\t\t#ifndef NUM_SAMPLES\n\t\t\t\t#define NUM_SAMPLES 4\n\t\t\t#endif\n\t\t\t\n\t\t\tprecision highp float;\n\t\t\tvarying vec2 v_coord;\n\t\t\tuniform samplerCube u_texture;\n\t\t\tuniform mat3 u_rotation;\n\t\t\tuniform vec2 u_offset;\n\t\t\tuniform float u_intensity;\n\t\t\tvoid main() {\n\t\t\t\tvec4 sum = vec4(0.0);\n\t\t\t\tvec2 uv = vec2( v_coord.x, 1.0 - v_coord.y ) - vec2(0.5);\n\t\t\t\tvec3 dir = vec3(0.0);\n\t\t\t\tvec4 color = vec4(0.0);\n\t\t\t\tfor( int x = -2; x <= 2; x++ )\n\t\t\t\t{\n\t\t\t\t\tfor( int y = -2; y <= 2; y++ )\n\t\t\t\t\t{\n\t\t\t\t\t\tdir.xy = uv + vec2( u_offset.x * float(x), u_offset.y * float(y)) * 0.5;\n\t\t\t\t\t\tdir.z = 0.5;\n\t\t\t\t\t\tdir = u_rotation * dir;\n\t\t\t\t\t\tcolor = textureCube( u_texture, dir );\n\t\t\t\t\t\tcolor.xyz = color.xyz * color.xyz;/*linearize*/\n\t\t\t\t\t\tsum += color;\n\t\t\t\t\t}\n\t\t\t\t}\n\t\t\t\tsum /= 25.0;\n\t\t\t   gl_FragColor = vec4( sqrt( sum.xyz ), sum.w ) ;\n\t\t\t}\n\t\t\t");
return a.shaders[":blur_cubemap"]=b};Shader.FXAA_FUNC="\n\tuniform vec2 u_viewportSize;\n\tuniform vec2 u_iViewportSize;\n\t#define FXAA_REDUCE_MIN   (1.0/ 128.0)\n\t#define FXAA_REDUCE_MUL   (1.0 / 8.0)\n\t#define FXAA_SPAN_MAX     8.0\n\t\n\t/* from mitsuhiko/webgl-meincraft based on the code on geeks3d.com */\n\tvec4 applyFXAA(sampler2D tex, vec2 fragCoord)\n\t{\n\t\tvec4 color = vec4(0.0);\n\t\t/*vec2 u_iViewportSize = vec2(1.0 / u_viewportSize.x, 1.0 / u_viewportSize.y);*/\n\t\tvec3 rgbNW = texture2D(tex, (fragCoord + vec2(-1.0, -1.0)) * u_iViewportSize).xyz;\n\t\tvec3 rgbNE = texture2D(tex, (fragCoord + vec2(1.0, -1.0)) * u_iViewportSize).xyz;\n\t\tvec3 rgbSW = texture2D(tex, (fragCoord + vec2(-1.0, 1.0)) * u_iViewportSize).xyz;\n\t\tvec3 rgbSE = texture2D(tex, (fragCoord + vec2(1.0, 1.0)) * u_iViewportSize).xyz;\n\t\tvec3 rgbM  = texture2D(tex, fragCoord  * u_iViewportSize).xyz;\n\t\tvec3 luma = vec3(0.299, 0.587, 0.114);\n\t\tfloat lumaNW = dot(rgbNW, luma);\n\t\tfloat lumaNE = dot(rgbNE, luma);\n\t\tfloat lumaSW = dot(rgbSW, luma);\n\t\tfloat lumaSE = dot(rgbSE, luma);\n\t\tfloat lumaM  = dot(rgbM,  luma);\n\t\tfloat lumaMin = min(lumaM, min(min(lumaNW, lumaNE), min(lumaSW, lumaSE)));\n\t\tfloat lumaMax = max(lumaM, max(max(lumaNW, lumaNE), max(lumaSW, lumaSE)));\n\t\t\n\t\tvec2 dir;\n\t\tdir.x = -((lumaNW + lumaNE) - (lumaSW + lumaSE));\n\t\tdir.y =  ((lumaNW + lumaSW) - (lumaNE + lumaSE));\n\t\t\n\t\tfloat dirReduce = max((lumaNW + lumaNE + lumaSW + lumaSE) * (0.25 * FXAA_REDUCE_MUL), FXAA_REDUCE_MIN);\n\t\t\n\t\tfloat rcpDirMin = 1.0 / (min(abs(dir.x), abs(dir.y)) + dirReduce);\n\t\tdir = min(vec2(FXAA_SPAN_MAX, FXAA_SPAN_MAX), max(vec2(-FXAA_SPAN_MAX, -FXAA_SPAN_MAX), dir * rcpDirMin)) * u_iViewportSize;\n\t\t\n\t\tvec3 rgbA = 0.5 * (texture2D(tex, fragCoord * u_iViewportSize + dir * (1.0 / 3.0 - 0.5)).xyz + \n\t\t\ttexture2D(tex, fragCoord * u_iViewportSize + dir * (2.0 / 3.0 - 0.5)).xyz);\n\t\tvec3 rgbB = rgbA * 0.5 + 0.25 * (texture2D(tex, fragCoord * u_iViewportSize + dir * -0.5).xyz + \n\t\t\ttexture2D(tex, fragCoord * u_iViewportSize + dir * 0.5).xyz);\n\t\t\n\t\treturn vec4(rgbA,1.0);\n\t\tfloat lumaB = dot(rgbB, luma);\n\t\tif ((lumaB < lumaMin) || (lumaB > lumaMax))\n\t\t\tcolor = vec4(rgbA, 1.0);\n\t\telse\n\t\t\tcolor = vec4(rgbB, 1.0);\n\t\treturn color;\n\t}\n";
Shader.getFXAAShader=function(a){a=a||m.gl;var b=a.shaders[":fxaa"];if(b)return b;var b=new k.Shader(Shader.SCREEN_VERTEX_SHADER,"\n\t\t\tprecision highp float;\n\t\t\tvarying vec2 v_coord;\n\t\t\tuniform sampler2D u_texture;\n\t\t\t"+Shader.FXAA_FUNC+"\n\t\t\t\n\t\t\tvoid main() {\n\t\t\t   gl_FragColor = applyFXAA( u_texture, v_coord * u_viewportSize) ;\n\t\t\t}\n\t\t\t"),c=vec2.fromValues(a.viewport_data[2],a.viewport_data[3]),d=vec2.fromValues(1/a.viewport_data[2],1/a.viewport_data[3]);b.setup=
function(){c[0]=a.viewport_data[2];c[1]=a.viewport_data[3];d[0]=1/a.viewport_data[2];d[1]=1/a.viewport_data[3];this.uniforms({u_viewportSize:c,u_iViewportSize:d})};return a.shaders[":fxaa"]=b};Shader.getFlatShader=function(a){a=a||m.gl;var b=a.shaders[":flat"];if(b)return b;b=new k.Shader(Shader.FLAT_VERTEX_SHADER,Shader.FLAT_FRAGMENT_SHADER);b.uniforms({u_color:[1,1,1,1]});return a.shaders[":flat"]=b};k.create=function(a){function b(a){var c=l.mouse.buttons;k.augmentEvent(a,f);a.eventType=a.eventType||
a.type;var d=getTime();u.dragging=a.dragging;u.position[0]=a.canvasx;u.position[1]=a.canvasy;u.x=a.canvasx;u.y=a.canvasy;u.clientx=a.mousex;u.clienty=a.mousey;u.left_button=u.buttons&1<<k.LEFT_MOUSE_BUTTON;u.middle_button=u.buttons&1<<k.MIDDLE_MOUSE_BUTTON;u.right_button=u.buttons&1<<k.RIGHT_MOUSE_BUTTON;if("mousedown"==a.eventType){0==c&&(f.removeEventListener("mousemove",b),c=f.ownerDocument,c.addEventListener("mousemove",b),c.addEventListener("mouseup",b));x=d;if(l.onmousedown)l.onmousedown(a);
v.trigger(l,"mousedown")}else if("mousemove"==a.eventType){if(l.onmousemove)l.onmousemove(a);v.trigger(l,"mousemove",a)}else if("mouseup"==a.eventType){0==l.mouse.buttons&&(f.addEventListener("mousemove",b),c=f.ownerDocument,c.removeEventListener("mousemove",b),c.removeEventListener("mouseup",b));a.click_time=d-x;if(l.onmouseup)l.onmouseup(a);v.trigger(l,"mouseup",a)}else if("mousewheel"==a.eventType||"wheel"==a.eventType||"DOMMouseScroll"==a.eventType){a.eventType="mousewheel";a.wheel="wheel"==a.type?
-a.deltaY:null!=a.wheelDeltaY?a.wheelDeltaY:-60*a.detail;a.delta=void 0!==a.wheelDelta?a.wheelDelta/40:a.deltaY?-a.deltaY/3:0;if(l.onmousewheel)l.onmousewheel(a);v.trigger(l,"mousewheel",a)}if(l.onmouse)l.onmouse(a);"mousemove"!=a.eventType&&a.stopPropagation();a.preventDefault();return!1}function c(a){var b=a.changedTouches,c=b[0],d="";if(!(l.ontouch&&!1===l.ontouch(a)||!1===v.trigger(l,a.type,a)||!t||a.touches.length&&a.changedTouches[0].identifier!==a.touches[0].identifier||1<b)){switch(a.type){case "touchstart":d=
"mousedown";break;case "touchmove":d="mousemove";break;case "touchend":d="mouseup";break;default:return}b=document.createEvent("MouseEvent");b.initMouseEvent(d,!0,!0,window,1,c.screenX,c.screenY,c.clientX,c.clientY,!1,!1,!1,!1,0,null);b.originalEvent=b;b.is_touch=!0;c.target.dispatchEvent(b);a.preventDefault()}}function d(a){a.eventType=a.type;l.ongesture&&!1===l.ongesture(a)||!1!==v.trigger(l,a.type,a)&&a.preventDefault()}a=a||{};var f=null;if(a.canvas)if("string"==typeof a.canvas){if(f=document.getElementById(a.canvas),
!f)throw"Canvas element not found: "+a.canvas;}else f=a.canvas;else{var h=null;a.container&&(h=a.container.constructor===String?document.querySelector(a.container):a.container);if(h&&!a.width){var s=h.getBoundingClientRect();a.width=s.width;a.height=s.height}f=createCanvas(a.width||800,a.height||600);h&&h.appendChild(f)}"alpha"in a||(a.alpha=!1);var l=null;if(a.webgl2){try{l=f.getContext("webgl2",a),l.webgl_version=2}catch(n){}try{l=l||f.getContext("experimental-webgl2",a),l.webgl_version=2}catch(p){}}try{l=
l||f.getContext("webgl",a)}catch(r){}try{l=l||f.getContext("experimental-webgl",a)}catch(q){}if(!l)throw"WebGL not supported";void 0===l.webgl_version&&(l.webgl_version=1);m.gl=l;f.is_webgl=!0;f.gl=l;l.context_id=this.last_context_id++;l.extensions={};l.extensions.OES_standard_derivatives=l.derivatives_supported=l.getExtension("OES_standard_derivatives")||!1;l.extensions.WEBGL_depth_texture=l.getExtension("WEBGL_depth_texture")||l.getExtension("WEBKIT_WEBGL_depth_texture")||l.getExtension("MOZ_WEBGL_depth_texture");
l.extensions.OES_element_index_uint=l.getExtension("OES_element_index_uint");l.extensions.WEBGL_draw_buffers=l.getExtension("WEBGL_draw_buffers");l.extensions.EXT_shader_texture_lod=l.getExtension("EXT_shader_texture_lod");l.extensions.EXT_sRGB=l.getExtension("EXT_sRGB");l.extensions.EXT_texture_filter_anisotropic=l.getExtension("EXT_texture_filter_anisotropic")||l.getExtension("WEBKIT_EXT_texture_filter_anisotropic")||l.getExtension("MOZ_EXT_texture_filter_anisotropic");l.extensions.EXT_frag_depth=
l.getExtension("EXT_frag_depth")||l.getExtension("WEBKIT_EXT_frag_depth")||l.getExtension("MOZ_EXT_frag_depth");l.extensions.WEBGL_lose_context=l.getExtension("WEBGL_lose_context")||l.getExtension("WEBKIT_WEBGL_lose_context")||l.getExtension("MOZ_WEBGL_lose_context");l.extensions.OES_texture_float_linear=l.getExtension("OES_texture_float_linear");l.extensions.OES_texture_float_linear&&(l.extensions.OES_texture_float=l.getExtension("OES_texture_float"));l.extensions.OES_texture_half_float_linear=l.getExtension("OES_texture_half_float_linear");
l.extensions.OES_texture_half_float_linear&&(l.extensions.OES_texture_half_float=l.getExtension("OES_texture_half_float"));l.HALF_FLOAT_OES=36193;l.extensions.OES_texture_half_float&&(l.HALF_FLOAT_OES=l.extensions.OES_texture_half_float.HALF_FLOAT_OES);l.HIGH_PRECISION_FORMAT=l.extensions.OES_texture_half_float?l.HALF_FLOAT_OES:l.extensions.OES_texture_float?l.FLOAT:l.UNSIGNED_BYTE;l.max_texture_units=l.getParameter(l.MAX_TEXTURE_IMAGE_UNITS);l._viewport_func?console.warn("Creating LiteGL context over the same canvas twice"):
(l._viewport_func=l.viewport,l.viewport_data=new Float32Array([0,0,l.canvas.width,l.canvas.height]),l.viewport=function(a,b,c,d){var f=this.viewport_data;f[0]=a|0;f[1]=b|0;f[2]=c|0;f[3]=d|0;this._viewport_func(a,b,c,d)},l.getViewport=function(a){return a?(a[0]=l.viewport_data[0],a[1]=l.viewport_data[1],a[2]=l.viewport_data[2],a[3]=l.viewport_data[3],a):new Float32Array(l.viewport_data)},l.setViewport=function(a,b){l.viewport_data.set(a);b&&(l.viewport_data[1]=this.drawingBufferHeight-a[1]-a[3]);this._viewport_func(a[0],
l.viewport_data[1],a[2],a[3])});if("undefined"==typeof glMatrix)throw"glMatrix not found, LiteGL requires glMatrix to be included";var x=0;l.shaders={};l.textures={};l.meshes={};l.makeCurrent=function(){m.gl=this};l.execute=function(a){var b=m.gl;m.gl=this;a();m.gl=b};l.animate=function(a){function b(){if(!l.destroyed){f._requestFrame_id=c(b);var a=getTime(),h=0.001*(a-d);if(f.onupdate)f.onupdate(h);v.trigger(l,"update",h);f.ondraw&&(h=m.gl,m.gl=f,f.ondraw(),v.trigger(l,"draw"),m.gl=h);d=a}}if(!1===
a)m.cancelAnimationFrame(this._requestFrame_id),this._requestFrame_id=null;else{var c=m.requestAnimationFrame,d=getTime(),f=this;this._requestFrame_id=c(b)}};l.destroy=function(){R&&(document.removeEventListener("keydown",R),document.removeEventListener("keyup",R));this.canvas.parentNode&&this.canvas.parentNode.removeChild(this.canvas);this.destroyed=!0;m.gl==this&&(m.gl=null)};var u=l.mouse={buttons:0,left_button:!1,middle_button:!1,right_button:!1,position:new Float32Array(2),x:0,y:0,deltax:0,deltay:0,
clientx:0,clienty:0,isInsideRect:function(a,b,c,d,f){var h=this.y;f&&(h=l.canvas.height-h);return this.x>a&&this.x<a+c&&h>b&&h<b+d?!0:!1},isButtonPressed:function(a){return this.buttons&1<<k.RIGHT_MOUSE_BUTTON}};l.captureMouse=function(a,c){f.addEventListener("mousedown",b);f.addEventListener("mousemove",b);a&&(f.addEventListener("mousewheel",b,!1),f.addEventListener("wheel",b,!1));f.addEventListener("contextmenu",function(a){a.preventDefault();return!1});c&&this.captureTouch(!0)};var t=!1;l.captureTouch=
function(a){t=a;f.addEventListener("touchstart",c,!0);f.addEventListener("touchmove",c,!0);f.addEventListener("touchend",c,!0);f.addEventListener("touchcancel",c,!0);f.addEventListener("gesturestart",d);f.addEventListener("gesturechange",d);f.addEventListener("gestureend",d)};l.keys={};var R=null;l.captureKeys=function(a,b){function c(b){var d=a;b.eventType=b.type;var f=b.target.nodeName.toLowerCase();if("input"!==f&&"textarea"!==f&&"select"!==f){b.character=String.fromCharCode(b.keyCode).toLowerCase();
var f=!1,h=k.mapKeyCode(b.keyCode);h||(h=b.character);b.altKey||b.ctrlKey||b.metaKey||(h&&(l.keys[h]="keydown"==b.type),f=l.keys[b.keyCode],l.keys[b.keyCode]="keydown"==b.type);if(f!=l.keys[b.keyCode]){if("keydown"==b.type&&l.onkeydown)l.onkeydown(b);else if("keyup"==b.type&&l.onkeyup)l.onkeyup(b);v.trigger(l,b.type,b)}if(l.onkey)l.onkey(b);d&&(b.isChar||k.blockable_keys[b.keyIdentifier||b.key])&&b.preventDefault()}}R||(l.keys={},document.addEventListener("keydown",c),document.addEventListener("keyup",
c),R=c)};l.gamepads=null;l.captureGamepads=function(){var a=navigator.getGamepads||navigator.webkitGetGamepads||navigator.mozGetGamepads;a&&(this.gamepads=a.call(navigator))};l.getGamepads=function(a){var b=navigator.getGamepads||navigator.webkitGetGamepads||navigator.mozGetGamepads;if(b){b=b.call(navigator);this.gamepads||(this.gamepads=[]);for(var c=0;4>c;c++){var d=b[c];if(d&&!a){var f=d,h={axes:[],buttons:{},hat:""};h.axes.lx=f.axes[0];h.axes.ly=f.axes[1];h.axes.rx=f.axes[2];h.axes.ry=f.axes[3];
h.axes.triggers=f.axes[4];for(var k=0;k<f.buttons.length;k++)switch(k){case 0:h.buttons.a=f.buttons[k].pressed;break;case 1:h.buttons.b=f.buttons[k].pressed;break;case 2:h.buttons.x=f.buttons[k].pressed;break;case 3:h.buttons.y=f.buttons[k].pressed;break;case 4:h.buttons.lb=f.buttons[k].pressed;break;case 5:h.buttons.rb=f.buttons[k].pressed;break;case 6:h.buttons.lt=f.buttons[k].pressed;break;case 7:h.buttons.rt=f.buttons[k].pressed;break;case 8:h.buttons.back=f.buttons[k].pressed;break;case 9:h.buttons.start=
f.buttons[k].pressed;break;case 10:h.buttons.ls=f.buttons[k].pressed;break;case 11:h.buttons.rs=f.buttons[k].pressed;break;case 12:f.buttons[k].pressed&&(h.hat+="up");break;case 13:f.buttons[k].pressed&&(h.hat+="down");break;case 14:f.buttons[k].pressed&&(h.hat+="left");break;case 15:f.buttons[k].pressed&&(h.hat+="right");break;case 16:h.buttons.home=f.buttons[k].pressed}f.xbox=h}f=this.gamepads[c];if(!f&&d){h=new CustomEvent("gamepadconnected");h.eventType=h.type;h.gamepad=d;if(this.ongamepadconnected)this.ongamepadconnected(h);
v.trigger(l,"gamepadconnected",h)}else if(f&&!d){h=new CustomEvent("gamepaddisconnected");h.eventType=h.type;h.gamepad=f;if(this.ongamepaddisconnected)this.ongamepaddisconnected(h);v.trigger(l,"gamepaddisconnected",h)}if(d)for(k=0;k<d.buttons.length;++k){var s=d.buttons[k];if(s.pressed&&(!f||!f.buttons[k].pressed)){h=new CustomEvent("gamepadButtonDown");h.eventType=h.type;h.button=s;h.which=k;h.gamepad=d;if(l.onbuttondown)l.onbuttondown(h);v.trigger(l,"buttondown",h)}else if(!s.pressed&&f&&f.buttons[k].pressed){h=
new CustomEvent("gamepadButtonUp");h.eventType=h.type;h.button=s;h.which=k;h.gamepad=d;if(l.onbuttondown)l.onbuttondown(h);v.trigger(l,"buttonup",h)}}}return this.gamepads=b}};l.fullscreen=function(){var a=this.canvas;a.requestFullScreen?a.requestFullScreen():a.webkitRequestFullScreen?a.webkitRequestFullScreen():a.mozRequestFullScreen?a.mozRequestFullScreen():console.error("Fullscreen not supported")};l.snapshot=function(a,b,c,d,f){var h=createCanvas(c,d),k=h.getContext("2d"),s=k.getImageData(0,0,
h.width,h.height),n=new Uint8Array(c*d*4);l.readPixels(a,b,h.width,h.height,l.RGBA,l.UNSIGNED_BYTE,n);s.data.set(n);k.putImageData(s,0,0);if(f)return h;a=createCanvas(c,d);k=a.getContext("2d");k.translate(0,d);k.scale(1,-1);k.drawImage(h,0,0);return a};var w={};l.loadTexture=function(a,b,c){if(this.textures[a])return this.textures[a];if(w[a])return null;var d=new Image;d.url=a;d.onload=function(){var a=k.Texture.fromImage(this,b);a.img=this;l.textures[this.url]=a;delete w[this.url];c&&c(a)};d.src=
a;w[a]=!0;return null};l.drawTexture=function(){var a=mat3.create(),b=vec2.create(),c=vec2.create(),d=vec4.create(),f=vec4.fromValues(1,1,1,1),h=vec2.create(),k={u_texture:0,u_position:b,u_color:f,u_size:c,u_texture_area:d,u_viewport:h,u_transform:a};return function(a,f,s,n,p,q,r,m,t,x,u){b[0]=f;b[1]=s;void 0===n&&(n=a.width);void 0===p&&(p=a.height);c[0]=n;c[1]=p;void 0===q&&(q=0);void 0===r&&(r=0);void 0===m&&(m=a.width);void 0===t&&(t=a.height);d[0]=q/a.width;d[1]=r/a.height;d[2]=(q+m)/a.width;
d[3]=(r+t)/a.height;h[0]=this.viewport_data[2];h[1]=this.viewport_data[3];x=x||Shader.getPartialQuadShader(this);f=Mesh.getScreenQuad(this);a.bind(0);x.uniforms(k);u&&x.uniforms(u);x.draw(f,l.TRIANGLES)}}();l.canvas.addEventListener("webglcontextlost",function(a){a.preventDefault();l.context_lost=!0;if(l.onlosecontext)l.onlosecontext(a)},!1);l.reset=function(){l.viewport(0,0,this.canvas.width,this.canvas.height);l.disable(l.BLEND);l.disable(l.CULL_FACE);l.disable(l.DEPTH_TEST);l.frontFace(l.CCW);
l._current_texture_drawto=null;l._current_fbo_color=null;l._current_fbo_depth=null};l.dump=function(){console.log("userAgent: ",navigator.userAgent);console.log("Supported extensions:");var a=l.getSupportedExtensions();console.log(a.join(","));a="VENDOR VERSION MAX_VERTEX_ATTRIBS MAX_VARYING_VECTORS MAX_VERTEX_UNIFORM_VECTORS MAX_VERTEX_TEXTURE_IMAGE_UNITS MAX_FRAGMENT_UNIFORM_VECTORS MAX_TEXTURE_SIZE MAX_TEXTURE_IMAGE_UNITS".split(" ");console.log("WebGL info:");for(var b in a)console.log(" * "+
a[b]+": "+l.getParameter(l[a[b]]));console.log("*************************************************")};l.reset();return l};k.mapKeyCode=function(a){return{8:"BACKSPACE",9:"TAB",13:"ENTER",16:"SHIFT",17:"CTRL",27:"ESCAPE",32:"SPACE",37:"LEFT",38:"UP",39:"RIGHT",40:"DOWN"}[a]||(65<=a&&90>=a?String.fromCharCode(a):null)};k.dragging=!1;k.last_pos=[0,0];k.augmentEvent=function(a,b){var c=null;b=b||a.target||gl.canvas;c=b.getBoundingClientRect();a.mousex=a.clientX-c.left;a.mousey=a.clientY-c.top;a.canvasx=
a.mousex;a.canvasy=c.height-a.mousey;a.deltax=0;a.deltay=0;"mousedown"==a.type?(this.dragging=!0,gl.mouse.buttons|=1<<a.which):"mousemove"!=a.type&&"mouseup"==a.type&&(gl.mouse.buttons&=~(1<<a.which),0==gl.mouse.buttons&&(this.dragging=!1));void 0===a.movementX||k.isMobile()?(a.deltax=a.mousex-this.last_pos[0],a.deltay=a.mousey-this.last_pos[1]):(a.deltax=a.movementX,a.deltay=a.movementY);this.last_pos[0]=a.mousex;this.last_pos[1]=a.mousey;a.dragging=this.dragging;a.buttons_mask=gl.mouse.buttons;
a.leftButton=gl.mouse.buttons&1<<k.LEFT_MOUSE_BUTTON;a.middleButton=gl.mouse.buttons&1<<k.MIDDLE_MOUSE_BUTTON;a.rightButton=gl.mouse.buttons&1<<k.RIGHT_MOUSE_BUTTON;a.isButtonPressed=function(a){return this.buttons_mask&1<<a}};k.isMobile=function(){return void 0!==this.mobile?this.mobile:m.navigator?navigator.userAgent.match(/iPhone/i)||navigator.userAgent.match(/iPod/i)||navigator.userAgent.match(/iPad/i)||navigator.userAgent.match(/Android/i)?this.mobile=!0:this.mobile=!1:this.mobile=!1};var v=
m.LEvent=k.LEvent={bind:function(a,b,c,d){if(!a)throw"cannot bind event to null";if(!c)throw"cannot bind to null callback";if(a.constructor===String)throw"cannot bind event to a string";var f=a.__levents;f||(Object.defineProperty(a,"__levents",{value:{},enumerable:!1}),f=a.__levents);f.hasOwnProperty(b)?f[b].push([c,d]):f[b]=[[c,d]];if(a.onLEventBinded)a.onLEventBinded(b,c,d)},unbind:function(a,b,c,d){if(!a)throw"cannot unbind event to null";if(!c)throw"cannot unbind from null callback";if(a.constructor===
String)throw"cannot bind event to a string";var f=a.__levents;if(f&&f.hasOwnProperty(b)){for(var h=0,k=f[b].length;h<k;++h){var l=f[b][h];if(l[0]===c&&l[1]===d){f[b].splice(h,1);break}}0==f[b].length&&delete f[b];if(a.onLEventUnbinded)a.onLEventUnbinded(b,c,d)}},unbindAll:function(a,b,c){if(!a)throw"cannot unbind events in null";var d=a.__levents;if(d){if(a.onLEventUnbindAll)a.onLEventUnbindAll(b,c);if(b)for(var f in d){a=d[f];for(var h=a.length-1;0<=h;--h)a[h][1]!=b||c&&c!==a[h][0]||a.splice(h,1)}else delete a.__levents}},
unbindAllEvent:function(a,b){if(!a)throw"cannot unbind events in null";var c=a.__levents;if(c&&(delete c[b],a.onLEventUnbindAll))a.onLEventUnbindAll(b,target_instance,callback)},isBind:function(a,b,c,d){if(!a)throw"LEvent cannot have null as instance";if(a=a.__levents){if(!a.hasOwnProperty(b))return!1;for(var f=0,h=a[b].length;f<h;++f){var k=a[b][f];if(k[0]===c&&k[1]===d)return!0}return!1}},hasBind:function(a,b){if(!a)throw"LEvent cannot have null as instance";var c=a.__levents;return c&&c.hasOwnProperty(b)&&
c[b].length?!0:!1},hasBindTo:function(a,b){if(!a)throw"LEvent cannot have null as instance";var c=a.__levents;if(!c)return!1;for(var d in c)for(var f=c[d],h=0;h<f.length;++h)if(f[h][1]===b)return!0;return!1},trigger:function(a,b,c,d){if(!a)throw"cannot trigger event from null";if(a.constructor===String)throw"cannot bind event to a string";a=a.__levents;if(!a||!a.hasOwnProperty(b))return!0;a=a[b];if(d)for(d=a.length-1;0<=d;--d){var f=a[d];if(f&&!1==f[0].call(f[1],b,c))return!1}else{d=0;for(var h=a.length;d<
h;++d)if((f=a[d])&&!1==f[0].call(f[1],b,c))return!1}return!0},triggerArray:function(a,b,c,d){for(var f=0,h=a.length;f<h;++f){var k=a[f];if(!k)throw"cannot trigger event from null";if(k.constructor===String)throw"cannot bind event to a string";if((k=k.__levents)&&k.hasOwnProperty(b))if(d)for(var l=k[b].length-1;0<=l;--l){var n=k[b][l];if(!1==n[0].call(n[1],b,c))break}else for(var l=0,p=k[b].length;l<p&&(n=k[b][l],!1!=n[0].call(n[1],b,c));++l);}return!0},extendObject:function(a){a.bind=function(a,c,
d){return v.bind(this,a,c,d)};a.trigger=function(a,c){return v.trigger(this,a,c)};a.unbind=function(a,c,d){return v.unbind(this,a,c,instance)};a.unbindAll=function(a,c){return v.unbindAll(this,a,c)}},extendClass:function(a){this.extendObject(a.prototype)}};m.CLIP_INSIDE=k.CLIP_INSIDE=0;m.CLIP_OUTSIDE=k.CLIP_OUTSIDE=1;m.CLIP_OVERLAP=k.CLIP_OVERLAP=2;m.geo={createPlane:function(a,b){return new Float32Array([b[0],b[1],b[2],-vec3.dot(a,b)])},distancePointToPlane:function(a,b){return(vec3.dot(a,b)+b[3])/
Math.sqrt(b[0]*b[0]+b[1]*b[1]+b[2]*b[2])},distance2PointToPlane:function(a,b){return(vec3.dot(a,b)+b[3])/(b[0]*b[0]+b[1]*b[1]+b[2]*b[2])},projectPointOnLine:function(a,b,c,d){d=d||vec3.create();a=vec3.fromValues(a[0]-b[0],a[1]-b[1],a[2]-b[2]);c=vec3.fromValues(c[0]-b[0],c[1]-b[1],c[2]-b[2]);a=vec3.dot(a,c)/vec3.dot(c,c);d[0]=b[0]+a[0]*c[0];d[1]=b[1]+a[1]*c[1];d[2]=b[2]+a[2]*c[2];return d},project2DPointOnLine:function(a,b,c,d){d=d||vec2.create();a=vec2.fromValues(a[0]-b[0],a[1]-b[1]);c=vec2.fromValues(c[0]-
b[0],c[1]-b[1]);a=vec2.dot(a,c)/vec2.dot(c,c);d[0]=b[0]+a[0]*c[0];d[1]=b[1]+a[1]*c[1];return d},projectPointOnPlane:function(a,b,c,d){d=d||vec3.create();b=vec3.subtract(vec3.create(),a,b);b=vec3.dot(b,c);return vec3.subtract(d,a,vec3.scale(vec3.create(),c,b))},reflectPointInPlane:function(a,b,c){b=-(-1*(b[0]*c[0]+b[1]*c[1]+b[2]*c[2])+c[0]*a[0]+c[1]*a[1]+c[2]*a[2])/(c[0]*c[0]+c[1]*c[1]+c[2]*c[2]);return vec3.fromValues(a[0]+b*c[0]*2,a[1]+b*c[1]*2,a[2]+b*c[2]*2)},testRayPlane:function(a,b,c,d,f){c=
vec3.dot(c,d)-vec3.dot(d,a);d=vec3.dot(d,b);if(Math.abs(d)<EPSILON)return!1;d=c/d;if(0>d)return!1;f&&vec3.add(f,a,vec3.scale(f,b,d));return!0},testSegmentPlane:function(){var a=vec3.create();return function(b,c,d,f,h){d=vec3.dot(d,f)-vec3.dot(f,b);c=vec3.sub(a,c,b);f=vec3.dot(f,c);if(Math.abs(f)<EPSILON)return!1;f=d/f;if(0>f||1<f)return!1;h&&vec3.add(h,b,vec3.scale(h,c,f));return!0}}(),testRaySphere:function(){var a=vec3.create();return function(b,c,d,f,h,k){var l=vec3.subtract(a,b,d),n=c[0]*c[0]+
c[1]*c[1]+c[2]*c[2];d=2*l[0]*c[0]+2*l[1]*c[1]+2*l[2]*c[2];f=d*d-4*n*(l[0]*l[0]+l[1]*l[1]+l[2]*l[2]-f*f);if(0>f)return!1;if(h){f=Math.sqrt(f);l=1/(2*n);n=(-d+f)*l;d=(-d-f)*l;d=n<d?n:d;if(d>k)return!1;vec3.add(h,b,vec3.scale(h,c,d))}return!0}}(),testRayCylinder:function(a,b,c,d,f,h){var k=vec3.clone(a);a=vec3.add(vec3.create(),a,vec3.scale(vec3.create(),b,1E5));var l=0;b=vec3.subtract(vec3.create(),d,c);var n=vec3.subtract(vec3.create(),k,c);c=vec3.subtract(vec3.create(),a,k);d=vec3.dot(n,b);a=vec3.dot(c,
b);b=vec3.dot(b,b);if(0>d&&0>d+a||d>b&&d+a>b)return!1;var p=vec3.dot(c,c),r=vec3.dot(n,c),l=b*p-a*a;f=vec3.dot(n,n)-f*f;var q=b*f-d*d;if(Math.abs(l)<EPSILON){if(0<q)return!1;l=0>d?-r/p:d>b?(a-r)/p:0;h&&vec3.add(h,k,vec3.scale(vec3.create(),c,l));return!0}n=b*r-a*d;q=n*n-l*q;if(0>q)return!1;l=(-n-Math.sqrt(q))/l;if(0>l||1<l)return!1;if(0>d+l*a){if(0>=a)return!1;l=-d/a;h&&vec3.add(h,k,vec3.scale(vec3.create(),c,l));return 0>=f+2*l*(r+l*p)}if(d+l*a>b){if(0<=a)return!1;l=(b-d)/a;h&&vec3.add(h,k,vec3.scale(vec3.create(),
c,l));return 0>=f+b-2*d+l*(2*(r-a)+l*p)}h&&vec3.add(h,k,vec3.scale(vec3.create(),c,l));return!0},testRayBox:function(){var a=new Float32Array(3),b=new Float32Array(3),c=new Float32Array(3);return function(d,f,h,k,l,n){n=n||Number.MAX_VALUE;var p=!0,r=0;a.fill(0);c.fill(0);b.fill(0);for(r=0;3>r;++r)d[r]<h[r]?(a[r]=1,b[r]=h[r],p=!1):d[r]>k[r]?(a[r]=0,b[r]=k[r],p=!1):a[r]=2;if(p)return l&&vec3.copy(l,d),!0;for(r=0;3>r;++r)c[r]=2!=a[r]&&0!=f[r]?(b[r]-d[r])/f[r]:-1;p=0;for(r=1;3>r;r++)c[p]<c[r]&&(p=r);
if(0>c[p]||c[p]>n)return!1;for(r=0;3>r;++r)if(p!=r){n=d[r]+c[p]*f[r];if(n<h[r]||n>k[r])return!1;l&&(l[r]=n)}else l&&(l[r]=b[r]);return!0}}(),testRayBBox:function(){var a=mat4.create(),b=vec3.create(),c=vec3.create();return function(d,f,h,k,l,n,p){if(!d||!f||!h)throw"parameters missing";k&&(mat4.invert(a,k),vec3.add(b,d,f),d=vec3.transformMat4(c,d,a),vec3.transformMat4(b,b,a),vec3.sub(b,b,d),f=vec3.normalize(b,b));d=this.testRayBox(d,f,h.subarray(6,9),h.subarray(9,12),l,n);!p&&k&&l&&vec3.transformMat4(l,
l,k);return d}}(),testPointBBox:function(a,b){return a[0]<b[6]||a[0]>b[9]||a[1]<b[7]||a[0]>b[10]||a[2]<b[8]||a[0]>b[11]?!1:!0},testBBoxBBox:function(a,b){if(Math.abs(b[0]-a[0])>a[3]+b[3]||Math.abs(b[1]-a[1])>a[4]+b[4]||Math.abs(b[2]-a[2])>a[5]+b[5])return!1;var c=BBox.getMin(b);geo.testPointBBox(c,a)&&(c=BBox.getMax(b),geo.testPointBBox(c,a));return!0},testSphereBBox:function(a,b,c){for(var d=0,f=BBox.getMin(c),h=BBox.getMax(c),k=0;3>k;++k)a[k]<f[k]?(c=a[k]-f[k],d+=c*c):a[k]>h[k]&&(c=a[k]-h[k],d+=
c*c);return d<=b*b?!0:!1},closestPointBetweenLines:function(a,b,c,d,f,h){b=vec3.subtract(vec3.create(),b,a);d=vec3.subtract(vec3.create(),d,c);var k=vec3.subtract(vec3.create(),a,c),l=vec3.dot(b,b),n=vec3.dot(b,d),p=vec3.dot(d,d),r=vec3.dot(b,k),q=vec3.dot(d,k),m=l*p-n*n,u;m<EPSILON?(u=0,l=n>p?r/n:q/p):(u=(n*q-p*r)/m,l=(l*q-n*r)/m);f&&vec3.add(f,a,vec3.scale(vec3.create(),b,u));h&&vec3.add(h,c,vec3.scale(vec3.create(),d,l));a=vec3.add(vec3.create(),k,vec3.subtract(vec3.create(),vec3.scale(vec3.create(),
b,u),vec3.scale(vec3.create(),d,l)));return vec3.length(a)},extractPlanes:function(a,b){function c(a){var c=b.subarray(a,a+3),c=vec3.length(c);0!==c&&(c=1/c,b[a]*=c,b[a+1]*=c,b[a+2]*=c,b[a+3]*=c)}b=b||new Float32Array(24);b.set([a[3]-a[0],a[7]-a[4],a[11]-a[8],a[15]-a[12]],0);c(0);b.set([a[3]+a[0],a[7]+a[4],a[11]+a[8],a[15]+a[12]],4);c(4);b.set([a[3]+a[1],a[7]+a[5],a[11]+a[9],a[15]+a[13]],8);c(8);b.set([a[3]-a[1],a[7]-a[5],a[11]-a[9],a[15]-a[13]],12);c(12);b.set([a[3]-a[2],a[7]-a[6],a[11]-a[10],a[15]-
a[14]],16);c(16);b.set([a[3]+a[2],a[7]+a[6],a[11]+a[10],a[15]+a[14]],20);c(20);return b},frustumTestBox:function(a,b){var c=0,d=0,c=planeBoxOverlap(a.subarray(0,4),b);if(c==CLIP_OUTSIDE)return CLIP_OUTSIDE;d+=c;c=planeBoxOverlap(a.subarray(4,8),b);if(c==CLIP_OUTSIDE)return CLIP_OUTSIDE;d+=c;c=planeBoxOverlap(a.subarray(8,12),b);if(c==CLIP_OUTSIDE)return CLIP_OUTSIDE;d+=c;c=planeBoxOverlap(a.subarray(12,16),b);if(c==CLIP_OUTSIDE)return CLIP_OUTSIDE;d+=c;c=planeBoxOverlap(a.subarray(16,20),b);if(c==
CLIP_OUTSIDE)return CLIP_OUTSIDE;d+=c;c=planeBoxOverlap(a.subarray(20,24),b);return c==CLIP_OUTSIDE?CLIP_OUTSIDE:0==d+c?CLIP_INSIDE:CLIP_OVERLAP},frustumTestSphere:function(a,b,c){var d,f=!1;d=distanceToPlane(a.subarray(0,4),b);if(d<-c)return CLIP_OUTSIDE;d>=-c&&d<=c&&(f=!0);d=distanceToPlane(a.subarray(4,8),b);if(d<-c)return CLIP_OUTSIDE;d>=-c&&d<=c&&(f=!0);d=distanceToPlane(a.subarray(8,12),b);if(d<-c)return CLIP_OUTSIDE;d>=-c&&d<=c&&(f=!0);d=distanceToPlane(a.subarray(12,16),b);if(d<-c)return CLIP_OUTSIDE;
d>=-c&&d<=c&&(f=!0);d=distanceToPlane(a.subarray(16,20),b);if(d<-c)return CLIP_OUTSIDE;d>=-c&&d<=c&&(f=!0);d=distanceToPlane(a.subarray(20,24),b);if(d<-c)return CLIP_OUTSIDE;d>=-c&&d<=c&&(f=!0);return f?CLIP_OVERLAP:CLIP_INSIDE},testPoint2DInPolygon:function(a,b){for(var c=!1,d=-1,f=a.length,h=f-1;++d<f;h=d)(a[d][1]<=b[1]&&b[1]<a[h][1]||a[h][1]<=b[1]&&b[1]<a[d][1])&&b[0]<(a[h][0]-a[d][0])*(b[1]-a[d][1])/(a[h][1]-a[d][1])+a[d][0]&&(c=!c);return c}};m.BBox=k.BBox={center:0,halfsize:3,min:6,max:9,radius:12,
data_length:13,corners:new Float32Array([1,1,1,1,1,-1,1,-1,1,1,-1,-1,-1,1,1,-1,1,-1,-1,-1,1,-1,-1,-1]),tmp_corners:new Float32Array(24),create:function(){return new Float32Array(13)},clone:function(a){return new Float32Array(a)},copy:function(a,b){a.set(b);return a},fromPoint:function(a){var b=this.create();b.set(a,0);b.set(a,6);b.set(a,9);return b},fromMinMax:function(a,b){var c=this.create();this.setMinMax(c,a,b);return c},fromCenterHalfsize:function(a,b){var c=this.create();this.setCenterHalfsize(c,
a,b);return c},fromPoints:function(a){var b=this.create();this.setFromPoints(b,a);return b},setFromPoints:function(a,b){var c=a.subarray(6,9),d=a.subarray(9,12);c.set(b.subarray(0,3));d.set(c);for(var f=0,h=3,k=b.length;h<k;h+=3)f=b.subarray(h,h+3),vec3.min(c,f,c),vec3.max(d,f,d);c=vec3.add(a.subarray(0,3),c,d);vec3.scale(c,c,0.5);vec3.subtract(a.subarray(3,6),d,c);a[12]=vec3.length(a.subarray(3,6));return a},setMinMax:function(a,b,c){a[6]=b[0];a[7]=b[1];a[8]=b[2];a[9]=c[0];a[10]=c[1];a[11]=c[2];
var d=a.subarray(3,6);vec3.sub(d,c,b);vec3.scale(d,d,0.5);a[0]=c[0]-d[0];a[1]=c[1]-d[1];a[2]=c[2]-d[2];a[12]=vec3.length(a.subarray(3,6));return a},setCenterHalfsize:function(a,b,c,d){a[0]=b[0];a[1]=b[1];a[2]=b[2];a[3]=c[0];a[4]=c[1];a[5]=c[2];vec3.sub(a.subarray(6,9),a.subarray(0,3),a.subarray(3,6));vec3.add(a.subarray(9,12),a.subarray(0,3),a.subarray(3,6));a[12]=d?d:vec3.length(c);return a},transformMat4:function(a,b,c){var d=b.subarray(3,6),f=this.tmp_corners;f.set(this.corners);for(var h=0;8>
h;++h){var k=f.subarray(3*h,3*h+3);vec3.multiply(k,d,k);vec3.add(k,k,b);mat4.multiplyVec3(k,c,k)}return this.setFromPoints(a,f)},getCorners:function(a,b){var c=a.subarray(3,6),d=null;b?(b.set(this.corners),d=b):d=new Float32Array(this.corners);for(var f=0;8>f;++f){var h=d.subarray(3*f,3*f+3);vec3.multiply(h,c,h);vec3.add(h,h,a)}return d},merge:function(a,b,c){var d=a.subarray(6,9),f=a.subarray(9,12);vec3.min(d,b.subarray(6,9),c.subarray(6,9));vec3.max(f,b.subarray(9,12),c.subarray(9,12));return BBox.setMinMax(a,
d,f)},extendToPoint:function(a,b){b[0]<a[6]?a[6]=b[0]:b[0]>a[9]&&(a[9]=b[0]);b[1]<a[7]?a[7]=b[1]:b[1]>a[10]&&(a[10]=b[1]);b[2]<a[8]?a[8]=b[2]:b[2]>a[11]&&(a[11]=b[2]);var c=a.subarray(6,9),d=a.subarray(9,12),c=vec3.add(a.subarray(0,3),c,d);vec3.scale(c,c,0.5);vec3.subtract(a.subarray(3,6),d,c);a[12]=vec3.length(a.subarray(3,6));return a},getCenter:function(a){return a.subarray(0,3)},getHalfsize:function(a){return a.subarray(3,6)},getMin:function(a){return a.subarray(6,9)},getMax:function(a){return a.subarray(9,
12)},getRadius:function(a){return a[12]}};m.distanceToPlane=k.distanceToPlane=function(a,b){return vec3.dot(a,b)+a[3]};m.planeBoxOverlap=k.planeBoxOverlap=function(a,b){var c=a[3],d=vec3.fromValues(Math.abs(b[3]*a[0]),Math.abs(b[4]*a[1]),Math.abs(b[5]*a[2])),d=d[0]+d[1]+d[2],c=vec3.dot(a,b)+c;return c<=-d?CLIP_OUTSIDE:c<=d?CLIP_OVERLAP:CLIP_INSIDE};m.Octree=k.Octree=function(a){this.root=null;this.total_nodes=this.total_depth=0;a&&(this.buildFromMesh(a),this.total_nodes=this.trim())};Octree.MAX_NODE_TRIANGLES_RATIO=
0.1;Octree.MAX_OCTREE_DEPTH=8;Octree.OCTREE_MARGIN_RATIO=0.01;Octree.OCTREE_MIN_MARGIN=0.1;Octree.prototype.buildFromMesh=function(a){this.total_nodes=this.total_depth=0;var b=a.getBuffer("vertices").data;if(a=a.getIndexBuffer("triangles"))a=a.data;var c=this.computeAABB(b);this.root=c;this.total_nodes=1;this.total_triangles=a?a.length/3:b.length/9;this.max_node_triangles=this.total_triangles*Octree.MAX_NODE_TRIANGLES_RATIO;var d=vec3.create();vec3.scale(d,c.size,Octree.OCTREE_MARGIN_RATIO);d[0]<
Octree.OCTREE_MIN_MARGIN&&(d[0]=Octree.OCTREE_MIN_MARGIN);d[1]<Octree.OCTREE_MIN_MARGIN&&(d[1]=Octree.OCTREE_MIN_MARGIN);d[2]<Octree.OCTREE_MIN_MARGIN&&(d[2]=Octree.OCTREE_MIN_MARGIN);vec3.sub(c.min,c.min,d);vec3.add(c.max,c.max,d);c.faces=[];c.inside=0;if(a)for(d=0;d<a.length;d+=3){var f=new Float32Array([b[3*a[d]],b[3*a[d]+1],b[3*a[d]+2],b[3*a[d+1]],b[3*a[d+1]+1],b[3*a[d+1]+2],b[3*a[d+2]],b[3*a[d+2]+1],b[3*a[d+2]+2]]);this.addToNode(f,c,0)}else for(d=0;d<b.length;d+=9)f=new Float32Array(b.subarray(d,
d+9)),this.addToNode(f,c,0);return c};Octree.prototype.addToNode=function(a,b,c){b.inside+=1;if(b.c){var d=this.computeAABB(a),f=!1,h;for(h in b.c){var k=b.c[h];if(Octree.isInsideAABB(d,k)){this.addToNode(a,k,c+1);f=!0;break}}f||(null==b.faces&&(b.faces=[]),b.faces.push(a))}else if(null==b.faces&&(b.faces=[]),b.faces.push(a),b.faces.length>this.max_node_triangles&&c<Octree.MAX_OCTREE_DEPTH){this.splitNode(b);this.total_depth<c+1&&(this.total_depth=c+1);var l=b.faces.concat();b.faces=null;for(h in l){a=
l[h];var d=this.computeAABB(a),f=!1,n;for(n in b.c)if(k=b.c[n],Octree.isInsideAABB(d,k)){this.addToNode(a,k,c+1);f=!0;break}f||(null==b.faces&&(b.faces=[]),b.faces.push(a))}}};Octree.prototype.octree_pos_ref=[[0,0,0],[0,0,1],[0,1,0],[0,1,1],[1,0,0],[1,0,1],[1,1,0],[1,1,1]];Octree.prototype.splitNode=function(a){a.c=[];var b=[0.5*(a.max[0]-a.min[0]),0.5*(a.max[1]-a.min[1]),0.5*(a.max[2]-a.min[2])],c;for(c in this.octree_pos_ref){var d=this.octree_pos_ref[c],f={};this.total_nodes+=1;f.min=[a.min[0]+
b[0]*d[0],a.min[1]+b[1]*d[1],a.min[2]+b[2]*d[2]];f.max=[f.min[0]+b[0],f.min[1]+b[1],f.min[2]+b[2]];f.faces=null;f.inside=0;a.c.push(f)}};Octree.prototype.computeAABB=function(a){for(var b=new Float32Array([a[0],a[1],a[2]]),c=new Float32Array([a[0],a[1],a[2]]),d=0;d<a.length;d+=3)for(var f=0;3>f;f++)b[f]>a[d+f]&&(b[f]=a[d+f]),c[f]<a[d+f]&&(c[f]=a[d+f]);return{min:b,max:c,size:vec3.sub(vec3.create(),c,b)}};Octree.prototype.trim=function(a){a=a||this.root;if(!a.c)return 1;for(var b=1,c=[],d=a.c,f=0;f<
d.length;++f)d[f].inside&&(c.push(d[f]),b+=this.trim(d[f]));a.c=c;return b};Octree.prototype.testRay=function(){var a=vec3.create(),b=vec3.create(),c=vec3.create(),d=vec3.create();return function(f,h,k,l){if(!this.root)throw"Error: octree not build";a.set(f);b.set(h);c.set(this.root.min);d.set(this.root.max);k=Octree.hitTestBox(a,b,c,d);if(!k)return null;k=Octree.testRayInNode(this.root,a,b);return null!=k?(h=vec3.scale(vec3.create(),h,k.t),vec3.add(h,h,f),k.pos=h,k):null}}();Octree.prototype.testSphere=
function(a,b){a=vec3.clone(a);if(!this.root)throw"Error: octree not build";var c=b*b;return Octree.testSphereBox(a,c,vec3.clone(this.root.min),vec3.clone(this.root.max))?Octree.testSphereInNode(this.root,a,c):!1};Octree.testRayInNode=function(a,b,c){var d=null,f=null;if(a.faces)for(var h=0,k=a.faces.length;h<k;++h){var l=a.faces[h],d=Octree.hitTestTriangle(b,c,l.subarray(0,3),l.subarray(3,6),l.subarray(6,9));null!=d&&(d.face=l,f?f.mergeWith(d):f=d)}var k=vec3.create(),l=vec3.create(),n;if(a.c)for(h=
0;h<a.c.length;++h)n=a.c[h],k.set(n.min),l.set(n.max),d=Octree.hitTestBox(b,c,k,l),null==d||f&&d.t>f.t||(d=Octree.testRayInNode(n,b,c),null!=d&&(f?f.mergeWith(d):f=d));return f};Octree.testSphereInNode=function(a,b,c){if(a.faces)for(var d=0,f=a.faces.length;d<f;++d){var h=a.faces[d];if(Octree.testSphereTriangle(b,c,h.subarray(0,3),h.subarray(3,6),h.subarray(6,9)))return!0}var f=vec3.create(),h=vec3.create(),k;if(a.c)for(d=0;d<a.c.length;++d)if(k=a.c[d],f.set(k.min),h.set(k.max),Octree.testSphereBox(b,
c,f,h)&&Octree.testSphereInNode(k,b,c))return!0;return!1};Octree.isInsideAABB=function(a,b){return a.min[0]<b.min[0]||a.min[1]<b.min[1]||a.min[2]<b.min[2]||a.max[0]>b.max[0]||a.max[1]>b.max[1]||a.max[2]>b.max[2]?!1:!0};Octree.hitTestBox=function(){var a=vec3.create(),b=vec3.create(),c=vec3.create(),d=vec3.create(),f=vec3.create(),h=vec3.create(),k=vec3.fromValues(1E-6,1E-6,1E-6);return function(l,n,p,r){vec3.subtract(a,p,l);vec3.subtract(b,r,l);if(0>vec3.maxValue(a)&&0<vec3.minValue(b))return new HitTest(0,
l,n);c[0]=1/n[0];c[1]=1/n[1];c[2]=1/n[2];vec3.multiply(a,a,c);vec3.multiply(b,b,c);vec3.min(d,a,b);vec3.max(f,a,b);var q=vec3.maxValue(d),m=vec3.minValue(f);return 0<q&&q<m?(l=vec3.add(vec3.create(),vec3.scale(h,n,q),l),vec3.add(p,p,k),vec3.subtract(p,p,k),new HitTest(q,l,vec3.fromValues((l[0]>r[0])-(l[0]<p[0]),(l[1]>r[1])-(l[1]<p[1]),(l[2]>r[2])-(l[2]<p[2])))):null}}();Octree.hitTestTriangle=function(){var a=vec3.create(),b=vec3.create(),c=vec3.create(),d=vec3.create();return function(f,h,k,l,n){vec3.subtract(a,
l,k);vec3.subtract(b,n,k);l=vec3.cross(vec3.create(),a,b);vec3.normalize(l,l);if(0<vec3.dot(l,h))return null;n=vec3.dot(l,vec3.subtract(d,k,f))/vec3.dot(l,h);if(0<n){h=vec3.scale(vec3.create(),h,n);vec3.add(h,h,f);vec3.subtract(c,h,k);f=vec3.dot(b,b);k=vec3.dot(b,a);var p=vec3.dot(b,c),r=vec3.dot(a,a),q=vec3.dot(a,c),m=f*r-k*k,r=(r*p-k*q)/m;f=(f*q-k*p)/m;if(0<=r&&0<=f&&1>=r+f)return new HitTest(n,h,l)}return null}}();Octree.testSphereTriangle=function(){var a=vec3.create(),b=vec3.create(),c=vec3.create(),
d=vec3.create(),f=vec3.create(),h=vec3.create(),k=vec3.create(),l=vec3.create();return function(n,p,r,q,m){vec3.sub(a,r,n);vec3.sub(b,q,n);vec3.sub(c,m,n);vec3.sub(d,b,a);vec3.sub(f,c,a);vec3.cross(l,d,f);n=vec3.dot(a,l);r=vec3.dot(l,l);n=n*n>p*r;var u=vec3.dot(a,a),t=vec3.dot(a,b),v=vec3.dot(a,c),w=vec3.dot(b,b),y=vec3.dot(b,c),z=vec3.dot(c,c);r=u>p&t>u&v>u;q=w>p&t>w&y>w;m=z>p&v>z&y>z;var u=t-u,t=y-w,G=v-z;vec3.sub(h,c,b);vec3.sub(k,a,c);w=vec3.dot(d,d);z=vec3.dot(h,h);v=vec3.dot(k,k);y=vec3.scale(vec3.create(),
a,w);vec3.sub(y,y,vec3.scale(vec3.create(),d,u));u=vec3.scale(vec3.create(),b,z);vec3.sub(u,u,vec3.scale(vec3.create(),h,t));t=vec3.scale(vec3.create(),c,v);vec3.sub(t,t,vec3.scale(vec3.create(),k,G));var F=vec3.scale(vec3.create(),c,w),F=vec3.sub(F,F,y),I=vec3.scale(vec3.create(),a,z),I=vec3.sub(I,I,u),G=vec3.scale(vec3.create(),b,v),G=vec3.sub(G,G,t),w=vec3.dot(y,y)>p*w*w&0<vec3.dot(y,F),z=vec3.dot(u,u)>p*z*z&0<vec3.dot(u,I);p=vec3.dot(t,t)>p*v*v&0<vec3.dot(t,G);return!(n|r|q|m|w|z|p)}}();Octree.testSphereBox=
function(a,b,c,d){for(var f,h=0,k=0;3>k;++k)a[k]<c[k]?(f=a[k]-c[k],h+=f*f):a[k]>d[k]&&(f=a[k]-d[k],h+=f*f);return h<=b?!0:!1};m.HitTest=k.HitTest=function(a,b,c){this.t=arguments.length?a:Number.MAX_VALUE;this.hit=b;this.normal=c;this.face=null};HitTest.prototype={mergeWith:function(a){0<a.t&&a.t<this.t&&(this.t=a.t,this.hit=a.hit,this.normal=a.normal,this.face=a.face)}};m.Raytracer=k.Raytracer=function(a,b){this.viewport=vec4.create();this.ray00=vec3.create();this.ray10=vec3.create();this.ray01=
vec3.create();this.ray11=vec3.create();this.eye=vec3.create();this.setup(a,b)};Raytracer.prototype.setup=function(a,b){b=b||gl.viewport_data;this.viewport.set(b);var c=b[0],d=c+b[2],f=b[1],h=f+b[3];vec3.set(this.ray00,c,f,1);vec3.set(this.ray10,d,f,1);vec3.set(this.ray01,c,h,1);vec3.set(this.ray11,d,h,1);vec3.unproject(this.ray00,this.ray00,a,b);vec3.unproject(this.ray10,this.ray10,a,b);vec3.unproject(this.ray01,this.ray01,a,b);vec3.unproject(this.ray11,this.ray11,a,b);c=this.eye;vec3.unproject(c,
c,a,b);vec3.subtract(this.ray00,this.ray00,c);vec3.subtract(this.ray10,this.ray10,c);vec3.subtract(this.ray01,this.ray01,c);vec3.subtract(this.ray11,this.ray11,c)};Raytracer.prototype.getRayForPixel=function(){var a=vec3.create(),b=vec3.create();return function(c,d,f){f=f||vec3.create();c=(c-this.viewport[0])/this.viewport[2];d=1-(d-this.viewport[1])/this.viewport[3];vec3.lerp(a,this.ray00,this.ray10,c);vec3.lerp(b,this.ray01,this.ray11,c);vec3.lerp(f,a,b,d);return vec3.normalize(f,f)}}();var Y=mat4.create();
Raytracer.hitTestBox=function(a,b,c,d,f){var h=new Float32Array(30);f&&(f=mat4.invert(Y,f),a=mat4.multiplyVec3(h.subarray(3,6),f,a),b=mat4.rotateVec3(h.subarray(6,9),f,b));var k=vec3.subtract(h.subarray(9,12),c,a);vec3.divide(k,k,b);var l=vec3.subtract(h.subarray(12,15),d,a);vec3.divide(l,l,b);f=vec3.min(h.subarray(15,18),k,l);k=vec3.max(h.subarray(18,21),k,l);f=vec3.maxValue(f);k=vec3.minValue(k);return 0<f&&f<=k?(b=vec3.scale(h.subarray(21,24),b,f),vec3.add(b,a,b),vec3.addValue(h.subarray(24,27),
c,1E-6),vec3.subValue(h.subarray(27,30),d,1E-6),new HitTest(f,b,vec3.fromValues((b[0]>d[0])-(b[0]<c[0]),(b[1]>d[1])-(b[1]<c[1]),(b[2]>d[2])-(b[2]<c[2])))):null};Raytracer.hitTestSphere=function(a,b,c,d){var f=vec3.subtract(vec3.create(),a,c),h=vec3.dot(b,b),k=2*vec3.dot(b,f),f=vec3.dot(f,f)-d*d,f=k*k-4*h*f;return 0<f?(h=(-k-Math.sqrt(f))/(2*h),a=vec3.add(vec3.create(),a,vec3.scale(vec3.create(),b,h)),new HitTest(h,a,vec3.scale(vec3.create(),vec3.subtract(vec3.create(),a,c),1/d))):null};Raytracer.hitTestTriangle=
function(a,b,c,d,f){var h=vec3.subtract(vec3.create(),d,c),k=vec3.subtract(vec3.create(),f,c);f=vec3.cross(vec3.create(),h,k);vec3.normalize(f,f);d=vec3.dot(f,vec3.subtract(vec3.create(),c,a))/vec3.dot(f,b);if(0<d){a=vec3.add(vec3.create(),a,vec3.scale(vec3.create(),b,d));var l=vec3.subtract(vec3.create(),a,c);c=vec3.dot(k,k);b=vec3.dot(k,h);var k=vec3.dot(k,l),n=vec3.dot(h,h),h=vec3.dot(h,l),l=c*n-b*b,n=(n*k-b*h)/l,h=(c*h-b*k)/l;if(0<=n&&0<=h&&1>=n+h)return new HitTest(d,a,f)}return null};Mesh.parseOBJ=
function(a,b){b=b||{};for(var c=[],d=[],f=[],h=[],k=[],l=[],n=[],p={},r=0,q=null,m=null,u=0,t=0,v=0,w=m=0,y=0,z=null,G=!1,F=!1,I=!1,N=!1,O=0,P=b.noindex?b.noindex:1E7<a.length?!0:!1,H=b.flipAxis,K=H||b.flipNormals,A=null,C=[],E={v:1,vt:2,vn:3,f:4,g:5,o:6},D=a.split("\n"),Q=D.length,J=0;J<Q;++J)if(q=D[J].replace(/[ \t]+/g," ").replace(/\s\s*$/,""),"#"!=q[0]&&""!=q){var z=q.split(" "),B=E[z[0]];N&&1==B&&(N=!1);3>=B&&(m=parseFloat(z[1]),w=parseFloat(z[2]),2!=B&&("\\"==z[3]?(++J,q=D[J].replace(/[ \t]+/g,
" ").replace(/\s\s*$/,""),y=parseFloat(q)):y=parseFloat(z[3])));if(1==B)H?k.push(-1*m,y,w):k.push(m,w,y);else if(2==B)l.push(m,w);else if(3==B)K?n.push(-w,-y,m):n.push(m,w,y);else if(4==B){if(N=!0,!(4>z.length)){B=[];for(q=1;q<z.length;++q){if(!(z[q]in p)||P){m=z[q].split("/");if(1==m.length)v=t=u=parseInt(m[0])-1;else if(2==m.length)u=parseInt(m[0])-1,t=parseInt(m[1])-1,v=-1;else if(3==m.length)u=parseInt(m[0])-1,t=parseInt(m[1])-1,v=parseInt(m[2])-1;else return console.err("Problem parsing: unknown number of values per face"),
!1;3<q&&P&&(m=c.length,c.push(c[m-9*(q-3)],c[m-9*(q-3)+1],c[m-9*(q-3)+2]),c.push(c[m-3],c[m-2],c[m-1]),m=d.length,d.push(d[m-6*(q-3)],d[m-6*(q-3)+1]),d.push(d[m-2],d[m-1]),m=f.length,f.push(f[m-9*(q-3)],f[m-9*(q-3)+1],f[m-9*(q-3)+2]),f.push(f[m-3],f[m-2],f[m-1]));y=w=m=0;3*u+2<k.length&&(G=!0,m=k[3*u+0],w=k[3*u+1],y=k[3*u+2]);c.push(m,w,y);w=m=0;2*t+1<l.length&&(F=!0,m=l[2*t+0],w=l[2*t+1]);d.push(m,w);w=m=0;y=1;-1!=v&&(3*v+2<n.length&&(I=!0,m=n[3*v+0],w=n[3*v+1],y=n[3*v+2]),f.push(m,w,y));P||(p[z[q]]=
r++)}P||(u=p[z[q]],B.push(u),O<u&&(O=u))}if(!P)for(q=2;q<B.length;q++)h.push(B[0],B[q-1],B[q])}}else 5==B||"usemtl"==z[0]?1<z.length&&(null!=A&&(A.length=h.length-A.start,0<A.length&&C.push(A)),A={name:z[1],start:h.length,length:-1,material:""}):"usemtl"==z[0]&&A&&(A.material=z[1])}if(!k.length)return console.error("OBJ doesnt have vertices, maybe the file is not a OBJ"),null;A&&1<h.length-A.start&&(A.length=h.length-A.start,C.push(A));if((65536<O||P)&&0<h.length){console.log("Deindexing mesh...");
k=new Float32Array(3*h.length);l=f&&f.length?new Float32Array(3*h.length):null;n=d&&d.length?new Float32Array(2*h.length):null;for(q=0;q<h.length;q+=1)k.set(c.slice(3*h[q],3*h[q]+3),3*q),l&&l.set(f.slice(3*h[q],3*h[q]+3),3*q),n&&n.set(d.slice(2*h[q],2*h[q]+2),2*q);c=k;l&&(f=l);n&&(d=n);h=null}k={};G&&(k.vertices=new Float32Array(c));I&&0<f.length&&(k.normals=new Float32Array(f));F&&0<d.length&&(k.coords=new Float32Array(d));h&&0<h.length&&(k.triangles=new Uint16Array(h));c={};1<C.length&&(c.groups=
C);k.info=c;C=null;C=Mesh.load(k,null,b.mesh);C.updateBounding();return C};Mesh.parsers.obj=Mesh.parseOBJ.bind(Mesh);Mesh.encoders.obj=function(a,b){var c=a.getBuffer("vertices");if(!c)return null;for(var d="# Generated with liteGL.js by Javi Agenjo\n\n",c=c.data,f=0;f<c.length;f+=3)d+="v "+c[f].toFixed(4)+" "+c[f+1].toFixed(4)+" "+c[f+2].toFixed(4)+"\n";if(f=a.getBuffer("normals"))for(var d=d+"\n",h=f.data,f=0;f<h.length;f+=3)d+="vn "+h[f].toFixed(4)+" "+h[f+1].toFixed(4)+" "+h[f+2].toFixed(4)+"\n";
if(f=a.getBuffer("coords"))for(d+="\n",h=f.data,f=0;f<h.length;f+=2)d+="vt "+h[f].toFixed(4)+" "+h[f+1].toFixed(4)+"  0.0000\n";d+="\ng mesh\n";if(f=a.getIndexBuffer("triangles"))for(c=f.data,f=0;f<c.length;f+=3)d+="f "+(c[f]+1)+"/"+(c[f]+1)+"/"+(c[f]+1)+" "+(c[f+1]+1)+"/"+(c[f+1]+1)+"/"+(c[f+1]+1)+" "+(c[f+2]+1)+"/"+(c[f+2]+1)+"/"+(c[f+2]+1)+"\n";else for(f=0;f<c.length/3;f+=3)d+="f "+(f+1)+"/"+(f+1)+"/"+(f+1)+" "+(f+2)+"/"+(f+2)+"/"+(f+2)+" "+(f+3)+"/"+(f+3)+"/"+(f+3)+"\n";return d}})("undefined"!=
typeof window?window:"undefined"!=typeof self?self:global);
